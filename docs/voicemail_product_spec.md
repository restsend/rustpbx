# RustPBX Voicemail Pro äº§å“æ–¹æ¡ˆ

**ç‰ˆæœ¬**ï¼šv1.0  
**æ—¥æœŸ**ï¼š2026-01-26  
**çŠ¶æ€**ï¼šè®¾è®¡é˜¶æ®µ

---

## ğŸ“‹ äº§å“æ¦‚è¿°

### äº§å“å®šä½
ä¼ä¸šçº§æ™ºèƒ½è¯­éŸ³ä¿¡ç®±ç³»ç»Ÿï¼Œä¸º RustPBX ç”¨æˆ·æä¾›ä¸“ä¸šçš„ç•™è¨€ç®¡ç†ã€æ™ºèƒ½è½¬å†™ã€å¤šæ¸ é“é€šçŸ¥ç­‰åŠŸèƒ½ã€‚

### ç›®æ ‡ç”¨æˆ·
- **å°å‹ä¼ä¸š**ï¼ˆ<50äººï¼‰ï¼šéœ€è¦åŸºç¡€è¯­éŸ³ç•™è¨€åŠŸèƒ½
- **ä¸­å‹ä¼ä¸š**ï¼ˆ50-200äººï¼‰ï¼šéœ€è¦å¯è§†åŒ–ç•™è¨€ã€é‚®ä»¶é›†æˆ
- **å¤§å‹ä¼ä¸š**ï¼ˆ200+äººï¼‰ï¼šéœ€è¦é…é¢ç®¡ç†ã€æ‰¹é‡æ“ä½œã€å®¡è®¡

### æ ¸å¿ƒä»·å€¼ä¸»å¼ 
1. **é›¶é”™è¿‡**ï¼šæ‰€æœ‰æœªæ¥æ¥ç”µè‡ªåŠ¨è½¬è¯­éŸ³ä¿¡ç®±
2. **æ™ºèƒ½è½¬å†™**ï¼šè¯­éŸ³è‡ªåŠ¨è½¬æ–‡å­—ï¼Œæ”¯æŒæœç´¢å’Œæ‘˜è¦
3. **å¤šæ¸ é“é€šçŸ¥**ï¼šé‚®ä»¶ã€çŸ­ä¿¡ã€Webã€ç§»åŠ¨ç«¯å®æ—¶é€šçŸ¥
4. **ä¼ä¸šçº§ç®¡ç†**ï¼šé…é¢æ§åˆ¶ã€æƒé™ç®¡ç†ã€å®¡è®¡æ—¥å¿—

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. åŸºç¡€ç•™è¨€åŠŸèƒ½

#### 1.1 å½•åˆ¶ç•™è¨€
```
ç”¨æˆ·æ‹¨æ‰“åˆ†æœº 1001ï¼ˆæ— äººåº”ç­” 30 ç§’ï¼‰
  â†“
è‡ªåŠ¨è½¬æ¥åˆ°è¯­éŸ³ä¿¡ç®±
  â†“
æ’­æ”¾æ¬¢è¿è¯­ï¼š"æ‚¨å¥½ï¼Œæ‚¨æ‹¨æ‰“çš„ç”¨æˆ·æš‚æ—¶æ— æ³•æ¥å¬ï¼Œè¯·åœ¨æç¤ºéŸ³åç•™è¨€"
  â†“
æç¤ºéŸ³ï¼ˆå˜Ÿï¼‰
  â†“
å¼€å§‹å½•éŸ³ï¼ˆæœ€é•¿ 5 åˆ†é’Ÿï¼‰
  â†“
ç”¨æˆ·æŒ‰ # ç»“æŸå½•éŸ³ï¼ˆæˆ–è‡ªåŠ¨ç»“æŸï¼‰
  â†“
"æ‚¨çš„ç•™è¨€å·²ä¿å­˜ï¼Œå†è§"
```

**é…ç½®å‚æ•°**ï¼š
- æœ€å¤§å½•éŸ³æ—¶é•¿ï¼š30ç§’ ~ 10åˆ†é’Ÿï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰
- æ¬¢è¿è¯­ï¼šç³»ç»Ÿé»˜è®¤ / ç”¨æˆ·è‡ªå®šä¹‰
- ç»“æŸé”®ï¼š# æˆ– * ï¼ˆå¯é…ç½®ï¼‰
- æ— å£°æ£€æµ‹ï¼š3ç§’æ— å£°è‡ªåŠ¨ç»“æŸ

#### 1.2 æŸ¥è¯¢ç•™è¨€
```
ç”¨æˆ·æ‹¨æ‰“ *97ï¼ˆè¯­éŸ³ä¿¡ç®±å¿«æ·ç ï¼‰
  â†“
éªŒè¯èº«ä»½ï¼ˆåˆ†æœºå¯†ç  / PINï¼‰
  â†“
æ’­æ”¾ç•™è¨€æ•°é‡ï¼š"æ‚¨æœ‰ 3 æ¡æ–°ç•™è¨€"
  â†“
æ’­æ”¾ç•™è¨€ï¼š
  - ç•™è¨€ 1ï¼šæ¥è‡ª 13800138000ï¼Œä»Šå¤©ä¸Šåˆ 10:23
  - [æ’­æ”¾ç•™è¨€å†…å®¹]
  - æ“ä½œæç¤ºï¼š
    * æŒ‰ 1 é‡æ’­
    * æŒ‰ 2 ä¿å­˜
    * æŒ‰ 3 åˆ é™¤
    * æŒ‰ 4 å›æ‹¨
    * æŒ‰ # ä¸‹ä¸€æ¡
```

**åŠŸèƒ½æ¸…å•**ï¼š
- [x] æ’­æ”¾æ–°ç•™è¨€
- [x] æ’­æ”¾å·²è¯»ç•™è¨€
- [x] åˆ é™¤ç•™è¨€
- [x] ä¿å­˜ç•™è¨€ï¼ˆæ°¸ä¹…ä¿ç•™ï¼‰
- [x] å›æ‹¨åŠŸèƒ½ï¼ˆè‡ªåŠ¨æ‹¨æ‰“ç•™è¨€è€…å·ç ï¼‰
- [x] è½¬å‘ç•™è¨€ï¼ˆè½¬å‘ç»™å…¶ä»–åˆ†æœºï¼‰

---

### 2. æ™ºèƒ½è½¬å†™ï¼ˆAI å¢å¼ºï¼‰

#### 2.1 è¯­éŸ³è½¬æ–‡å­—
- **å¼•æ“**ï¼šSenseVoiceï¼ˆå·²é›†æˆï¼‰
- **è¯­è¨€**ï¼šä¸­æ–‡ã€è‹±æ–‡ã€ä¸­è‹±æ··åˆ
- **å‡†ç¡®ç‡**ï¼š>95%ï¼ˆæ ‡å‡†æ™®é€šè¯ï¼‰
- **é€Ÿåº¦**ï¼šå®æ—¶è½¬å†™ï¼ˆ<1ç§’å»¶è¿Ÿï¼‰

#### 2.2 æ™ºèƒ½æ‘˜è¦
```python
åŸå§‹ç•™è¨€ï¼ˆ45ç§’ï¼‰ï¼š
"ä½ å¥½å•Šï¼Œæˆ‘æ˜¯å¼ ä¸‰ï¼Œä»Šå¤©ä¸‹åˆæƒ³è·Ÿä½ èŠä¸€ä¸‹é‚£ä¸ªé¡¹ç›®çš„äº‹æƒ…ï¼Œ
å¤§æ¦‚ä¸‰ç‚¹åˆ°å››ç‚¹ä¹‹é—´æœ‰ç©ºå—ï¼Ÿå¦‚æœæ–¹ä¾¿çš„è¯ç»™æˆ‘å›ä¸ªç”µè¯ï¼Œ
æˆ‘çš„æ‰‹æœºå·æ˜¯ 138-0013-8000ï¼Œè°¢è°¢ã€‚"

AI æ‘˜è¦ï¼š
ğŸ“ æ¥ç”µäººï¼šå¼ ä¸‰
â° æ—¶é—´ï¼šä»Šå¤©ä¸‹åˆ 3-4 ç‚¹
ğŸ“‹ äº‹ç”±ï¼šé¡¹ç›®è®¨è®º
ğŸ“± å›ç”µï¼š138-0013-8000
```

#### 2.3 å…³é”®è¯æå–
- è‡ªåŠ¨æå–ï¼šäººåã€ç”µè¯å·ç ã€æ—¶é—´ã€åœ°ç‚¹
- æƒ…ç»ªåˆ†æï¼šç´§æ€¥ã€æ™®é€šã€ä¸æ»¡
- æ„å›¾è¯†åˆ«ï¼šå’¨è¯¢ã€æŠ•è¯‰ã€é¢„çº¦ã€æ¨é”€

---

### 3. å¤šæ¸ é“é€šçŸ¥

#### 3.1 é‚®ä»¶é€šçŸ¥
```
ä¸»é¢˜ï¼š[è¯­éŸ³ç•™è¨€] æ¥è‡ª 13800138000 çš„æ–°ç•™è¨€

æ­£æ–‡ï¼š
æ‚¨å¥½ï¼Œ

æ‚¨æœ‰ä¸€æ¡æ¥è‡ª 13800138000 çš„æ–°ç•™è¨€ï¼š

æ¥ç”µæ—¶é—´ï¼š2026-01-26 10:23:15
ç•™è¨€æ—¶é•¿ï¼š42 ç§’
ç•™è¨€å†…å®¹ï¼ˆè½¬å†™ï¼‰ï¼š
"ä½ å¥½å•Šï¼Œæˆ‘æ˜¯å¼ ä¸‰ï¼Œä»Šå¤©ä¸‹åˆæƒ³è·Ÿä½ èŠä¸€ä¸‹é‚£ä¸ªé¡¹ç›®çš„äº‹æƒ…..."

é™„ä»¶ï¼š
- voicemail_20260126_102315.wavï¼ˆéŸ³é¢‘æ–‡ä»¶ï¼‰
- transcript.txtï¼ˆè½¬å†™æ–‡æœ¬ï¼‰

åœ¨çº¿ç®¡ç†ï¼šhttps://pbx.example.com/voicemail

---
RustPBX Voicemail Pro
```

**é…ç½®é¡¹**ï¼š
- é‚®ä»¶æ¨¡æ¿è‡ªå®šä¹‰
- é™„ä»¶æ ¼å¼ï¼šWAV / MP3 / Opus
- å‘é€æ—¶æœºï¼šå³æ—¶ / æ‰¹é‡ï¼ˆæ¯å°æ—¶æ±‡æ€»ï¼‰
- è¯­è¨€ï¼šä¸­æ–‡ / è‹±æ–‡

#### 3.2 SMS çŸ­ä¿¡é€šçŸ¥
```
ã€è¯­éŸ³ç•™è¨€ã€‘æ‚¨æœ‰1æ¡æ–°ç•™è¨€ï¼Œæ¥è‡ª13800138000ï¼Œ
æ—¶é•¿42ç§’ã€‚ç‚¹å‡»æŸ¥çœ‹ï¼šhttps://pbx.example.com/vm/abc123
```

**é›†æˆæ–¹æ¡ˆ**ï¼š
- å›½é™…ï¼šTwilio
- å›½å†…ï¼šé˜¿é‡Œäº‘çŸ­ä¿¡ã€è…¾è®¯äº‘çŸ­ä¿¡

#### 3.3 MWIï¼ˆæ¶ˆæ¯ç­‰å¾…æŒ‡ç¤ºå™¨ï¼‰
```
SIP è¯æœºæ˜¾ç¤ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’Œ 3 Messages  â”‚  â† çº¢ç¯é—ªçƒ
â”‚  1001           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°**ï¼š
- SIP NOTIFY æ¶ˆæ¯
- ç¬¦åˆ RFC 3842ï¼ˆMessage Summary Eventï¼‰
- æ”¯æŒä¸»æµ SIP è¯æœºï¼ˆYealinkã€Ciscoã€Grandstreamï¼‰

#### 3.4 Web å®æ—¶æ¨é€
```javascript
// WebSocket å®æ—¶é€šçŸ¥
{
  "type": "NEW_VOICEMAIL",
  "extension": "1001",
  "caller": "13800138000",
  "duration": 42,
  "timestamp": "2026-01-26T10:23:15Z",
  "transcript": "ä½ å¥½å•Šï¼Œæˆ‘æ˜¯å¼ ä¸‰...",
  "audio_url": "/api/voicemail/abc123/audio"
}
```

---

### 4. Web ç®¡ç†ç•Œé¢

#### 4.0 åˆ†æœºèº«ä»½è®¤è¯

> **æ¶æ„è¯´æ˜**ï¼šVoicemail Pro **å¤ç”¨å…¨å±€ Enterprise Auth æ’ä»¶**æä¾›çš„è®¤è¯æœåŠ¡ã€‚  
> Enterprise Auth æ˜¯ç‹¬ç«‹çš„å•†ä¸šæ’ä»¶ï¼ˆ$299-$799/å¹´ï¼‰ï¼Œæä¾›ç»Ÿä¸€è®¤è¯å±‚ä¾›æ‰€æœ‰æ¨¡å—ä½¿ç”¨ã€‚

**è®¿é—®å…¥å£**ï¼š
- URL: `https://pbx.example.com/voicemail/login`
- å¤šç§Ÿæˆ·æ”¯æŒï¼š`https://tenant1.pbx.example.com/voicemail`

**è®¤è¯æ–¹å¼**ï¼ˆç”± Enterprise Auth æ’ä»¶æä¾›ï¼‰ï¼š

```rust
// å¤ç”¨å…¨å±€è®¤è¯æœåŠ¡
use rustpbx_auth::{AuthService, AuthMethod, User};

// Voicemail åªéœ€è°ƒç”¨ç»Ÿä¸€è®¤è¯æ¥å£
pub struct VoicemailWebService {
    auth: Arc<AuthService>,  // æ³¨å…¥å…¨å±€è®¤è¯æœåŠ¡
}

impl VoicemailWebService {
    async fn login(&self, method: AuthMethod) -> Result<SessionToken> {
        // è°ƒç”¨å…¨å±€è®¤è¯æœåŠ¡
        let user = self.auth.authenticate(method).await?;
        
        // ç”Ÿæˆ Voicemail ä¸“ç”¨ session token
        let token = self.generate_voicemail_token(&user)?;
        
        Ok(token)
    }
}

// å…¨å±€è®¤è¯æœåŠ¡æ”¯æŒçš„æ–¹å¼ï¼ˆç”± Enterprise Auth æ’ä»¶å®ç°ï¼‰
pub enum AuthMethod {
    // æ–¹å¼1ï¼šåˆ†æœºå· + PINç ï¼ˆå†…ç½®ï¼Œæ— éœ€é¢å¤–æ’ä»¶ï¼‰
    ExtensionPin {
        extension: String,      // åˆ†æœºå· 1001
        pin: String,            // 4-6 ä½æ•°å­— PIN
        tenant_domain: String,  // ç§Ÿæˆ·åŸŸå
    },
    
    // æ–¹å¼2ï¼šSIPå‡­æ®ï¼ˆå†…ç½®ï¼Œå¤ç”¨ç°æœ‰è®¤è¯ï¼‰
    SipCredentials {
        extension: String,
        sip_password: String,
        tenant_domain: String,
    },
    
    // æ–¹å¼3ï¼šLDAP/ADï¼ˆéœ€è¦ Enterprise Auth æ’ä»¶ - åŸºç¡€ç‰ˆï¼‰
    Ldap {
        username: String,
        password: String,
        tenant_domain: String,
    },
    
    // æ–¹å¼4ï¼šSAML SSOï¼ˆéœ€è¦ Enterprise Auth æ’ä»¶ - ä¼ä¸šç‰ˆï¼‰
    SamlToken {
        saml_response: String,
        relay_state: Option<String>,
    },
    
    // æ–¹å¼5ï¼šOAuth/OIDCï¼ˆéœ€è¦ Enterprise Auth æ’ä»¶ - ä¼ä¸šç‰ˆï¼‰
    OAuthCode {
        code: String,
        provider: OAuthProvider,  // Azure, Google, Okta
    },
}

// Voicemail è®¤è¯æµç¨‹ï¼ˆç®€åŒ–ï¼‰
impl VoicemailWebService {
    async fn login_handler(
        auth: Data<AuthService>,  // æ³¨å…¥å…¨å±€è®¤è¯æœåŠ¡
        form: Form<LoginForm>,
    ) -> Result<HttpResponse> {
        // 1. è°ƒç”¨å…¨å±€è®¤è¯ï¼ˆè‡ªåŠ¨æ”¯æŒæ‰€æœ‰è®¤è¯æ–¹å¼ï¼‰
        let user = auth.authenticate(form.into_inner().to_auth_method()).await?;
        
        // 2. ç”Ÿæˆ Voicemail session token
        let token = generate_voicemail_token(&user)?;
        
        // 3. è¿”å›
        Ok(HttpResponse::Ok().json(json!({
            "token": token,
            "extension": user.extension,
            "expires_at": Utc::now() + Duration::hours(24),
        })))
    }
    
    // éªŒè¯tokenï¼ˆä¸­é—´ä»¶ï¼‰
    async fn verify_token_middleware(
        auth: Data<AuthService>,
        req: Request,
    ) -> Result<User> {
        let token = extract_token(&req)?;
        
        // è°ƒç”¨å…¨å±€è®¤è¯æœåŠ¡éªŒè¯
        let user = auth.verify_token(&token).await?;
        
        Ok(user)
    }
}

// æ•°æ®åº“schemaï¼ˆç®€åŒ– - ä¸éœ€è¦å­˜å‚¨å¯†ç ï¼‰
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL,
    extension VARCHAR(20) NOT NULL,
    display_name VARCHAR(100),
    email VARCHAR(255),
    
    -- è®¤è¯æ–¹å¼æ ‡è®°ï¼ˆç”± Enterprise Auth ç®¡ç†ï¼‰
    auth_method VARCHAR(20) DEFAULT 'pin',  -- pin, ldap, saml, oauth
    
    -- Voicemail PINç ï¼ˆå¤‡ç”¨è®¤è¯ï¼Œå†…ç½®æ”¯æŒï¼‰
    voicemail_pin VARCHAR(64),  -- bcrypt hashï¼ˆå¯é€‰ï¼‰
    pin_updated_at TIMESTAMPTZ,
    
    -- ç”¨æˆ·çŠ¶æ€
    status VARCHAR(20) DEFAULT 'active',
    last_login_at TIMESTAMPTZ,
    
    UNIQUE(tenant_id, extension)
);

-- æ³¨æ„ï¼šLDAP/SAML/OAuth çš„ç”¨æˆ·ä¿¡æ¯ç”± Enterprise Auth æ’ä»¶ç®¡ç†
-- Voicemail åªéœ€è¦åŸºæœ¬çš„ user ä¿¡æ¯
CREATE TABLE voicemail_access_logs (
    id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    action VARCHAR(50) NOT NULL,  -- login, view_message, delete_message
    ip_address INET,
    user_agent TEXT,
    status VARCHAR(20) NOT NULL,  -- success, failed
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    INDEX idx_user_time (user_id, created_at),
    INDEX idx_tenant_time (tenant_id, created_at)
);
```

**å®‰å…¨æœºåˆ¶**ï¼š

1. **æƒé™éš”ç¦»**ï¼š
```rust
// ä¸­é—´ä»¶ï¼šç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ç•™è¨€
pub async fn voicemail_auth_middleware(
    auth: Data<AuthService>,  // å…¨å±€è®¤è¯æœåŠ¡
    req: Request,
    next: Next,
) -> Result<Response> {
    // 1. è§£æå¹¶éªŒè¯tokenï¼ˆè°ƒç”¨å…¨å±€è®¤è¯ï¼‰
    let token = extract_token(&req)?;
    let user = auth.verify_token(&token).await?;
    
    // 2. æ³¨å…¥ç”¨æˆ·ä¸Šä¸‹æ–‡
    req.extensions_mut().insert(user);
    
    // 3. ç»§ç»­å¤„ç†
    next.run(req).await
}

// API Handlerï¼šè‡ªåŠ¨è¿‡æ»¤
async fn list_messages(
    auth_user: Extension<User>,  // è‡ªåŠ¨æ³¨å…¥
) -> Result<Json<Vec<Message>>> {
    // SQLè‡ªåŠ¨åŠ ä¸Š user_id è¿‡æ»¤
    let messages = sqlx::query_as!(
        Message,
        r#"
        SELECT * FROM voicemail_messages 
        WHERE user_id = $1 AND deleted_at IS NULL
        ORDER BY created_at DESC
        "#,
        auth_user.id  // åªèƒ½æŸ¥è‡ªå·±çš„
    ).fetch_all(&db).await?;
    
    Ok(Json(messages))
}

// ä¸‹è½½ç•™è¨€éŸ³é¢‘
async fn download_message(
    auth_user: Extension<User>,
    Path(message_id): Path<i64>,
) -> Result<impl IntoResponse> {
    // 1. éªŒè¯ç•™è¨€å±äºå½“å‰ç”¨æˆ·
    let message = sqlx::query_as!(
        Message,
        "SELECT * FROM voicemail_messages WHERE id = $1",
        message_id
    ).fetch_one(&db).await?;
    
    if message.user_id != auth_user.id {
        return Err(Error::Forbidden("Not your message"));
    }
    
    // 2. è¿”å›éŸ³é¢‘æ–‡ä»¶
    let audio = storage.get(&message.file_path).await?;
    Ok((
        StatusCode::OK,
        [("Content-Type", "audio/wav")],
        audio
    ))
}
```

2. **PINç ç®¡ç†**ï¼ˆå¤‡ç”¨è®¤è¯æ–¹å¼ï¼‰ï¼š
```
åˆæ¬¡è®¾ç½®ï¼š
- ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶å¯é€‰è®¾ç½®PINç 
- 4-6ä½æ•°å­—ï¼Œä¸èƒ½æ˜¯é¡ºåºå·ï¼ˆ1234ï¼‰æˆ–é‡å¤å·ï¼ˆ1111ï¼‰
- bcryptåŠ å¯†å­˜å‚¨

ä¿®æ”¹PINï¼š
- éœ€è¦éªŒè¯æ—§PIN
- 30å¤©å†…ä¸èƒ½é‡å¤ä½¿ç”¨

é‡ç½®PINï¼š
- ç®¡ç†å‘˜å¯é‡ç½®ï¼ˆéœ€å®¡è®¡æ—¥å¿—ï¼‰
- é€šè¿‡é‚®ç®±éªŒè¯ç è‡ªåŠ©é‡ç½®

æ³¨æ„ï¼šå¦‚æœå¯ç”¨äº† Enterprise Auth æ’ä»¶çš„ LDAP/SSOï¼ŒPINç å¯ä½œä¸ºå¤‡ç”¨è®¤è¯æ–¹å¼
```

3. **é˜²æš´åŠ›ç ´è§£**ï¼ˆç”± Enterprise Auth æ’ä»¶æä¾›ï¼‰ï¼š
```rust
// å…¨å±€è®¤è¯æœåŠ¡å·²å†…ç½®é˜²æŠ¤
// - ç™»å½•å¤±è´¥5æ¬¡é”å®š15åˆ†é’Ÿ
// - æ¯IPæ¯åˆ†é’Ÿæœ€å¤š10æ¬¡å°è¯•
// - å¼‚å¸¸è¡Œä¸ºè‡ªåŠ¨å‘Šè­¦
```

4. **ä¼šè¯ç®¡ç†**ï¼š
```
- JWT tokenæœ‰æ•ˆæœŸï¼š24å°æ—¶
- æ”¯æŒå¤šè®¾å¤‡åŒæ—¶ç™»å½•ï¼ˆæ¯ä¸ªè®¾å¤‡ç‹¬ç«‹tokenï¼‰
- ä¸»åŠ¨ç™»å‡ºï¼šæ¸…é™¤æœ¬åœ°token
- ç®¡ç†å‘˜å¯å¼ºåˆ¶è¸¢å‡ºç”¨æˆ·
```

**ç™»å½•ç•Œé¢**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ¢ RustPBX è¯­éŸ³ä¿¡ç®±               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚   åˆ†æœºå·ï¼š[1001        ]            â”‚
â”‚   PINç  ï¼š[â€¢â€¢â€¢â€¢        ]            â”‚
â”‚                                     â”‚
â”‚   ç§Ÿæˆ·åŸŸï¼š[tenant1.pbx.example.com] â”‚
â”‚                                     â”‚
â”‚   [ ç™»å½• ]  [å¿˜è®°PIN?]              â”‚
â”‚                                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æˆ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                     â”‚
â”‚   [ ä½¿ç”¨ä¼ä¸šè´¦å·ç™»å½• ]              â”‚
â”‚   (éœ€è¦ Enterprise Auth æ’ä»¶)       â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4.0.1 ä¼ä¸šLDAP/SSOé›†æˆæ–¹æ¡ˆ

#### ä¸€ã€LDAPé›†æˆ

**1. åŠŸèƒ½éœ€æ±‚**ï¼š
- ç”¨æˆ·èº«ä»½éªŒè¯ï¼ˆæ›¿ä»£PINç ï¼‰
- ç”¨æˆ·ä¿¡æ¯åŒæ­¥ï¼ˆå§“åã€é‚®ç®±ã€éƒ¨é—¨ï¼‰
- ç»„ç»‡æ¶æ„æ˜ å°„ï¼ˆéƒ¨é—¨ â†’ ç”¨æˆ·ç»„ï¼‰
- æ”¯æŒå¤šLDAPæœåŠ¡å™¨ï¼ˆActive Directoryã€OpenLDAPï¼‰

**2. ä¾èµ–åº“**ï¼š
```toml
[dependencies]
ldap3 = "0.11"          # LDAPå®¢æˆ·ç«¯
tokio-ldap = "0.4"      # å¼‚æ­¥LDAP
```

**3. é…ç½®æ–‡ä»¶**ï¼ˆ`config.toml`ï¼‰ï¼š
```toml
[ldap]
enabled = true
server = "ldap://ad.company.com:389"
# æˆ– LDAPS: "ldaps://ad.company.com:636"

# ç»‘å®šè´¦å·ï¼ˆç”¨äºæœç´¢ç”¨æˆ·ï¼‰
bind_dn = "CN=svcacct,OU=ServiceAccounts,DC=company,DC=com"
bind_password = "secret123"

# æœç´¢åŸºç¡€
base_dn = "OU=Users,DC=company,DC=com"
user_filter = "(&(objectClass=person)(sAMAccountName={username}))"

# å±æ€§æ˜ å°„
attr_username = "sAMAccountName"     # ç”¨æˆ·å â†’ extension
attr_email = "mail"                  # é‚®ç®±
attr_display_name = "displayName"    # å§“å
attr_phone = "telephoneNumber"       # ç”µè¯
attr_department = "department"       # éƒ¨é—¨

# è¿æ¥æ± 
pool_size = 10
timeout_secs = 30

# ç”¨æˆ·åŒæ­¥
sync_enabled = true
sync_interval_hours = 6   # æ¯6å°æ—¶åŒæ­¥ä¸€æ¬¡
```

**4. å®ç°ä»£ç **ï¼š
```rust
use ldap3::{LdapConn, Scope, SearchEntry};

pub struct LdapService {
    config: LdapConfig,
    pool: Arc<Mutex<Vec<LdapConn>>>,
}

impl LdapService {
    /// LDAPè®¤è¯
    pub async fn authenticate(&self, username: &str, password: &str) -> Result<LdapUser> {
        // 1. è·å–è¿æ¥
        let mut ldap = LdapConn::new(&self.config.server)?;
        
        // 2. ä½¿ç”¨æœåŠ¡è´¦å·ç»‘å®šï¼ˆæŸ¥è¯¢ç”¨æˆ·DNï¼‰
        ldap.simple_bind(&self.config.bind_dn, &self.config.bind_password)?
            .success()?;
        
        // 3. æœç´¢ç”¨æˆ·
        let filter = self.config.user_filter.replace("{username}", username);
        let (rs, _res) = ldap.search(
            &self.config.base_dn,
            Scope::Subtree,
            &filter,
            vec![
                &self.config.attr_username,
                &self.config.attr_email,
                &self.config.attr_display_name,
                &self.config.attr_department,
                "dn",
            ]
        )?.success()?;
        
        if rs.is_empty() {
            return Err(Error::UserNotFound);
        }
        
        let entry = SearchEntry::construct(rs[0].clone());
        let user_dn = entry.dn;
        
        // 4. ä½¿ç”¨ç”¨æˆ·å‡­æ®éªŒè¯ï¼ˆå®é™…è®¤è¯ï¼‰
        let mut user_ldap = LdapConn::new(&self.config.server)?;
        user_ldap.simple_bind(&user_dn, password)?
            .success()
            .map_err(|_| Error::InvalidCredentials)?;
        
        // 5. è¿”å›ç”¨æˆ·ä¿¡æ¯
        Ok(LdapUser {
            username: entry.attrs.get(&self.config.attr_username)
                .and_then(|v| v.first())
                .ok_or(Error::MissingAttribute)?.clone(),
            email: entry.attrs.get(&self.config.attr_email)
                .and_then(|v| v.first())
                .cloned(),
            display_name: entry.attrs.get(&self.config.attr_display_name)
                .and_then(|v| v.first())
                .cloned(),
            department: entry.attrs.get(&self.config.attr_department)
                .and_then(|v| v.first())
                .cloned(),
        })
    }
    
    /// ç”¨æˆ·åŒæ­¥ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
    pub async fn sync_users(&self, tenant_id: i64) -> Result<SyncReport> {
        let mut ldap = LdapConn::new(&self.config.server)?;
        ldap.simple_bind(&self.config.bind_dn, &self.config.bind_password)?
            .success()?;
        
        // æœç´¢æ‰€æœ‰ç”¨æˆ·
        let (rs, _) = ldap.search(
            &self.config.base_dn,
            Scope::Subtree,
            "(objectClass=person)",
            vec!["sAMAccountName", "mail", "displayName", "telephoneNumber"]
        )?.success()?;
        
        let mut report = SyncReport::default();
        
        for entry in rs {
            let entry = SearchEntry::construct(entry);
            let username = entry.attrs.get("sAMAccountName")
                .and_then(|v| v.first())
                .ok_or(Error::MissingAttribute)?;
            
            // æ’å…¥æˆ–æ›´æ–°æ•°æ®åº“
            let result = sqlx::query!(
                r#"
                INSERT INTO users (tenant_id, extension, email, display_name, auth_method)
                VALUES ($1, $2, $3, $4, 'ldap')
                ON CONFLICT (tenant_id, extension) 
                DO UPDATE SET 
                    email = EXCLUDED.email,
                    display_name = EXCLUDED.display_name,
                    updated_at = NOW()
                "#,
                tenant_id,
                username,
                entry.attrs.get("mail").and_then(|v| v.first()),
                entry.attrs.get("displayName").and_then(|v| v.first()),
            ).execute(&self.db).await;
            
            match result {
                Ok(_) => report.synced += 1,
                Err(e) => {
                    report.failed += 1;
                    report.errors.push(format!("{}: {}", username, e));
                }
            }
        }
        
        Ok(report)
    }
}

// æ•°æ®åº“å­—æ®µæ‰©å±•
ALTER TABLE users ADD COLUMN auth_method VARCHAR(20) DEFAULT 'pin';
-- å€¼: 'pin', 'ldap', 'saml', 'oauth'
```

---

#### äºŒã€SAML SSOé›†æˆ

**1. åŠŸèƒ½éœ€æ±‚**ï¼š
- æ”¯æŒSAML 2.0åè®®
- Service Provider (SP) è§’è‰²
- å¯¹æ¥ä¼ä¸šIdentity Providerï¼ˆOktaã€Azure ADã€OneLoginï¼‰
- å•ç‚¹ç™»å½•/ç™»å‡º

**2. ä¾èµ–åº“**ï¼š
```toml
[dependencies]
samael = "0.0.14"       # SAMLåº“
openssl = "0.10"        # è¯ä¹¦å¤„ç†
```

**3. é…ç½®æ–‡ä»¶**ï¼š
```toml
[saml]
enabled = true

# SPé…ç½®ï¼ˆRustPBXä½œä¸ºService Providerï¼‰
entity_id = "https://pbx.company.com/saml/metadata"
acs_url = "https://pbx.company.com/saml/acs"  # Assertion Consumer Service
slo_url = "https://pbx.company.com/saml/slo"  # Single Logout

# IdPé…ç½®ï¼ˆä¼ä¸šIdentity Providerï¼‰
idp_entity_id = "https://sso.company.com"
idp_sso_url = "https://sso.company.com/saml/sso"
idp_slo_url = "https://sso.company.com/saml/slo"
idp_cert_path = "/etc/rustpbx/certs/idp_cert.pem"

# SPè¯ä¹¦ï¼ˆç­¾åå’ŒåŠ å¯†ï¼‰
sp_cert_path = "/etc/rustpbx/certs/sp_cert.pem"
sp_key_path = "/etc/rustpbx/certs/sp_key.pem"

# å±æ€§æ˜ å°„
attr_user_id = "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"
attr_email = "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"
attr_extension = "extension"  # è‡ªå®šä¹‰å±æ€§
```

**4. å®ç°ä»£ç **ï¼š
```rust
use samael::metadata::{EntityDescriptor, ContactPerson};
use samael::service_provider::ServiceProviderBuilder;

pub struct SamlService {
    sp: ServiceProvider,
    config: SamlConfig,
}

impl SamlService {
    /// åˆå§‹åŒ–SAML SP
    pub fn new(config: SamlConfig) -> Result<Self> {
        let sp = ServiceProviderBuilder::default()
            .entity_id(&config.entity_id)
            .acs_url(&config.acs_url)
            .idp_metadata_url(&config.idp_metadata_url)
            .certificate_path(&config.sp_cert_path)
            .private_key_path(&config.sp_key_path)
            .build()?;
        
        Ok(Self { sp, config })
    }
    
    /// ç”ŸæˆSPå…ƒæ•°æ®ï¼ˆæä¾›ç»™IdPé…ç½®ï¼‰
    pub fn generate_metadata(&self) -> String {
        let descriptor = EntityDescriptor {
            entity_id: self.config.entity_id.clone(),
            sp_sso_descriptor: Some(/* ... */),
            // ...
        };
        descriptor.to_xml().unwrap()
    }
    
    /// å‘èµ·SSOç™»å½•ï¼ˆé‡å®šå‘åˆ°IdPï¼‰
    pub fn initiate_login(&self, relay_state: Option<String>) -> Result<String> {
        let authn_request = self.sp.create_authn_request()?;
        let redirect_url = self.sp.generate_redirect_url(&authn_request, relay_state)?;
        Ok(redirect_url)
    }
    
    /// å¤„ç†IdPå›è°ƒï¼ˆéªŒè¯æ–­è¨€ï¼‰
    pub async fn handle_acs(&self, saml_response: &str) -> Result<SamlUser> {
        // 1. è§£æSAMLå“åº”
        let response = self.sp.parse_response(saml_response)?;
        
        // 2. éªŒè¯ç­¾å
        response.verify_signature(&self.config.idp_cert)?;
        
        // 3. éªŒè¯æ–­è¨€
        let assertion = response.assertion()?;
        assertion.verify_conditions()?;  // æ—¶é—´çª—å£ã€å—ä¼—
        
        // 4. æå–å±æ€§
        let attributes = assertion.attributes()?;
        let user_id = attributes.get(&self.config.attr_user_id)
            .ok_or(Error::MissingAttribute)?;
        let email = attributes.get(&self.config.attr_email);
        let extension = attributes.get(&self.config.attr_extension)
            .ok_or(Error::MissingExtension)?;
        
        Ok(SamlUser {
            user_id: user_id.clone(),
            email: email.cloned(),
            extension: extension.clone(),
        })
    }
}

// HTTPè·¯ç”±
#[get("/saml/metadata")]
async fn saml_metadata(saml: Data<SamlService>) -> HttpResponse {
    HttpResponse::Ok()
        .content_type("application/xml")
        .body(saml.generate_metadata())
}

#[get("/saml/login")]
async fn saml_login(saml: Data<SamlService>) -> HttpResponse {
    let redirect_url = saml.initiate_login(None).unwrap();
    HttpResponse::Found()
        .insert_header(("Location", redirect_url))
        .finish()
}

#[post("/saml/acs")]
async fn saml_acs(
    saml: Data<SamlService>,
    form: Form<SamlResponse>,
    auth_service: Data<VoicemailAuthService>,
) -> Result<HttpResponse> {
    // 1. éªŒè¯SAMLå“åº”
    let saml_user = saml.handle_acs(&form.saml_response).await?;
    
    // 2. æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·
    let user = get_or_create_user(&saml_user).await?;
    
    // 3. ç”ŸæˆJWT token
    let token = auth_service.generate_token(&user)?;
    
    // 4. è®¾ç½®cookieå¹¶é‡å®šå‘
    Ok(HttpResponse::Found()
        .cookie(Cookie::new("auth_token", token))
        .insert_header(("Location", "/voicemail"))
        .finish())
}
```

---

#### ä¸‰ã€OAuth 2.0 / OpenID Connect

**1. é€‚ç”¨åœºæ™¯**ï¼š
- å¯¹æ¥äº‘æœåŠ¡ï¼ˆGoogle Workspaceã€Microsoft 365ï¼‰
- ç§»åŠ¨Appç¤¾äº¤ç™»å½•
- ç¬¬ä¸‰æ–¹é›†æˆ

**2. ä¾èµ–åº“**ï¼š
```toml
[dependencies]
oauth2 = "4.4"
openidconnect = "3.0"
```

**3. é…ç½®æ–‡ä»¶**ï¼š
```toml
[oauth]
enabled = true
provider = "azure"  # azure, google, okta, custom

# Azure ADç¤ºä¾‹
[oauth.azure]
client_id = "your-client-id"
client_secret = "your-client-secret"
tenant_id = "your-tenant-id"
redirect_uri = "https://pbx.company.com/oauth/callback"

# Scopes
scopes = ["openid", "profile", "email", "User.Read"]
```

**4. å®ç°ä»£ç **ï¼š
```rust
use openidconnect::{
    ClientId, ClientSecret, IssuerUrl, RedirectUrl,
    AuthorizationCode, TokenResponse, UserInfoClaims,
};

pub struct OAuthService {
    client: CoreClient,
}

impl OAuthService {
    /// å‘èµ·OAuthç™»å½•
    pub fn authorize_url(&self) -> (Url, CsrfToken) {
        self.client
            .authorize_url(CsrfToken::new_random)
            .add_scope(Scope::new("openid".to_string()))
            .add_scope(Scope::new("profile".to_string()))
            .add_scope(Scope::new("email".to_string()))
            .url()
    }
    
    /// å¤„ç†å›è°ƒ
    pub async fn handle_callback(&self, code: &str) -> Result<OAuthUser> {
        // 1. äº¤æ¢codeè·å–token
        let token_response = self.client
            .exchange_code(AuthorizationCode::new(code.to_string()))
            .request_async(async_http_client)
            .await?;
        
        // 2. è·å–ç”¨æˆ·ä¿¡æ¯
        let id_token = token_response.id_token()
            .ok_or(Error::MissingIdToken)?;
        let claims = id_token.claims(&self.client.id_token_verifier(), nonce)?;
        
        Ok(OAuthUser {
            sub: claims.subject().to_string(),
            email: claims.email().map(|e| e.to_string()),
            name: claims.name().and_then(|n| n.get(None).cloned()),
        })
    }
}
```

---

#### å››ã€å®æ–½å·¥ä½œé‡è¯„ä¼°

| æ¨¡å— | å·¥ä½œé¡¹ | å·¥ä½œé‡ | ä¾èµ– |
|------|--------|--------|------|
| **LDAPé›†æˆ** | | | |
| | åŸºç¡€è®¤è¯åŠŸèƒ½ | 3å¤© | ldap3åº“ |
| | ç”¨æˆ·åŒæ­¥æœåŠ¡ | 2å¤© | å®šæ—¶ä»»åŠ¡æ¡†æ¶ |
| | é…ç½®ç•Œé¢ | 2å¤© | Web UI |
| | æµ‹è¯•ï¼ˆAD+OpenLDAPï¼‰ | 2å¤© | æµ‹è¯•ç¯å¢ƒ |
| **SAML SSO** | | | |
| | SPå®ç°ï¼ˆå…ƒæ•°æ®ã€ACSï¼‰ | 4å¤© | samaelåº“ |
| | IdPå¯¹æ¥æµ‹è¯• | 3å¤© | Okta/Azure AD |
| | è¯ä¹¦ç®¡ç† | 1å¤© | OpenSSL |
| | å•ç‚¹ç™»å‡ºï¼ˆSLOï¼‰ | 2å¤© | - |
| **OAuth/OIDC** | | | |
| | åŸºç¡€OAuthæµç¨‹ | 2å¤© | oauth2åº“ |
| | å¤šProvideræ”¯æŒ | 2å¤© | - |
| | Tokenç®¡ç† | 1å¤© | - |
| **é€šç”¨åŠŸèƒ½** | | | |
| | æ•°æ®åº“schemaæ‰©å±• | 1å¤© | - |
| | ç”¨æˆ·æ˜ å°„é€»è¾‘ | 2å¤© | - |
| | å®¡è®¡æ—¥å¿— | 1å¤© | - |
| | æ–‡æ¡£ç¼–å†™ | 2å¤© | - |
| **æ€»è®¡** | | **30å¤©** | çº¦1.5äººæœˆ |

**å®æ–½ä¼˜å…ˆçº§**ï¼š
1. **Phase 1**ï¼ˆMVPï¼‰ï¼šLDAPè®¤è¯ - 10å¤©
2. **Phase 2**ï¼šSAML SSO - 10å¤©
3. **Phase 3**ï¼šOAuth/OIDC - 10å¤©

**æŠ€æœ¯é£é™©**ï¼š
- SAMLåè®®å¤æ‚æ€§ï¼ˆè¯ä¹¦ã€ç­¾åã€æ—¶é—´åŒæ­¥ï¼‰
- å„å®¶IdPå®ç°å·®å¼‚ï¼ˆéœ€è¦é€‚é…ï¼‰
- LDAPæœåŠ¡å™¨ç‰ˆæœ¬å…¼å®¹æ€§
- ç”¨æˆ·å±æ€§æ˜ å°„ä¸ä¸€è‡´

**å»ºè®®**ï¼š
- å…ˆå®ç°LDAPï¼ˆæœ€å¸¸è§ã€æœ€ç®€å•ï¼‰
- SAMLä½œä¸ºé«˜çº§åŠŸèƒ½ï¼ˆä¼ä¸šç‰ˆï¼‰
- OAuthå¯é€‰ï¼ˆä¸»è¦ç”¨äºäº‘æœåŠ¡ï¼‰

---

#### 4.1 ç•™è¨€åˆ—è¡¨
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯­éŸ³ä¿¡ç®± - åˆ†æœº 1001                      [è®¾ç½®] [å¸®åŠ©] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ–°ç•™è¨€ 3]  [å·²è¯» 12]  [å·²å½’æ¡£ 45]  [å·²åˆ é™¤ 5]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”´ 13800138000        10:23  42ç§’   é¡¹ç›®è®¨è®º...  [æ’­æ”¾]â”‚
â”‚  âšª 13900139000        09:15  1:23   ç´§æ€¥è®¢å•...  [æ’­æ”¾]â”‚
â”‚  âšª 400-888-8888       æ˜¨å¤©   2:05   å®¢æˆ·æŠ•è¯‰...  [æ’­æ”¾]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½**ï¼š
- æ’­æ”¾å™¨ï¼ˆè¿›åº¦æ¡ã€å€é€Ÿã€ä¸‹è½½ï¼‰
- æ‰¹é‡æ“ä½œï¼ˆæ ‡è®°å·²è¯»ã€åˆ é™¤ã€å¯¼å‡ºï¼‰
- æœç´¢è¿‡æ»¤ï¼ˆæ—¥æœŸã€å·ç ã€å…³é”®è¯ï¼‰
- åˆ†ç±»æ ‡ç­¾ï¼ˆé‡è¦ã€ç´§æ€¥ã€å®¢æˆ·ã€å®¶äººï¼‰

#### 4.2 ç•™è¨€è¯¦æƒ…
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç•™è¨€è¯¦æƒ…                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ æ¥ç”µå·ç ï¼š13800138000                    â”‚
â”‚  â° æ—¶é—´ï¼š2026-01-26 10:23:15               â”‚
â”‚  â±ï¸  æ—¶é•¿ï¼š42 ç§’                              â”‚
â”‚  ğŸ“Š çŠ¶æ€ï¼šæœªè¯»                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸµ éŸ³é¢‘æ’­æ”¾                                 â”‚
â”‚  [â–¶] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 00:15 / 00:42        â”‚
â”‚  [1.0x] [ä¸‹è½½ WAV] [ä¸‹è½½ MP3]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ è½¬å†™æ–‡æœ¬                                 â”‚
â”‚  ä½ å¥½å•Šï¼Œæˆ‘æ˜¯å¼ ä¸‰ï¼Œä»Šå¤©ä¸‹åˆæƒ³è·Ÿä½ èŠä¸€ä¸‹      â”‚
â”‚  é‚£ä¸ªé¡¹ç›®çš„äº‹æƒ…ï¼Œå¤§æ¦‚ä¸‰ç‚¹åˆ°å››ç‚¹ä¹‹é—´æœ‰ç©ºå—ï¼Ÿ  â”‚
â”‚                                              â”‚
â”‚  ğŸ¤– AI æ‘˜è¦                                  â”‚
â”‚  æ¥ç”µäººï¼šå¼ ä¸‰                                â”‚
â”‚  äº‹ç”±ï¼šé¡¹ç›®è®¨è®º                              â”‚
â”‚  æœŸæœ›å›ç”µæ—¶é—´ï¼šä»Šå¤©ä¸‹åˆ 3-4 ç‚¹               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ“ä½œï¼š                                      â”‚
â”‚  [æ ‡è®°å·²è¯»] [åˆ é™¤] [å½’æ¡£] [å›æ‹¨] [è½¬å‘]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3 ä¸ªäººè®¾ç½®
```
è¯­éŸ³ä¿¡ç®±è®¾ç½®
â”œâ”€ æ¬¢è¿è¯­
â”‚  â”œâ”€ [x] ä½¿ç”¨ç³»ç»Ÿé»˜è®¤
â”‚  â”œâ”€ [ ] ä½¿ç”¨è‡ªå®šä¹‰å½•éŸ³
â”‚  â””â”€ [ä¸Šä¼ å½•éŸ³æ–‡ä»¶] [åœ¨çº¿å½•åˆ¶]
â”‚
â”œâ”€ å½•éŸ³è®¾ç½®
â”‚  â”œâ”€ æœ€å¤§æ—¶é•¿ï¼š[5] åˆ†é’Ÿ
â”‚  â”œâ”€ æ— å£°æ£€æµ‹ï¼š[3] ç§’è‡ªåŠ¨ç»“æŸ
â”‚  â””â”€ ç»“æŸæŒ‰é”®ï¼š[#]
â”‚
â”œâ”€ é€šçŸ¥è®¾ç½®
â”‚  â”œâ”€ [x] é‚®ä»¶é€šçŸ¥ï¼šuser@example.com
â”‚  â”œâ”€ [ ] çŸ­ä¿¡é€šçŸ¥ï¼š+86 138-0013-8000
â”‚  â”œâ”€ [x] Web æ¨é€
â”‚  â””â”€ [x] SIP MWI
â”‚
â”œâ”€ è½¬å†™è®¾ç½®
â”‚  â”œâ”€ [x] å¯ç”¨è¯­éŸ³è½¬å†™
â”‚  â”œâ”€ [x] AI æ™ºèƒ½æ‘˜è¦
â”‚  â””â”€ [ ] å…³é”®è¯æå–
â”‚
â””â”€ é…é¢ç®¡ç†
   â”œâ”€ å­˜å‚¨ç©ºé—´ï¼š2.3 GB / 10 GB
   â”œâ”€ ç•™è¨€æ•°é‡ï¼š68 æ¡ / æ— é™åˆ¶
   â””â”€ ä¿ç•™æœŸé™ï¼š90 å¤©
```

---

#### 4.0.1 ä¼ä¸šè®¤è¯é›†æˆè¯´æ˜

> **é‡è¦**ï¼šLDAP/SSO/OAuthç­‰ä¼ä¸šè®¤è¯åŠŸèƒ½ç”±ç‹¬ç«‹çš„ **Enterprise Auth æ’ä»¶** æä¾›ã€‚  
> Voicemail Pro é€šè¿‡è°ƒç”¨å…¨å±€è®¤è¯æœåŠ¡è·å¾—ä»¥ä¸‹èƒ½åŠ›ã€‚

**é›†æˆæ•ˆæœ**ï¼š
- âœ… **LDAP/ADç™»å½•**ï¼šå‘˜å·¥ä½¿ç”¨ä¼ä¸šè´¦å·ç™»å½•ï¼ˆå¦‚ï¼šzhangsan@company.comï¼‰
- âœ… **SAML SSO**ï¼šå•ç‚¹ç™»å½•ï¼Œä»ä¼ä¸šé—¨æˆ·ç›´æ¥è·³è½¬ï¼Œæ— éœ€é‡å¤è¾“å…¥å¯†ç 
- âœ… **OAuth/OIDC**ï¼šæ”¯æŒGoogle Workspaceã€Microsoft 365ã€Okta
- âœ… **MFAå¤šå› ç´ è®¤è¯**ï¼šå¼ºåˆ¶äºŒæ¬¡éªŒè¯ï¼ˆTOTP/SMSï¼‰
- âœ… **ç”¨æˆ·è‡ªåŠ¨åŒæ­¥**ï¼šä»LDAP/ADè‡ªåŠ¨åŒæ­¥ç”¨æˆ·ä¿¡æ¯åˆ°Voicemail
- âœ… **æƒé™ç»§æ‰¿**ï¼šç»§æ‰¿ä¼ä¸šAD/LDAPçš„ç”¨æˆ·æƒé™å’Œç»„ç»‡æ¶æ„
- âœ… **ç»Ÿä¸€å®‰å…¨ç­–ç•¥**ï¼šå¯†ç ç­–ç•¥ã€ä¼šè¯ç®¡ç†ã€å®¡è®¡æ—¥å¿—å…¨å±€ç»Ÿä¸€

**æ’ä»¶ä¾èµ–å…³ç³»**ï¼š
```
Voicemail Pro ($499/å¹´)
    â†“ å¯é€‰ä¾èµ–
Enterprise Auth - åŸºç¡€ç‰ˆ ($299/å¹´)  â† LDAP/AD è®¤è¯
    æˆ–
Enterprise Auth - ä¼ä¸šç‰ˆ ($799/å¹´)  â† LDAP + SAML + OAuth + MFA
```

**é…ç½®ç¤ºä¾‹**ï¼š
```toml
# config.toml
[voicemail]
# æŒ‡å®šä½¿ç”¨å…¨å±€è®¤è¯æœåŠ¡
auth_provider = "enterprise_auth"  

[enterprise_auth]
enabled = true

# LDAPé…ç½®ï¼ˆåŸºç¡€ç‰ˆï¼‰
[enterprise_auth.ldap]
enabled = true
server = "ldap://ad.company.com:389"
base_dn = "OU=Users,DC=company,DC=com"
bind_dn = "CN=svcacct,DC=company,DC=com"
bind_password = "secret123"

# SAMLé…ç½®ï¼ˆä¼ä¸šç‰ˆï¼‰
[enterprise_auth.saml]
enabled = true
idp_sso_url = "https://sso.company.com/saml/sso"
sp_entity_id = "https://pbx.company.com"
```

**ç”¨æˆ·ä½“éªŒ**ï¼š

1. **LDAPç™»å½•**ï¼š
   ```
   ç”¨æˆ·è®¿é—®: https://pbx.company.com/voicemail
   â†’ è¾“å…¥ä¼ä¸šè´¦å·: zhangsan 
   â†’ è¾“å…¥ä¼ä¸šå¯†ç : ******
   â†’ åç«¯è°ƒç”¨LDAPéªŒè¯
   â†’ ç™»å½•æˆåŠŸï¼Œè‡ªåŠ¨åˆ›å»º/æ›´æ–°ç”¨æˆ·è®°å½•
   ```

2. **SAML SSOç™»å½•**ï¼š
   ```
   ç”¨æˆ·è®¿é—®: https://pbx.company.com/voicemail
   â†’ è‡ªåŠ¨é‡å®šå‘åˆ°ä¼ä¸šSSOé¡µé¢
   â†’ ä¼ä¸šç»Ÿä¸€è®¤è¯ï¼ˆå¦‚å·²ç™»å½•åˆ™è·³è¿‡ï¼‰
   â†’ å›è°ƒåˆ°Voicemailï¼Œè‡ªåŠ¨ç™»å½•
   ```

3. **PINç å¤‡ç”¨ç™»å½•**ï¼ˆå¦‚æœLDAP/SSOä¸å¯ç”¨ï¼‰ï¼š
   ```
   ç”¨æˆ·è®¿é—®: https://pbx.company.com/voicemail
   â†’ ç‚¹å‡»"ä½¿ç”¨PINç ç™»å½•"
   â†’ è¾“å…¥åˆ†æœºå· + PINç 
   â†’ æœ¬åœ°éªŒè¯ï¼ˆä¸ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼‰
   ```

**å®æ–½å»ºè®®**ï¼š
- Voicemail Pro **å†…ç½®æ”¯æŒ**åˆ†æœºPINç è®¤è¯ï¼ˆæ— éœ€é¢å¤–æ’ä»¶ï¼‰
- å¦‚éœ€ä¼ä¸šçº§è®¤è¯ï¼Œè´­ä¹° Enterprise Auth æ’ä»¶å³å¯
- Enterprise Auth å¯è¢«æ‰€æœ‰æ¨¡å—å¤ç”¨ï¼ˆConsoleã€IVR Designerã€Call Centerç­‰ï¼‰

---

### 5. ä¼ä¸šçº§åŠŸèƒ½

#### 5.1 é…é¢ç®¡ç†
```sql
-- ç§Ÿæˆ·é…é¢
CREATE TABLE voicemail_quotas (
    tenant_id BIGINT PRIMARY KEY,
    max_storage_gb INT DEFAULT 100,        -- æœ€å¤§å­˜å‚¨
    max_messages_per_user INT DEFAULT 500, -- æ¯ç”¨æˆ·æœ€å¤§ç•™è¨€æ•°
    retention_days INT DEFAULT 90,         -- ä¿ç•™å¤©æ•°
    max_message_duration INT DEFAULT 300   -- å•æ¡æœ€é•¿æ—¶é•¿ï¼ˆç§’ï¼‰
);

-- ç”¨æˆ·ä½¿ç”¨ç»Ÿè®¡
CREATE TABLE voicemail_usage (
    user_id BIGINT PRIMARY KEY,
    message_count INT DEFAULT 0,
    storage_used_mb BIGINT DEFAULT 0,
    last_message_at TIMESTAMPTZ
);
```

#### 5.2 æƒé™ç®¡ç†
```yaml
roles:
  - name: admin
    permissions:
      - voicemail.view_all      # æŸ¥çœ‹æ‰€æœ‰ç•™è¨€
      - voicemail.manage_quota  # ç®¡ç†é…é¢
      - voicemail.export        # å¯¼å‡ºç•™è¨€
      - voicemail.audit         # å®¡è®¡æ—¥å¿—
  
  - name: manager
    permissions:
      - voicemail.view_team     # æŸ¥çœ‹å›¢é˜Ÿç•™è¨€
      - voicemail.assign        # åˆ†é…ç•™è¨€
  
  - name: user
    permissions:
      - voicemail.view_own      # æŸ¥çœ‹è‡ªå·±çš„ç•™è¨€
      - voicemail.manage_own    # ç®¡ç†è‡ªå·±çš„ç•™è¨€
```

#### 5.3 å®¡è®¡æ—¥å¿—
```
2026-01-26 10:25:00 | user1001 | LISTEN   | voicemail_abc123
2026-01-26 10:26:15 | user1001 | DELETE   | voicemail_abc123
2026-01-26 10:30:22 | admin    | EXPORT   | 68 messages
2026-01-26 11:05:00 | user1002 | FORWARD  | voicemail_xyz789 -> user1003
```

#### 5.4 æ‰¹é‡æ“ä½œ
- æ‰¹é‡åˆ é™¤ï¼ˆé€‰æ‹©å¤šæ¡ç•™è¨€ï¼‰
- æ‰¹é‡å¯¼å‡ºï¼ˆZIP æ‰“åŒ…ï¼‰
- æ‰¹é‡è½¬å‘ï¼ˆåˆ†é…ç»™å…¶ä»–äººï¼‰
- æ‰¹é‡æ ‡è®°ï¼ˆå·²è¯»ã€é‡è¦ï¼‰

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚SIP Phone â”‚  â”‚Web UI    â”‚  â”‚Mobile Appâ”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  RustPBX Core                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  SIP Proxy + Call Router                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Voicemail Application Server               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ VoicemailApp â”‚  â”‚ Notifier     â”‚  â”‚ Transcriber  â”‚ â”‚
â”‚  â”‚ (å½•éŸ³/æ’­æ”¾)   â”‚  â”‚ (é‚®ä»¶/çŸ­ä¿¡)   â”‚  â”‚ (è¯­éŸ³è½¬æ–‡å­—)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Storage      â”‚  â”‚ MWI Manager  â”‚  â”‚ API Server   â”‚ â”‚
â”‚  â”‚ (æ–‡ä»¶ç®¡ç†)    â”‚  â”‚ (SIP NOTIFY) â”‚  â”‚ (REST/WS)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Storage Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚PostgreSQLâ”‚  â”‚Local FS  â”‚  â”‚S3/MinIO  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¨¡å—

#### 1. VoicemailAppï¼ˆSIP åº”ç”¨ï¼‰
```rust
// src/addons/voicemail/app.rs
pub struct VoicemailApp {
    mode: VoicemailMode,
    user_id: i64,
    extension: String,
    storage: VoicemailStorage,
    transcriber: TranscriptService,
}

pub enum VoicemailMode {
    Record,  // å½•åˆ¶ç•™è¨€
    Check,   // æŸ¥è¯¢ç•™è¨€
}

#[async_trait]
impl CallApp for VoicemailApp {
    async fn on_enter(&mut self, controller: &mut CallController) -> Result<AppAction> {
        controller.answer().await?;
        
        match self.mode {
            VoicemailMode::Record => {
                self.record_message(controller).await?;
            }
            VoicemailMode::Check => {
                self.check_messages(controller).await?;
            }
        }
        
        Ok(AppAction::Continue)
    }
}
```

#### 2. Storageï¼ˆå­˜å‚¨å±‚ï¼‰
```rust
// src/addons/voicemail/storage.rs
pub struct VoicemailStorage {
    db: DbPool,
    fs: FileStorage,  // Local FS æˆ– S3
}

pub struct Message {
    pub id: Uuid,
    pub user_id: i64,
    pub caller: String,
    pub timestamp: DateTime<Utc>,
    pub duration: u32,
    pub audio_path: String,
    pub transcript: Option<String>,
    pub summary: Option<String>,
    pub status: MessageStatus,
}

pub enum MessageStatus {
    New,
    Read,
    Archived,
    Deleted,
}
```

#### 3. Notifierï¼ˆé€šçŸ¥æœåŠ¡ï¼‰
```rust
// src/addons/voicemail/notifier.rs
pub struct VoicemailNotifier {
    email: EmailService,
    sms: SmsService,
    mwi: MwiService,
    websocket: WebSocketBroadcaster,
}

impl VoicemailNotifier {
    pub async fn notify_new_message(&self, message: &Message, user: &User) -> Result<()> {
        // é‚®ä»¶é€šçŸ¥
        if user.email_notification_enabled {
            self.email.send_voicemail_notification(message, user).await?;
        }
        
        // çŸ­ä¿¡é€šçŸ¥
        if user.sms_notification_enabled {
            self.sms.send_voicemail_alert(message, user).await?;
        }
        
        // MWI æ›´æ–°
        self.mwi.update_indicator(user.extension, user.unread_count).await?;
        
        // Web æ¨é€
        self.websocket.broadcast_to_user(user.id, WebSocketMessage::NewVoicemail {
            message_id: message.id,
            caller: message.caller.clone(),
            duration: message.duration,
        }).await?;
        
        Ok(())
    }
}
```

---

## ğŸ“ æ•°æ®åº“è®¾è®¡

```sql
-- ç•™è¨€è¡¨
CREATE TABLE voicemail_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL REFERENCES users(id),
    caller VARCHAR(50) NOT NULL,
    callee VARCHAR(50) NOT NULL,
    
    -- éŸ³é¢‘ä¿¡æ¯
    audio_path VARCHAR(1024) NOT NULL,
    audio_format VARCHAR(10) DEFAULT 'wav',
    duration INT NOT NULL,  -- ç§’
    file_size BIGINT NOT NULL,  -- å­—èŠ‚
    
    -- è½¬å†™ä¿¡æ¯
    transcript TEXT,
    summary TEXT,
    keywords JSONB,  -- ["é¡¹ç›®", "å¼ ä¸‰", "ä¸‹åˆ3ç‚¹"]
    sentiment VARCHAR(20),  -- positive, neutral, negative, urgent
    
    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'new',  -- new, read, archived, deleted
    is_important BOOLEAN DEFAULT false,
    tags VARCHAR(255)[],
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMPTZ DEFAULT NOW(),
    read_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,
    
    -- ç´¢å¼•
    INDEX idx_user_status (user_id, status),
    INDEX idx_created_at (created_at),
    INDEX idx_caller (caller)
);

-- ç”¨æˆ·é…ç½®
CREATE TABLE voicemail_configs (
    user_id BIGINT PRIMARY KEY REFERENCES users(id),
    
    -- æ¬¢è¿è¯­
    greeting_type VARCHAR(20) DEFAULT 'default',  -- default, custom
    greeting_audio_path VARCHAR(1024),
    
    -- å½•éŸ³è®¾ç½®
    max_duration INT DEFAULT 300,  -- 5åˆ†é’Ÿ
    silence_timeout INT DEFAULT 3,  -- 3ç§’æ— å£°ç»“æŸ
    end_key VARCHAR(1) DEFAULT '#',
    
    -- é€šçŸ¥è®¾ç½®
    email_notification BOOLEAN DEFAULT true,
    email_address VARCHAR(255),
    sms_notification BOOLEAN DEFAULT false,
    sms_number VARCHAR(20),
    mwi_enabled BOOLEAN DEFAULT true,
    web_push_enabled BOOLEAN DEFAULT true,
    
    -- è½¬å†™è®¾ç½®
    transcript_enabled BOOLEAN DEFAULT true,
    summary_enabled BOOLEAN DEFAULT true,
    keyword_extraction BOOLEAN DEFAULT false,
    
    -- é…é¢
    max_messages INT DEFAULT 500,
    storage_quota_mb BIGINT DEFAULT 10240,  -- 10GB
    retention_days INT DEFAULT 90,
    
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ä½¿ç”¨ç»Ÿè®¡
CREATE TABLE voicemail_stats (
    user_id BIGINT PRIMARY KEY REFERENCES users(id),
    message_count INT DEFAULT 0,
    unread_count INT DEFAULT 0,
    storage_used_mb BIGINT DEFAULT 0,
    last_message_at TIMESTAMPTZ,
    last_check_at TIMESTAMPTZ
);

-- æ“ä½œæ—¥å¿—ï¼ˆå®¡è®¡ï¼‰
CREATE TABLE voicemail_audit_logs (
    id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL,
    user_id BIGINT REFERENCES users(id),
    message_id UUID REFERENCES voicemail_messages(id),
    action VARCHAR(50) NOT NULL,  -- listen, delete, forward, export
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    INDEX idx_user_action (user_id, action, created_at)
);
```

---

## ğŸš€ å®ç°è·¯çº¿å›¾

### Phase 1: MVPï¼ˆ2-3 å‘¨ï¼‰

#### Week 1: æ ¸å¿ƒå½•éŸ³åŠŸèƒ½
- [x] åŸºç¡€ VoicemailApp å®ç°
  - å½•åˆ¶ç•™è¨€ï¼ˆæ— äººåº”ç­”è½¬æ¥ï¼‰
  - æ’­æ”¾ç•™è¨€ï¼ˆæ‹¨æ‰“ *97ï¼‰
  - åˆ é™¤ç•™è¨€
- [x] æ•°æ®åº“è®¾è®¡ä¸è¿ç§»
- [x] æœ¬åœ°æ–‡ä»¶å­˜å‚¨
- [x] åŸºç¡€è·¯ç”±é…ç½®

**Milestone**: å¯ä»¥å½•åˆ¶å’ŒæŸ¥è¯¢ç•™è¨€

#### Week 2: é€šçŸ¥ä¸ç®¡ç†
- [x] é‚®ä»¶é€šçŸ¥ï¼ˆSMTPï¼‰
  - æ–°ç•™è¨€é€šçŸ¥
  - é™„ä»¶æ”¯æŒï¼ˆWAVï¼‰
- [x] MWIï¼ˆæ¶ˆæ¯ç­‰å¾…æŒ‡ç¤ºå™¨ï¼‰
  - SIP NOTIFY å®ç°
  - æ”¯æŒä¸»æµè¯æœº
- [x] Web UIï¼ˆåŸºç¡€ç‰ˆï¼‰
  - ç•™è¨€åˆ—è¡¨
  - æ’­æ”¾å™¨
  - åˆ é™¤æ“ä½œ

**Milestone**: å®Œæ•´çš„é€šçŸ¥é“¾è·¯

#### Week 3: è½¬å†™ä¸ä¼˜åŒ–
- [x] è¯­éŸ³è½¬å†™é›†æˆ
  - å¤ç”¨ Transcript æ¨¡å—
  - å¼‚æ­¥è½¬å†™é˜Ÿåˆ—
- [x] é…é¢ç®¡ç†
  - å­˜å‚¨ç©ºé—´é™åˆ¶
  - ç•™è¨€æ•°é‡é™åˆ¶
- [x] License éªŒè¯æ¡†æ¶
  - License Server å¯¹æ¥
  - è¯•ç”¨æœŸç®¡ç†

**Milestone**: MVP å®Œæˆï¼Œå¯å•†ç”¨

---

### Phase 2: å¢å¼ºåŠŸèƒ½ï¼ˆ1-2 å‘¨ï¼‰

#### Week 4: é«˜çº§ç‰¹æ€§
- [ ] AI æ™ºèƒ½æ‘˜è¦
- [ ] å…³é”®è¯æå–
- [ ] æƒ…ç»ªåˆ†æ
- [ ] S3 å­˜å‚¨æ”¯æŒ
- [ ] çŸ­ä¿¡é€šçŸ¥é›†æˆ

#### Week 5: ä¼ä¸šåŠŸèƒ½
- [ ] æ‰¹é‡æ“ä½œ
- [ ] æƒé™ç®¡ç†
- [ ] å®¡è®¡æ—¥å¿—
- [ ] å¯¼å‡ºåŠŸèƒ½ï¼ˆZIPï¼‰
- [ ] å›¢é˜Ÿå…±äº«ç•™è¨€

**Milestone**: ä¼ä¸šçº§åŠŸèƒ½å®Œæ•´

---

### Phase 3: ç§»åŠ¨ç«¯ä¸ä¼˜åŒ–ï¼ˆæŒç»­ï¼‰

#### åç»­è¿­ä»£
- [ ] ç§»åŠ¨ç«¯ Appï¼ˆiOS/Androidï¼‰
- [ ] è¯­éŸ³æŒ‡ä»¤æ“ä½œï¼ˆSiri/Google Assistantï¼‰
- [ ] å¤šè¯­è¨€æ”¯æŒ
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆå¤§é‡ç•™è¨€åœºæ™¯ï¼‰
- [ ] é«˜çº§åˆ†æï¼ˆç•™è¨€è¶‹åŠ¿ã€çƒ­é—¨å…³é”®è¯ï¼‰

---

## ğŸ’° å®šä»·ç­–ç•¥

### è®¢é˜…å¥—é¤

| å¥—é¤ | å®šä»· | åŠŸèƒ½ | ç›®æ ‡ç”¨æˆ· |
|------|------|------|---------|
| **Basic** | $49/æœˆ æˆ– $499/å¹´ | - åŸºç¡€ç•™è¨€<br>- é‚®ä»¶é€šçŸ¥<br>- 10GB å­˜å‚¨<br>- 90å¤©ä¿ç•™ | å°å‹ä¼ä¸š |
| **Pro** | $99/æœˆ æˆ– $999/å¹´ | - Basic å…¨éƒ¨<br>- è¯­éŸ³è½¬å†™<br>- AI æ‘˜è¦<br>- çŸ­ä¿¡é€šçŸ¥<br>- 50GB å­˜å‚¨<br>- 1å¹´ä¿ç•™ | ä¸­å‹ä¼ä¸š |
| **Enterprise** | å®šåˆ¶ | - Pro å…¨éƒ¨<br>- æ— é™å­˜å‚¨<br>- æ°¸ä¹…ä¿ç•™<br>- SLA ä¿éšœ<br>- ä¸“å±æ”¯æŒ | å¤§å‹ä¼ä¸š |

### æŒ‰ç”¨æˆ·æ•°è®¡è´¹

```
1-10 ç”¨æˆ·:   $49/ç”¨æˆ·/å¹´
11-50 ç”¨æˆ·:  $39/ç”¨æˆ·/å¹´ï¼ˆå…«æŠ˜ï¼‰
51-200 ç”¨æˆ·: $29/ç”¨æˆ·/å¹´ï¼ˆå…­æŠ˜ï¼‰
200+ ç”¨æˆ·:   $19/ç”¨æˆ·/å¹´ï¼ˆå››æŠ˜ï¼‰
```

### å¢å€¼æœåŠ¡

- **é¢å¤–å­˜å‚¨**: $10/æœˆ/100GB
- **çŸ­ä¿¡é€šçŸ¥åŒ…**: $20/æœˆ/1000æ¡
- **é«˜çº§ AI åŠŸèƒ½**: $50/æœˆï¼ˆæƒ…ç»ªåˆ†æã€æ„å›¾è¯†åˆ«ï¼‰
- **ç§»åŠ¨ç«¯ App**: $10/ç”¨æˆ·/æœˆ

---

## ğŸ¯ ç«å“åˆ†æ

### ä¸»è¦ç«å“å¯¹æ¯”

| åŠŸèƒ½ | RustPBX Voicemail Pro | FreePBX Voicemail | 3CX | Twilio Flex |
|------|----------------------|-------------------|-----|-------------|
| **åŸºç¡€ç•™è¨€** | âœ… | âœ… | âœ… | âœ… |
| **è¯­éŸ³è½¬å†™** | âœ… æœ¬åœ°åŒ– | âŒ | âŒ | âœ… äº‘ç«¯ |
| **AI æ‘˜è¦** | âœ… | âŒ | âŒ | âœ… |
| **é‚®ä»¶é€šçŸ¥** | âœ… | âœ… | âœ… | âœ… |
| **çŸ­ä¿¡é€šçŸ¥** | âœ… | ğŸ”¶ ç¬¬ä¸‰æ–¹ | ğŸ”¶ ç¬¬ä¸‰æ–¹ | âœ… |
| **MWI** | âœ… | âœ… | âœ… | âŒ |
| **Web UI** | âœ… ç°ä»£åŒ– | ğŸ”¶ è€æ—§ | âœ… | âœ… |
| **ç§»åŠ¨ç«¯** | ğŸ”„ å¼€å‘ä¸­ | âŒ | âœ… | âœ… |
| **å®šä»·** | $499/å¹´ | $395/å¹´ | $695/å¹´ | $1/ç”¨æˆ·/æœˆ |
| **æœ¬åœ°éƒ¨ç½²** | âœ… | âœ… | âœ… | âŒ |

### å·®å¼‚åŒ–ä¼˜åŠ¿

1. **æ€§èƒ½ä¼˜åŠ¿**ï¼šRust å®ç°ï¼Œä½å»¶è¿Ÿé«˜å¹¶å‘
2. **AI é›†æˆ**ï¼šæœ¬åœ°åŒ– AIï¼ˆæ— éšç§æ³„éœ²ï¼‰
3. **ç°ä»£åŒ– UI**ï¼šReact æŠ€æœ¯æ ˆ
4. **ä»·æ ¼ä¼˜åŠ¿**ï¼šæ¯” 3CX ä¾¿å®œ 30%
5. **å¼€æºå‹å¥½**ï¼šæ ¸å¿ƒå¼€æºï¼Œå•†ä¸šæ’ä»¶å¯é€‰

---

## ğŸ“Š æˆåŠŸæŒ‡æ ‡ï¼ˆKPIï¼‰

### æŠ€æœ¯æŒ‡æ ‡
- **å¯ç”¨æ€§**: >99.9%
- **å½•éŸ³æˆåŠŸç‡**: >99.5%
- **è½¬å†™å‡†ç¡®ç‡**: >95%
- **é€šçŸ¥åˆ°è¾¾ç‡**: >99%
- **å¹³å‡å“åº”æ—¶é—´**: <200ms

### ä¸šåŠ¡æŒ‡æ ‡
- **Q1 ç›®æ ‡**: 50 ä¸ªä»˜è´¹å®¢æˆ·
- **Q2 ç›®æ ‡**: 150 ä¸ªä»˜è´¹å®¢æˆ·
- **å®¢å•ä»·**: $499/å¹´
- **ç»­è´¹ç‡**: >80%
- **NPS è¯„åˆ†**: >50

### ç”¨æˆ·æŒ‡æ ‡
- **æ—¥æ´»è·ƒç”¨æˆ·**: ç›®æ ‡ 1000+
- **æ¯æ—¥æ–°ç•™è¨€**: ç›®æ ‡ 5000+
- **ç•™è¨€æŸ¥è¯¢ç‡**: >60%
- **é‚®ä»¶æ‰“å¼€ç‡**: >40%

---

## ğŸ”’ é£é™©ä¸åº”å¯¹

### æŠ€æœ¯é£é™©
| é£é™© | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|---------|
| è½¬å†™å‡†ç¡®ç‡ä¸è¾¾æ ‡ | é«˜ | å¤šå¼•æ“åˆ‡æ¢ï¼ˆé˜¿é‡Œäº‘ã€è®¯é£å¤‡é€‰ï¼‰ |
| å­˜å‚¨æˆæœ¬é«˜ | ä¸­ | S3 å†·å­˜å‚¨ã€è‡ªåŠ¨æ¸…ç† |
| å¤§é‡å¹¶å‘å½•éŸ³ | ä¸­ | å¼‚æ­¥å¤„ç†ã€é˜Ÿåˆ—ç¼“å†² |

### ä¸šåŠ¡é£é™©
| é£é™© | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|---------|
| ç”¨æˆ·ä»˜è´¹æ„æ„¿ä½ | é«˜ | å…è´¹è¯•ç”¨ 30 å¤©ã€åŠŸèƒ½æ¼”ç¤º |
| ç«å“é™ä»· | ä¸­ | å¼ºåŒ–å·®å¼‚åŒ–ï¼ˆAIã€æ€§èƒ½ï¼‰ |
| æ³•å¾‹åˆè§„ï¼ˆéšç§ï¼‰ | ä¸­ | GDPR åˆè§„ã€æ•°æ®åŠ å¯† |

---

## ğŸ“ æ”¯æŒä¸æ–‡æ¡£

### ç”¨æˆ·æ–‡æ¡£
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- åŠŸèƒ½ä½¿ç”¨æ‰‹å†Œ
- å¸¸è§é—®é¢˜ FAQ
- è§†é¢‘æ•™ç¨‹

### å¼€å‘è€…æ–‡æ¡£
- API æ–‡æ¡£
- æ’ä»¶å¼€å‘æŒ‡å—
- é›†æˆç¤ºä¾‹
- æ•…éšœæ’æŸ¥

### æ”¯æŒæ¸ é“
- ğŸ“§ é‚®ä»¶ï¼šsupport@miuda.ai
- ğŸ’¬ åœ¨çº¿å®¢æœï¼ˆå·¥ä½œæ—¥ 9:00-18:00ï¼‰
- ğŸ“š çŸ¥è¯†åº“ï¼šhttps://docs.rustpbx.com
- ğŸŸï¸ å·¥å•ç³»ç»Ÿ

---

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
1. âœ… å®Œæˆäº§å“æ–¹æ¡ˆè¯„å®¡
2. â³ å¯åŠ¨ MVP å¼€å‘ï¼ˆé¢„è®¡ 2-3 å‘¨ï¼‰
3. â³ Beta æµ‹è¯•ï¼ˆ5-10 ä¸ªç§å­ç”¨æˆ·ï¼‰
4. â³ æ­£å¼å‘å¸ƒä¸æ¨å¹¿
