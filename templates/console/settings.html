{% extends "console/layout.html" %}
{% block title %}Settings · {{site_name|default('RustPBX')}}{% endblock %}
{% block content %}
<div class="p-6">
    <div class="mx-auto max-w-7xl space-y-6" x-data='settingsConsole({
        basePath: {{ (base_path | default("/console")) | tojson }},
        settings: {{ settings | default({}) | tojson }},
        currentUser: {{ current_user | default({}) | tojson }}
    })' x-init="init()">
        <div x-show="appReloadModal.open" x-cloak
            class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 px-4 py-6"
            @keydown.escape.window="closeReloadModal()" @click.self="closeReloadModal()">
            <div class="w-full max-w-3xl rounded-2xl bg-white shadow-2xl ring-1 ring-black/10">
                <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
                    <div>
                        <h3 class="text-base font-semibold text-slate-900">Reload application</h3>
                        <p class="text-xs text-slate-500">Validate configuration and restart services safely.</p>
                    </div>
                    <button type="button" class="rounded-md p-2 text-slate-400 transition hover:text-slate-600"
                        @click="closeReloadModal()" :disabled="appReloading">
                        <span class="sr-only">Close</span>
                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l8 8M14 6l-8 8" />
                        </svg>
                    </button>
                </div>
                <div class="px-6 py-4">
                    <div class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600">
                        <p>This action restarts SIP proxy, user agent, and console services. Active calls will drop and
                            new requests queue until the restart completes.</p>
                    </div>
                    <ul class="mt-4 space-y-3">
                        <template x-for="check in appReloadModal.checks" :key="check.id">
                            <li class="flex items-start gap-3">
                                <span class="mt-1 flex h-2.5 w-2.5 flex-none rounded-full"
                                    :class="reloadCheckIndicatorClass(check.status)"></span>
                                <div class="flex-1 text-sm">
                                    <div class="flex items-center gap-2">
                                        <div class="font-semibold text-slate-800" x-text="check.label"></div>
                                        <span class="text-[10px] font-semibold uppercase tracking-wide"
                                            :class="reloadCheckStatusClass(check.status)"
                                            x-text="reloadCheckStatusLabel(check.status)"></span>
                                    </div>
                                    <div class="text-xs text-slate-500" x-text="check.detail || check.hint"></div>
                                </div>
                            </li>
                        </template>
                    </ul>

                    <template x-if="appReloadModal.error">
                        <div class="mt-4 rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-xs text-rose-700">
                            <div class="font-semibold"
                                x-text="appReloadModal.mode === 'check' ? 'Validation failed' : 'Reload failed'"></div>
                            <p class="mt-1" x-text="appReloadModal.error"></p>
                        </div>
                    </template>

                    <template x-if="appReloadModal.message && !appReloadModal.error">
                        <div
                            class="mt-4 rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-xs text-emerald-700">
                            <div class="font-semibold" x-text="appReloadModal.mode === 'check'
                                    ? (appReloadModal.status === 'running' ? 'Validation in progress' : 'Validation result')
                                    : 'Reload in progress'"></div>
                            <p class="mt-1" x-text="appReloadModal.message"></p>
                        </div>
                    </template>
                </div>
                <div class="flex items-center justify-between gap-3 border-t border-slate-200 px-6 py-4">
                    <div class="text-xs text-slate-500">
                        <span class="font-semibold" x-text="reloadStatusLabel"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button"
                            class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-60"
                            @click="closeReloadModal()" :disabled="appReloading && appReloadModal.status === 'running'">
                            Cancel
                        </button>
                        <button type="button"
                            class="inline-flex items-center justify-center gap-2 rounded-lg border border-sky-200 bg-white px-5 py-2 text-sm font-semibold text-sky-600 shadow-sm transition hover:border-sky-300 hover:bg-sky-50 focus:outline-none focus:ring-2 focus:ring-sky-200 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60"
                            @click="startReloadCheck()" :disabled="appReloading || appReloadModal.status === 'running'">
                            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                stroke-width="1.6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l3 3 7-7" />
                            </svg>
                            <span
                                x-text="appReloadModal.mode === 'check' && appReloadModal.status === 'error' ? 'Retry check' : 'Validate configuration'"></span>
                        </button>
                        <template x-if="appReloadModal.mode === 'check' || appReloadModal.status !== 'success'">
                            <button type="button"
                                class="inline-flex items-center justify-center gap-2 rounded-lg bg-rose-600 px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-rose-500 focus:outline-none focus:ring-2 focus:ring-rose-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60 whitespace-nowrap"
                                @click="startReloadApplication()"
                                :disabled="appReloading || appReloadModal.status === 'running'">
                                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                    stroke-width="1.6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 5l6 5-6 5" />
                                </svg>
                                <span x-text="reloadConfirmLabel"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="aclReloadModal.open" x-cloak
            class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 px-4 py-6"
            @keydown.escape.window="closeAclReloadModal()" @click.self="closeAclReloadModal()">
            <div class="w-full max-w-md rounded-2xl bg-white shadow-2xl ring-1 ring-black/10">
                <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
                    <div>
                        <h3 class="text-base font-semibold text-slate-900">Reload ACL rules</h3>
                        <p class="text-xs text-slate-500">Apply updated allow/deny lists without restarting the proxy.
                        </p>
                    </div>
                    <button type="button" class="rounded-md p-2 text-slate-400 transition hover:text-slate-600"
                        @click="closeAclReloadModal()" :disabled="aclReloading">
                        <span class="sr-only">Close</span>
                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l8 8M14 6l-8 8" />
                        </svg>
                    </button>
                </div>
                <div class="px-6 py-4">
                    <div class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600">
                        <p>Live reload updates call admission immediately. Existing calls continue, but new sessions
                            follow the refreshed rules.</p>
                    </div>
                    <ul class="mt-4 space-y-3 text-sm text-slate-600">
                        <li class="flex items-start gap-3">
                            <span class="mt-1 flex h-2.5 w-2.5 flex-none rounded-full"
                                :class="aclReloadModal.status === 'success' ? 'bg-emerald-500' : (aclReloadModal.status === 'running' ? 'bg-sky-400 animate-pulse' : 'bg-slate-300')"></span>
                            <div>
                                <div class="font-semibold text-slate-800">Refresh proxy filters</div>
                                <div class="text-xs text-slate-500">Send reload command to the SIP proxy.</div>
                            </div>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="mt-1 flex h-2.5 w-2.5 flex-none rounded-full"
                                :class="aclReloadModal.status === 'success' ? 'bg-emerald-500' : (aclReloadModal.status === 'running' ? 'bg-sky-400 animate-pulse' : 'bg-slate-300')"></span>
                            <div>
                                <div class="font-semibold text-slate-800">Confirm rule summary</div>
                                <div class="text-xs text-slate-500">Review new totals and metrics in the panel.</div>
                            </div>
                        </li>
                    </ul>

                    <template x-if="aclReloadModal.error">
                        <div class="mt-4 rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-xs text-rose-700">
                            <div class="font-semibold">Reload failed</div>
                            <p class="mt-1" x-text="aclReloadModal.error"></p>
                        </div>
                    </template>

                    <template x-if="aclReloadModal.status === 'success' && aclReloadModal.message">
                        <div
                            class="mt-4 rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-xs text-emerald-700">
                            <div class="font-semibold">Reload complete</div>
                            <p class="mt-1" x-text="aclReloadModal.message"></p>
                        </div>
                    </template>
                </div>
                <div class="flex items-center justify-between gap-3 border-t border-slate-200 px-6 py-4">
                    <div class="text-xs text-slate-500">
                        <span class="font-semibold" x-text="aclReloadStatusLabel"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button"
                            class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-60"
                            @click="closeAclReloadModal()"
                            :disabled="aclReloading && aclReloadModal.status === 'running'">
                            Cancel
                        </button>
                        <template x-if="aclReloadModal.status !== 'success'">
                            <button type="button"
                                class="inline-flex items-center justify-center gap-2 rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60"
                                @click="startAclReload()"
                                :disabled="aclReloading || aclReloadModal.status === 'running'">
                                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                    stroke-width="1.6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 5l6 5-6 5" />
                                </svg>
                                <span
                                    x-text="aclReloadModal.status === 'error' ? 'Retry reload' : 'Confirm reload'"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col gap-3 lg:flex-row lg:items-end lg:justify-between">
            <div>
                <p class="text-[11px] font-semibold uppercase tracking-wide text-sky-600">Control plane</p>
                <h1 class="text-2xl font-semibold text-slate-900">Settings</h1>
                <p class="text-sm text-slate-500">Configure platform behavior, storage, security, and team access.</p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <template x-if="lastOperation">
                    <span class="rounded-full bg-slate-900/5 px-3 py-1.5 text-xs font-semibold text-slate-600">
                        Last action · <span x-text="lastOperation.timestamp"></span>
                    </span>
                </template>
                <div class="text-xs font-semibold text-slate-500">
                    Version · <span class="font-mono text-slate-700"
                        x-text="platform.version || site_version || '—'"></span>
                </div>
                <span class="rounded-full bg-slate-900/5 px-3 py-1.5 text-xs font-semibold text-slate-600">
                    Uptime · <span class="font-mono text-slate-700" x-text="platform.uptime_pretty || '—'"></span>
                </span>
            </div>
        </div>

        <div class="rounded-xl bg-white p-3 shadow-sm ring-1 ring-black/5">
            <nav class="inline-flex w-full flex-wrap gap-2 rounded-lg border border-slate-200 bg-slate-50 p-1 text-xs font-semibold text-slate-600"
                role="tablist" aria-label="Settings sections">
                <template x-for="tab in visibleTabs" :key="tab.id">
                    <button type="button" class="flex-1 rounded-md px-4 py-2 text-left transition sm:flex-none"
                        :class="activeTab === tab.id ? 'bg-white text-sky-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'"
                        :aria-selected="activeTab === tab.id" :aria-controls="`settings-tab-${tab.id}`"
                        @click="activeTab = tab.id">
                        <div class="flex flex-col">
                            <span class="text-sm" x-text="tab.label"></span>
                            <template x-if="tab.description">
                                <span class="text-[11px] font-normal text-slate-400" x-text="tab.description"></span>
                            </template>
                        </div>
                    </button>
                </template>
            </nav>
        </div>

        <section x-show="activeTab === 'platform'" x-cloak x-transition.opacity class="space-y-6"
            id="settings-tab-platform" role="tabpanel" tabindex="0">
            <div class="grid gap-6 lg:grid-cols-2">
                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                        <div>
                            <h2 class="text-base font-semibold text-slate-900">Runtime overview</h2>
                            <p class="text-xs text-slate-500">Snapshot of core services and configuration provenance.
                            </p>
                        </div>
                    </div>
                    <div class="mt-4 space-y-3 text-sm text-slate-600">
                        <div class="flex items-baseline justify-between">
                            <span class="text-xs uppercase tracking-wide text-slate-400">Address</span>
                            <span class="font-mono" x-text="proxyConfig.addr || '—'"></span>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span class="text-xs uppercase tracking-wide text-slate-400">Ports</span>
                            <span class="font-mono"
                                x-text="(proxyConfig.ports || []).map(port => `${port.label}:${port.value}`).join(', ') || '—'"></span>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span class="text-xs uppercase tracking-wide text-slate-400">Modules</span>
                            <span
                                x-text="(proxyConfig.modules || []).length ? proxyConfig.modules.join(', ') : '—'"></span>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span class="text-xs uppercase tracking-wide text-slate-400">Realms</span>
                            <span
                                x-text="(proxyConfig.realms || []).length ? proxyConfig.realms.join(', ') : '—'"></span>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <span class="text-xs uppercase tracking-wide text-slate-400">Data sources</span>
                            <span
                                x-text="proxyConfig.data_sources ? `Routes · ${proxyConfig.data_sources.routes}, Trunks · ${proxyConfig.data_sources.trunks}` : '—'"></span>
                        </div>
                    </div>
                    <div class="mt-4 rounded-lg border border-slate-200 bg-slate-50 px-4 py-3">
                        <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Transactions
                        </div>
                        <div class="mt-3 grid grid-cols-3 gap-3 text-sm text-slate-700">
                            <div>
                                <div class="text-xs uppercase tracking-wide text-slate-400">Running</div>
                                <div class="mt-1 font-semibold text-slate-900"
                                    x-text="displayMetric(stats.proxy?.transactions?.running)"></div>
                            </div>
                            <div>
                                <div class="text-xs uppercase tracking-wide text-slate-400">Finished</div>
                                <div class="mt-1 font-semibold text-slate-900"
                                    x-text="displayMetric(stats.proxy?.transactions?.finished)"></div>
                            </div>
                            <div>
                                <div class="text-xs uppercase tracking-wide text-slate-400">Waiting ACK</div>
                                <div class="mt-1 font-semibold text-slate-900"
                                    x-text="displayMetric(stats.proxy?.transactions?.waiting_ack)"></div>
                            </div>
                        </div>
                        <div class="mt-3 border-t border-slate-200 pt-3 text-xs text-slate-500">
                            Active dialogs · <span class="font-semibold text-slate-700"
                                x-text="displayMetric(stats.proxy?.dialogs)"></span>
                        </div>
                    </div>
                </div>
                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                        <div>
                            <h2 class="text-base font-semibold text-slate-900">Platform settings</h2>
                            <p class="text-xs text-slate-500">Update logging and RTP configuration. Restart required.
                            </p>
                        </div>
                    </div>
                    <form class="mt-4 space-y-4" @submit.prevent="savePlatformSettings">
                        <div class="grid gap-4 md:grid-cols-2">
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Log
                                    level</label>
                                <select x-model="platformDraft.log_level" :disabled="platformProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200">
                                    <option value="">Default</option>
                                    <option value="trace">Trace</option>
                                    <option value="debug">Debug</option>
                                    <option value="info">Info</option>
                                    <option value="warn">Warn</option>
                                    <option value="error">Error</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Log
                                    file</label>
                                <input type="text" x-model="platformDraft.log_file" :disabled="platformProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="/var/log/rustpbx.log" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">External
                                IP</label>
                            <input type="text" x-model="platformDraft.external_ip" :disabled="platformProcessing"
                                class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="1.2.3.4" />
                        </div>
                        <div class="grid gap-4 sm:grid-cols-2">
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">RTP
                                    start port</label>
                                <input type="number" min="1" max="65535" x-model="platformDraft.rtp_start_port"
                                    :disabled="platformProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="12000" />
                            </div>
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">RTP
                                    end port</label>
                                <input type="number" min="1" max="65535" x-model="platformDraft.rtp_end_port"
                                    :disabled="platformProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="42000" />
                            </div>
                        </div>
                        <div
                            class="flex items-center justify-between gap-2 border-t border-slate-200 pt-3 text-xs text-slate-500">
                            <span>Changes apply after a restart.</span>
                            <div class="flex gap-2">
                                <button type="button"
                                    class="inline-flex items-center justify-center rounded-md border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-600 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-60"
                                    @click="resetPlatformDraft" :disabled="platformProcessing">
                                    Reset
                                </button>
                                <button type="submit"
                                    class="inline-flex items-center justify-center rounded-md bg-sky-600 px-3 py-2 text-xs font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60"
                                    :disabled="platformProcessing">
                                    <span x-text="platformProcessing ? 'Saving…' : 'Save changes'"></span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h2 class="text-base font-semibold text-slate-900">Key configuration</h2>
                        <p class="text-xs text-slate-500">Selected settings from the active configuration file.</p>
                    </div>
                </div>
                <div class="mt-4 overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 text-sm">
                        <thead
                            class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                            <tr>
                                <th class="px-4 py-2">Key</th>
                                <th class="px-4 py-2">Value</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <template x-if="!keyConfigRows().length">
                                <tr>
                                    <td class="px-4 py-3 text-xs text-slate-400" colspan="2">No configuration
                                        metadata available.</td>
                                </tr>
                            </template>
                            <template x-for="item in keyConfigRows()" :key="item.label">
                                <tr>
                                    <td class="px-4 py-3 text-xs font-semibold uppercase tracking-wide text-slate-400"
                                        x-text="item.label"></td>
                                    <td class="px-4 py-3 text-sm text-slate-700">
                                        <div class="font-mono whitespace-pre-line" x-text="item.value"></div>
                                        <div class="text-xs text-slate-400" x-show="item.hint" x-text="item.hint">
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

        </section>

        <section x-show="activeTab === 'proxy'" x-cloak x-transition.opacity class="space-y-6" id="settings-tab-proxy"
            role="tabpanel" tabindex="0">
            <div class="grid gap-6 lg:grid-cols-1">
                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                        <div>
                            <h2 class="text-base font-semibold text-slate-900">Proxy configuration</h2>
                            <p class="text-xs text-slate-500">Configure realms, user backends, and external routing
                                integrations.</p>
                        </div>
                    </div>
                    <form class="mt-6 space-y-8" @submit.prevent="saveProxySettings">
                        <!-- Realms Section -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-900">Realms</label>
                                <p class="mt-1 text-xs text-slate-500">Realms are used to partition the SIP namespace.
                                    They determine which domain names the proxy will accept and how users are challenged
                                    for authentication. Each line is a realm (e.g., example.com).</p>
                                <textarea x-model="proxyDraft.realms" :disabled="proxyProcessing" rows="3"
                                    class="mt-2 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="localhost&#10;example.com"></textarea>
                            </div>
                        </div>

                        <hr class="border-slate-100">

                        <!-- Locator Webhook -->
                        <div class="space-y-4">
                            <div>
                                <h3 class="text-sm font-semibold text-slate-900">Locator webhook</h3>
                                <p class="text-xs text-slate-500">Receive real-time notifications when users register,
                                    unregister, or go offline.</p>
                            </div>
                            <div class="grid gap-4 md:grid-cols-2">
                                <div class="md:col-span-1">
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Webhook
                                        URL</label>
                                    <input type="url" x-model="proxyDraft.locator_webhook.url"
                                        :disabled="proxyProcessing"
                                        class="mt-1 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="https://api.example.com/sip-events">
                                </div>
                                <div class="md:col-span-1">
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Timeout
                                        (ms)</label>
                                    <input type="number" x-model="proxyDraft.locator_webhook.timeout_ms"
                                        :disabled="proxyProcessing"
                                        class="mt-1 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="5000">
                                </div>
                                <div class="md:col-span-2">
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Custom
                                        Headers</label>
                                    <textarea x-model="proxyDraft.locator_webhook.headers" :disabled="proxyProcessing"
                                        rows="2"
                                        class="mt-1 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="X-API-Key: secret-key"></textarea>
                                </div>
                            </div>
                            <div class="flex justify-start">
                                <button type="button" @click="testLocatorWebhook"
                                    :disabled="proxyProcessing || !proxyDraft.locator_webhook.url"
                                    class="inline-flex items-center gap-2 rounded-md border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:bg-slate-50 disabled:opacity-50">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="1.6">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Test webhook
                                </button>
                            </div>
                        </div>

                        <hr class="border-slate-100">

                        <!-- User Backends -->
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-sm font-semibold text-slate-900">User backends</h3>
                                    <p class="text-xs text-slate-500">Configure how users are authenticated and
                                        retrieved.</p>
                                </div>
                                <div class="relative" x-data="{ open: false }" @click.away="open = false">
                                    <button type="button" @click="open = !open"
                                        class="inline-flex items-center gap-2 rounded-md bg-white px-3 py-1.5 text-xs font-semibold text-sky-600 shadow-sm ring-1 ring-inset ring-sky-200 hover:bg-sky-50">
                                        Add backend
                                        <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <div x-show="open" x-cloak
                                        class="absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
                                        <div class="py-1" role="menu">
                                            <button type="button" @click="addUserBackend('memory'); open = false"
                                                class="block w-full px-4 py-2 text-left text-xs text-slate-700 hover:bg-slate-100"
                                                role="menuitem">Memory (Config file)</button>
                                            <button type="button" @click="addUserBackend('http'); open = false"
                                                class="block w-full px-4 py-2 text-left text-xs text-slate-700 hover:bg-slate-100"
                                                role="menuitem">HTTP Webhook</button>
                                            <button type="button" @click="addUserBackend('database'); open = false"
                                                class="block w-full px-4 py-2 text-left text-xs text-slate-700 hover:bg-slate-100"
                                                role="menuitem">Database</button>
                                            <button type="button" @click="addUserBackend('plain'); open = false"
                                                class="block w-full px-4 py-2 text-left text-xs text-slate-700 hover:bg-slate-100"
                                                role="menuitem">Plain file</button>
                                            <button type="button" @click="addUserBackend('extension'); open = false"
                                                class="block w-full px-4 py-2 text-left text-xs text-slate-700 hover:bg-slate-100"
                                                role="menuitem">Extension (Internal DB)</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <template x-for="(backend, index) in proxyDraft.user_backends" :key="index">
                                    <div class="rounded-lg border border-slate-200 bg-slate-50 p-4">
                                        <div class="mb-4 flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <span
                                                    class="rounded bg-sky-100 px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider text-sky-700"
                                                    x-text="backend.type"></span>
                                                <span class="text-xs font-semibold text-slate-700"
                                                    x-text="`Backend #${index + 1}`"></span>
                                            </div>
                                            <button type="button" @click="removeUserBackend(index)"
                                                class="text-slate-400 hover:text-rose-600">
                                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                                    stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>

                                        <div class="grid gap-4 md:grid-cols-2">
                                            <template x-if="backend.type === 'http'">
                                                <div class="md:col-span-2 space-y-4">
                                                    <div>
                                                        <label
                                                            class="block text-[10px] font-bold uppercase tracking-wider text-slate-400">URL</label>
                                                        <input type="url" x-model="backend.url"
                                                            class="mt-1 block w-full rounded border border-slate-200 px-2 py-1.5 text-xs text-slate-700 focus:ring-1 focus:ring-sky-300">
                                                    </div>
                                                    <div class="grid gap-4 md:grid-cols-3">
                                                        <div>
                                                            <label
                                                                class="block text-[10px] font-bold uppercase tracking-wider text-slate-400">Method</label>
                                                            <select x-model="backend.method"
                                                                class="mt-1 block w-full rounded border border-slate-200 px-2 py-1.5 text-xs text-slate-700">
                                                                <option value="GET">GET</option>
                                                                <option value="POST">POST</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label
                                                                class="block text-[10px] font-bold uppercase tracking-wider text-slate-400">Username
                                                                Field</label>
                                                            <input type="text" x-model="backend.username_field"
                                                                placeholder="username"
                                                                class="mt-1 block w-full rounded border border-slate-200 px-2 py-1.5 text-xs text-slate-700">
                                                        </div>
                                                        <div>
                                                            <label
                                                                class="block text-[10px] font-bold uppercase tracking-wider text-slate-400">Realm
                                                                Field</label>
                                                            <input type="text" x-model="backend.realm_field"
                                                                placeholder="realm"
                                                                class="mt-1 block w-full rounded border border-slate-200 px-2 py-1.5 text-xs text-slate-700">
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                            <template x-if="backend.type === 'database'">
                                                <div class="md:col-span-2">
                                                    <label
                                                        class="block text-[10px] font-bold uppercase tracking-wider text-slate-400">Database
                                                        URL</label>
                                                    <input type="text" x-model="backend.url"
                                                        placeholder="mysql://user:pass@host/db"
                                                        class="mt-1 block w-full rounded border border-slate-200 px-2 py-1.5 text-xs text-slate-700">
                                                </div>
                                            </template>
                                            <template x-if="backend.type === 'plain'">
                                                <div class="md:col-span-2">
                                                    <label
                                                        class="block text-[10px] font-bold uppercase tracking-wider text-slate-400">File
                                                        Path</label>
                                                    <input type="text" x-model="backend.path" placeholder="./users.txt"
                                                        class="mt-1 block w-full rounded border border-slate-200 px-2 py-1.5 text-xs text-slate-700">
                                                </div>
                                            </template>
                                            <template x-if="backend.type === 'memory'">
                                                <div class="md:col-span-2">
                                                    <p class="text-xs text-slate-500 italic">Static users defined in the
                                                        configuration file.</p>
                                                </div>
                                            </template>
                                            <template x-if="backend.type === 'extension'">
                                                <div class="md:col-span-2">
                                                    <p class="text-xs text-slate-500 italic">Users managed through the
                                                        internal extension database.</p>
                                                </div>
                                            </template>
                                        </div>

                                        <div class="mt-4 flex justify-end">
                                            <button type="button" @click="testUserBackend(index)"
                                                class="text-[11px] font-semibold text-sky-600 hover:text-sky-700">Test
                                                backend</button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <hr class="border-slate-100">

                        <!-- HTTP Call Router -->
                        <div class="space-y-4">
                            <div>
                                <h3 class="text-sm font-semibold text-slate-900">HTTP call router</h3>
                                <p class="text-xs text-slate-500">Determine call destinations dynamically by querying an
                                    external HTTP service.</p>
                            </div>
                            <div class="grid gap-4 md:grid-cols-2">
                                <div class="md:col-span-1">
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Router
                                        URL</label>
                                    <input type="url" x-model="proxyDraft.http_router.url" :disabled="proxyProcessing"
                                        class="mt-1 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="https://api.example.com/route-call">
                                </div>
                                <div class="md:col-span-1">
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Timeout
                                        (ms)</label>
                                    <input type="number" x-model="proxyDraft.http_router.timeout_ms"
                                        :disabled="proxyProcessing"
                                        class="mt-1 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="5000">
                                </div>
                                <div class="md:col-span-2">
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Custom
                                        Headers</label>
                                    <textarea x-model="proxyDraft.http_router.headers" :disabled="proxyProcessing"
                                        rows="2"
                                        class="mt-1 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="Authorization: Bearer ..."></textarea>
                                </div>
                            </div>
                            <div class="flex justify-start">
                                <button type="button" @click="testHttpRouter"
                                    :disabled="proxyProcessing || !proxyDraft.http_router.url"
                                    class="inline-flex items-center gap-2 rounded-md border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:bg-slate-50 disabled:opacity-50">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="1.6">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Test router
                                </button>
                            </div>
                        </div>

                        <div class="flex items-center justify-end gap-2 border-t border-slate-200 pt-6">
                            <button type="button" @click="resetProxyDraft" :disabled="proxyProcessing"
                                class="rounded-md border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50">
                                Reset
                            </button>
                            <button type="submit" :disabled="proxyProcessing"
                                class="rounded-md bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2">
                                <span x-text="proxyProcessing ? 'Saving…' : 'Save proxy settings'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section x-show="activeTab === 'storage'" x-cloak x-transition.opacity class="space-y-6"
            id="settings-tab-storage" role="tabpanel" tabindex="0">
            <div class="space-y-6">
                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
                        <div>
                            <h2 class="text-base font-semibold text-slate-900">Storage destinations</h2>
                            <p class="text-xs text-slate-500">Choose between local disk and S3-compatible buckets
                                for recordings and diagnostics.</p>
                        </div>
                        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">
                            Active profile · <span class="text-sky-600"
                                x-text="selectedStorageProfileData?.label || storageModeLabel(server.storage?.mode)"></span>
                        </span>
                    </div>
                    <form class="mt-4 space-y-4" @submit.prevent="saveStorageSettings">
                        <div>
                            <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Storage
                                Mode</label>
                            <select x-model="storageDraft.callrecord_mode" :disabled="storageProcessing"
                                class="mt-1 block w-full rounded-md border-slate-200 py-2 pl-3 pr-10 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200">
                                <option value="disabled">Disabled</option>
                                <option value="local">Local Filesystem</option>
                                <option value="s3">S3 Compatible Object Store</option>
                            </select>
                        </div>

                        <div x-show="storageDraft.callrecord_mode === 'local'" class="space-y-4">
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Root
                                    Path</label>
                                <input type="text" x-model="storageDraft.callrecord_root" :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="/var/lib/rustpbx/recordings">
                            </div>
                        </div>

                        <div x-show="storageDraft.callrecord_mode === 's3'" class="space-y-4">
                            <div class="grid gap-4 md:grid-cols-2">
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Vendor</label>
                                    <select x-model="storageDraft.callrecord_s3_vendor" :disabled="storageProcessing"
                                        class="mt-1 block w-full rounded-md border-slate-200 py-2 pl-3 pr-10 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200">
                                        <option value="aws">AWS S3</option>
                                        <option value="gcp">Google Cloud Storage</option>
                                        <option value="azure">Azure Blob Storage</option>
                                        <option value="minio">MinIO</option>
                                        <option value="digitalocean">DigitalOcean Spaces</option>
                                        <option value="aliyun">Aliyun OSS</option>
                                        <option value="tencent">Tencent COS</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Region</label>
                                    <input type="text" x-model="storageDraft.callrecord_s3_region"
                                        :disabled="storageProcessing"
                                        class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="us-east-1">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Bucket</label>
                                    <input type="text" x-model="storageDraft.callrecord_s3_bucket"
                                        :disabled="storageProcessing"
                                        class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="my-recordings-bucket">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Endpoint
                                        (Optional)</label>
                                    <input type="text" x-model="storageDraft.callrecord_s3_endpoint"
                                        :disabled="storageProcessing"
                                        class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="https://s3.amazonaws.com">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Access
                                        Key</label>
                                    <input type="password" x-model="storageDraft.callrecord_s3_access_key"
                                        :disabled="storageProcessing"
                                        class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Secret
                                        Key</label>
                                    <input type="password" x-model="storageDraft.callrecord_s3_secret_key"
                                        :disabled="storageProcessing"
                                        class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Root
                                        Path (Prefix)</label>
                                    <input type="text" x-model="storageDraft.callrecord_s3_root"
                                        :disabled="storageProcessing"
                                        class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="recordings/">
                                </div>
                                <div class="col-span-2 flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-6">
                                    <label class="flex items-center gap-2 text-sm font-semibold text-slate-600">
                                        <input type="checkbox"
                                            class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500"
                                            x-model="storageDraft.callrecord_s3_with_media"
                                            :disabled="storageProcessing">
                                        <span>Upload media files</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm font-semibold text-slate-600">
                                        <input type="checkbox"
                                            class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500"
                                            x-model="storageDraft.callrecord_s3_keep_media_copy"
                                            :disabled="storageProcessing">
                                        <span>Keep local copy</span>
                                    </label>
                                </div>
                            </div>
                            <div class="flex items-center justify-end gap-3 border-t border-slate-100 pt-4">
                                <button type="button"
                                    class="inline-flex items-center justify-center gap-2 rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-200 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60"
                                    @click="testStorageConnection()" :disabled="storageProcessing">
                                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="1.6">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                                    </svg>
                                    <span>Test Connection</span>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-3 border-t border-slate-100 pt-4">
                            <button type="button"
                                class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-60"
                                @click="resetStorageDraft()" :disabled="storageProcessing">
                                Reset
                            </button>
                            <button type="submit"
                                class="inline-flex items-center justify-center rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60"
                                :disabled="storageProcessing">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </section>

        <section x-show="activeTab === 'sipflow'" x-cloak x-transition.opacity class="space-y-6"
            id="settings-tab-sipflow" role="tabpanel" tabindex="0">
            <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
                    <div>
                        <h2 class="text-base font-semibold text-slate-900">SipFlow - Advanced Recording System</h2>
                        <p class="text-xs text-slate-500">Unified SIP+RTP recording with optimized I/O pattern for 1000+
                            concurrent calls.</p>
                    </div>
                    <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">
                        Backend · <span
                            :class="sipflowSettings.backend_type !== 'none' ? 'text-emerald-600' : 'text-slate-400'"
                            x-text="sipflowSettings.backend_type || 'none'"></span>
                    </span>
                </div>
                <div class="mt-4 rounded-lg border border-sky-100 bg-sky-50 px-4 py-3 text-xs text-sky-700">
                    <div class="flex items-start gap-2">
                        <svg class="h-4 w-4 flex-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="font-semibold">Better I/O performance than legacy call recording</p>
                            <p class="mt-1">Open-write-close pattern avoids FD exhaustion. Supports 1000+ concurrent
                                calls with hourly file organization.</p>
                        </div>
                    </div>
                </div>
                <form class="mt-4 space-y-4" @submit.prevent="saveSipFlowSettings">
                    <div>
                        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Backend
                            Type</label>
                        <select x-model="sipflowDraft.backend_type" :disabled="sipflowProcessing"
                            class="mt-1 block w-full rounded-md border-slate-200 py-2 pl-3 pr-10 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200">
                            <option value="none">Disabled</option>
                            <option value="local">Local SQLite + Structured files</option>
                            <option value="remote">Remote via UDP/HTTP</option>
                        </select>
                        <p class="mt-1 text-xs text-slate-500">Select backend type to enable SipFlow. </p>
                    </div>

                    <div x-show="sipflowDraft.backend_type !== 'none'" x-cloak
                        class="border-t border-slate-200 pt-4 space-y-4">
                        <!-- Local Backend Config -->
                        <div x-show="sipflowDraft.backend_type === 'local'"
                            class="space-y-4 rounded-lg border border-slate-200 bg-slate-50 p-4">
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Data
                                    Directory</label>
                                <input type="text" x-model="sipflowDraft.local_root" :disabled="sipflowProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="./config/sipflow">
                                <p class="mt-1 text-xs text-slate-500">SQLite database and structured file storage
                                    location</p>
                            </div>
                            <div class="grid gap-4 md:grid-cols-2">
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Flush
                                        Count</label>
                                    <input type="number" x-model.number="sipflowDraft.local_flush_count"
                                        :disabled="sipflowProcessing"
                                        class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="1000" min="1">
                                    <p class="mt-1 text-xs text-slate-500">Buffer size before writing to disk</p>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Flush
                                        Interval (seconds)</label>
                                    <input type="number" x-model.number="sipflowDraft.local_flush_interval_secs"
                                        :disabled="sipflowProcessing"
                                        class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="5" min="1">
                                    <p class="mt-1 text-xs text-slate-500">Maximum time to hold data in memory</p>
                                </div>
                            </div>
                        </div>

                        <!-- Remote Backend Config -->
                        <div x-show="sipflowDraft.backend_type === 'remote'"
                            class="space-y-4 rounded-lg border border-slate-200 bg-slate-50 p-4">
                            <div class="grid gap-4 md:grid-cols-2">
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">UDP
                                        Address</label>
                                    <input type="text" x-model="sipflowDraft.remote_udp_addr"
                                        :disabled="sipflowProcessing"
                                        class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="192.168.1.100:3000">
                                    <p class="mt-1 text-xs text-slate-500">UDP endpoint for real-time flow data</p>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide text-slate-400">HTTP
                                        Address</label>
                                    <input type="text" x-model="sipflowDraft.remote_http_addr"
                                        :disabled="sipflowProcessing"
                                        class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="http://192.168.1.100:3001">
                                    <p class="mt-1 text-xs text-slate-500">HTTP endpoint for queries and downloads</p>
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Timeout
                                    (seconds)</label>
                                <input type="number" x-model.number="sipflowDraft.remote_timeout_secs"
                                    :disabled="sipflowProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="10" min="1">
                                <p class="mt-1 text-xs text-slate-500">Connection and request timeout</p>
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex items-center justify-between gap-2 border-t border-slate-200 pt-3 text-xs text-slate-500">
                        <span>Restart required to apply changes.</span>
                        <div class="flex gap-2">
                            <button type="button"
                                class="inline-flex items-center justify-center rounded-md border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-600 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-60"
                                @click="resetSipFlowDraft" :disabled="sipflowProcessing">
                                Reset
                            </button>
                            <button type="submit"
                                class="inline-flex items-center justify-center rounded-md bg-sky-600 px-3 py-2 text-xs font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60"
                                :disabled="sipflowProcessing">
                                <span x-text="sipflowProcessing ? 'Saving…' : 'Save changes'"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <section x-show="activeTab === 'recording'" x-cloak x-transition.opacity class="space-y-6"
            id="settings-tab-recording" role="tabpanel" tabindex="0">
            <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h2 class="text-base font-semibold text-slate-900">Recording policy</h2>
                        <p class="text-xs text-slate-500">Enable automatic media capture based on caller and callee
                            rules.</p>
                    </div>
                </div>
                <form class="mt-4 space-y-4" @submit.prevent="saveStorageSettings">
                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                        <div>
                            <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Policy
                                status</label>
                            <p class="text-xs text-slate-500">Toggle recording and adjust rules for directions,
                                identities, and output format.</p>
                        </div>
                        <label class="inline-flex items-center gap-2 text-sm font-semibold text-slate-600">
                            <input type="checkbox"
                                class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500"
                                x-model="storageDraft.recording_enabled" :disabled="storageProcessing">
                            <span>Enable</span>
                        </label>
                    </div>
                    <div x-show="storageDraft.recording_enabled" x-cloak
                        class="border-t border-slate-200 pt-4 space-y-4">
                        <div class="grid gap-4 sm:grid-cols-2">
                            <label class="flex items-center gap-2 text-sm font-semibold text-slate-600">
                                <input type="checkbox"
                                    class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500"
                                    x-model="storageDraft.recording_auto_start" :disabled="storageProcessing">
                                <span>Auto start when answered</span>
                            </label>
                            <div>
                                <span
                                    class="text-xs font-semibold uppercase tracking-wide text-slate-400">Directions</span>
                                <div class="mt-2 grid gap-2 sm:grid-cols-3">
                                    <label class="flex items-center gap-2 text-xs font-semibold text-slate-600">
                                        <input type="checkbox"
                                            class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500"
                                            x-model="storageDraft.recording_direction_inbound"
                                            :disabled="storageProcessing">
                                        <span>Inbound</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-xs font-semibold text-slate-600">
                                        <input type="checkbox"
                                            class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500"
                                            x-model="storageDraft.recording_direction_outbound"
                                            :disabled="storageProcessing">
                                        <span>Outbound</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-xs font-semibold text-slate-600">
                                        <input type="checkbox"
                                            class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500"
                                            x-model="storageDraft.recording_direction_internal"
                                            :disabled="storageProcessing">
                                        <span>Internal</span>
                                    </label>
                                </div>
                                <p class="mt-1 text-[11px] text-slate-400">Uncheck to restrict capture to specific call
                                    flows.</p>
                            </div>
                        </div>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Caller
                                    allow list</label>
                                <textarea x-model="storageDraft.recording_caller_allow" :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    rows="3" placeholder="alice@rustpbx.com"></textarea>
                                <p class="mt-1 text-[11px] text-slate-400">One pattern per line. Supports glob
                                    wildcards.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Caller
                                    deny list</label>
                                <textarea x-model="storageDraft.recording_caller_deny" :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    rows="3" placeholder="sales@*"></textarea>
                            </div>
                        </div>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Callee
                                    allow list</label>
                                <textarea x-model="storageDraft.recording_callee_allow" :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    rows="3" placeholder="support@rustpbx.com"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Callee
                                    deny list</label>
                                <textarea x-model="storageDraft.recording_callee_deny" :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    rows="3" placeholder="test-*"></textarea>
                            </div>
                        </div>
                        <div class="grid gap-4 md:grid-cols-3">
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Sample
                                    rate (Hz)</label>
                                <input type="number" min="8000" step="1000" x-model="storageDraft.recording_samplerate"
                                    :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="16000" />
                            </div>
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Packet
                                    time (ms)</label>
                                <input type="number" min="10" step="10" x-model="storageDraft.recording_ptime"
                                    :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="200" />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Filename
                                    pattern</label>
                                <input type="text" x-model="storageDraft.recording_filename_pattern"
                                    :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="{timestamp}_{caller}_{callee}" />
                                <p class="mt-1 text-[11px] text-slate-400">Tokens: {session_id}, {caller}, {callee},
                                    {direction}, {timestamp}</p>
                            </div>
                        </div>
                    </div>
                    <template x-if="!storageDraft.recording_enabled">
                        <div
                            class="rounded-lg border border-dashed border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-500">
                            Recording is currently disabled. Enable the policy to configure capture rules. Storage
                            settings remain available below.
                        </div>
                    </template>
                    <div class="border-t border-slate-200 pt-4 space-y-4">
                        <div>
                            <h3 class="text-sm font-semibold text-slate-800">Recorder storage</h3>
                            <p class="text-xs text-slate-500">Manage recorder output paths and call record storage
                                targets.</p>
                        </div>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div>
                                <label
                                    class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Recorder
                                    root path</label>
                                <input type="text" x-model="storageDraft.recorder_path" :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="/tmp/recorder" />
                            </div>
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Call
                                    record root path</label>
                                <input type="text" x-model="storageDraft.callrecord_root" :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="/tmp/cdr" />
                            </div>
                        </div>
                        <div class="grid gap-4 md:grid-cols-2">
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Media
                                    cache path</label>
                                <input type="text" x-model="storageDraft.media_cache_path" :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="/tmp/mediacache" />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-semibold uppercase tracking-wide text-slate-400">Recorder
                                    format</label>
                                <select x-model="storageDraft.recorder_format" :disabled="storageProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200">
                                    <option value="">Default</option>
                                    <option value="wav">WAV (PCM)</option>
                                    <option value="ogg">OGG (Opus)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div
                        class="flex items-center justify-between gap-2 border-t border-slate-200 pt-3 text-xs text-slate-500">
                        <span>Restart required to apply.</span>
                        <div class="flex gap-2">
                            <button type="button"
                                class="inline-flex items-center justify-center rounded-md border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-600 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-60"
                                @click="resetStorageDraft" :disabled="storageProcessing">
                                Reset
                            </button>
                            <button type="submit"
                                class="inline-flex items-center justify-center rounded-md bg-sky-600 px-3 py-2 text-xs font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60"
                                :disabled="storageProcessing">
                                <span x-text="storageProcessing ? 'Saving…' : 'Save changes'"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <section x-show="activeTab === 'security'" x-cloak x-transition.opacity class="space-y-6"
            id="settings-tab-security" role="tabpanel" tabindex="0">
            <div class="grid gap-6 lg:grid-cols-[minmax(0,1.4fr)_minmax(0,1fr)]">
                <div class="space-y-6">
                    <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                            <div>
                                <h2 class="text-base font-semibold text-slate-900">Access control lists</h2>
                                <p class="text-xs text-slate-500">Network admission rules from config files and embedded
                                    sets.</p>
                            </div>
                            <div class="text-right text-xs text-slate-500">
                                <div class="text-sm font-semibold text-slate-800"
                                    x-text="acl.active_rules.length ? acl.active_rules.length + ' active' : 'No rules'">
                                </div>
                                <div class="text-[11px] uppercase tracking-wide">Rule status</div>
                            </div>
                        </div>
                        <div class="mt-4 grid gap-3 sm:grid-cols-3">
                            <div class="rounded-lg border border-slate-200 px-4 py-3">
                                <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Embedded
                                    definitions</div>
                                <div class="mt-1 text-sm font-semibold text-slate-800" x-text="acl.embedded_count || 0">
                                </div>
                                <div class="text-xs text-slate-500">Rules baked into config.</div>
                            </div>
                            <div class="rounded-lg border border-slate-200 px-4 py-3">
                                <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">File
                                    sources</div>
                                <div class="mt-1 text-sm font-semibold text-slate-800"
                                    x-text="acl.file_patterns.length ? acl.file_patterns.join(', ') : 'Inline only'">
                                </div>
                                <div class="text-xs text-slate-500">Glob patterns watched for ACL files.</div>
                            </div>
                            <div class="rounded-lg border border-slate-200 px-4 py-3">
                                <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Reload
                                    support</div>
                                <div class="mt-1 text-sm font-semibold"
                                    :class="acl.reload_supported ? 'text-emerald-600' : 'text-rose-600'"
                                    x-text="acl.reload_supported ? 'Available' : 'Proxy offline'"></div>
                                <div class="text-xs text-slate-500">Live reload requires the SIP proxy.</div>
                            </div>
                        </div>
                        <template x-if="acl.metrics">
                            <div class="mt-4 rounded-lg border border-dashed border-slate-200 px-4 py-3">
                                <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">Reload
                                    metrics</div>
                                <dl class="mt-3 grid gap-3 text-xs text-slate-600 sm:grid-cols-2 lg:grid-cols-4">
                                    <div>
                                        <dt class="text-[11px] uppercase tracking-wide text-slate-400">Total rules</dt>
                                        <dd class="mt-1 text-sm font-semibold text-slate-800"
                                            x-text="acl.metrics?.total ?? '—'"></dd>
                                    </div>
                                    <div>
                                        <dt class="text-[11px] uppercase tracking-wide text-slate-400">Embedded rules
                                        </dt>
                                        <dd class="mt-1 text-sm font-semibold text-slate-800"
                                            x-text="acl.metrics?.config_count ?? 0"></dd>
                                    </div>
                                    <div>
                                        <dt class="text-[11px] uppercase tracking-wide text-slate-400">File rules</dt>
                                        <dd class="mt-1 text-sm font-semibold text-slate-800"
                                            x-text="acl.metrics?.file_count ?? 0"></dd>
                                    </div>
                                    <div>
                                        <dt class="text-[11px] uppercase tracking-wide text-slate-400">Reload duration
                                        </dt>
                                        <dd class="mt-1 text-sm font-semibold text-slate-800"
                                            x-text="formatDuration(acl.metrics?.duration_ms) || '—'"></dd>
                                    </div>
                                </dl>
                                <template x-if="acl.metrics?.files?.length">
                                    <div class="mt-3 text-xs text-slate-600">
                                        <div class="text-[11px] uppercase tracking-wide text-slate-400">Loaded files
                                        </div>
                                        <ul class="mt-1 space-y-1">
                                            <template x-for="file in acl.metrics.files" :key="file">
                                                <li class="rounded bg-slate-100 px-2 py-1 font-mono text-[11px] text-slate-700"
                                                    x-text="file"></li>
                                            </template>
                                        </ul>
                                    </div>
                                </template>
                                <template x-if="acl.metrics?.patterns?.length">
                                    <div class="mt-3 text-xs text-slate-600">
                                        <div class="text-[11px] uppercase tracking-wide text-slate-400">File patterns
                                        </div>
                                        <ul class="mt-1 space-y-1">
                                            <template x-for="pattern in acl.metrics.patterns" :key="pattern">
                                                <li class="rounded bg-slate-100 px-2 py-1 font-mono text-[11px] text-slate-700"
                                                    x-text="pattern"></li>
                                            </template>
                                        </ul>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="operations.length">
                            <div class="mt-4 rounded-xl border border-rose-200 bg-rose-50 p-5">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-sm font-semibold text-rose-700">Danger zone</h3>
                                </div>
                                <p class="mt-2 text-xs text-slate-500">Reload actions apply immediately to the SIP
                                    proxy in-memory state.</p>
                                <div class="mt-4 space-y-4 text-sm text-slate-600">
                                    <template x-for="action in operations" :key="action.id">
                                        <div class="rounded-lg border border-rose-200 bg-rose-50 p-4">
                                            <div
                                                class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                                <div class="space-y-2">
                                                    <div class="text-sm font-semibold text-slate-700"
                                                        x-text="action.label">
                                                    </div>
                                                    <p class="text-xs text-slate-600" x-show="action.description"
                                                        x-text="action.description"></p>
                                                </div>
                                                <button type="button"
                                                    class="inline-flex items-center justify-center gap-2 rounded-md border border-rose-500 bg-rose-600 px-4 py-2 text-xs font-semibold text-white shadow-sm transition hover:bg-rose-500 focus:outline-none focus:ring-2 focus:ring-rose-400 focus:ring-offset-2"
                                                    :disabled="operationDisabled(action)"
                                                    @click="triggerOperation(action)">
                                                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none"
                                                        stroke="currentColor" stroke-width="1.6">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            d="M7 5l6 5-6 5" />
                                                    </svg>
                                                    <span x-text="operationButtonLabel(action)"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <template x-if="lastOperation">
                                    <div
                                        class="mt-4 rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs text-slate-500">
                                        <div class="font-semibold text-slate-700" x-text="lastOperation.label"></div>
                                        <div x-text="lastOperation.timestamp"></div>
                                        <div class="mt-1" x-text="lastOperation.status"></div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>

                </div>
                <div class="space-y-6">
                    <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                            <div>
                                <h2 class="text-base font-semibold text-slate-900">Update rules</h2>
                                <p class="text-xs text-slate-500">Edit ACL entries and blocked user agents. Restart
                                    required.</p>
                            </div>
                        </div>
                        <form class="mt-4 space-y-4" @submit.prevent="saveSecuritySettings">
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wide text-slate-400">ACL
                                    rules</label>
                                <textarea rows="6" x-model="securityDraft.acl_rules" :disabled="securityProcessing"
                                    class="mt-1 w-full rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="allow all&#10;deny all"></textarea>
                                <p class="mt-1 text-xs text-slate-400">One rule per line, matching the ACL syntax.</p>
                            </div>
                            <div
                                class="flex items-center justify-between gap-2 border-t border-slate-200 pt-3 text-xs text-slate-500">
                                <span>Restart required to apply.</span>
                                <div class="flex gap-2">
                                    <button type="button"
                                        class="inline-flex items-center justify-center rounded-md border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-600 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-60"
                                        @click="resetSecurityDraft" :disabled="securityProcessing">
                                        Reset
                                    </button>
                                    <button type="submit"
                                        class="inline-flex items-center justify-center rounded-md bg-sky-600 px-3 py-2 text-xs font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60"
                                        :disabled="securityProcessing">
                                        <span x-text="securityProcessing ? 'Saving…' : 'Save changes'"></span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <section x-show="activeTab === 'departments'" id="settings-tab-departments" role="tabpanel" tabindex="0">
            <div class="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]">
                <div class="space-y-6">
                    <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                        <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
                            <div>
                                <h2 class="text-base font-semibold text-slate-900">Departments</h2>
                                <p class="text-xs text-slate-500">Manage contact metadata and escalation notes for each
                                    business unit.</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 text-xs font-semibold text-slate-500">
                                <span class="rounded-full bg-slate-100 px-2 py-0.5 text-slate-600"
                                    x-text="departmentSummary"></span>
                                <button type="button"
                                    class="inline-flex items-center gap-2 rounded-lg border border-dashed border-slate-300 px-3 py-1.5 font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700"
                                    @click="openDepartmentCreate()">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 4v12m6-6H4" />
                                    </svg>
                                    New department
                                </button>
                            </div>
                        </div>
                        <div class="mt-4 space-y-4">
                            <div class="grid gap-3 md:grid-cols-[minmax(0,1fr)_auto]">
                                <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                    Search
                                    <input type="search" x-model="departmentParams.q"
                                        @input.debounce.400ms="applyDepartmentFilters()"
                                        class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="Name, label, or slug">
                                </label>
                                <div class="flex items-end justify-end gap-2">
                                    <button type="button"
                                        class="inline-flex items-center gap-1 rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-800"
                                        @click="resetDepartmentFilters()">
                                        Clear
                                    </button>
                                    <button type="button"
                                        class="inline-flex items-center gap-1 rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700"
                                        @click="fetchDepartments()">
                                        Refresh
                                    </button>
                                </div>
                            </div>
                            <template x-if="departmentError">
                                <div class="rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700"
                                    x-text="departmentError"></div>
                            </template>
                            <div class="grid gap-4 lg:grid-cols-[minmax(0,0.9fr)_minmax(0,1.1fr)]">
                                <div class="space-y-2">
                                    <template x-if="departmentLoading">
                                        <div
                                            class="rounded-lg border border-dashed border-slate-200 px-3 py-6 text-center text-xs text-slate-400">
                                            Loading departments…
                                        </div>
                                    </template>
                                    <template x-if="!departmentLoading && !(directory.departments || []).length">
                                        <p
                                            class="rounded-lg border border-dashed border-slate-200 px-3 py-6 text-center text-xs text-slate-400">
                                            No departments yet. Create one to get started.
                                        </p>
                                    </template>
                                    <template x-if="!departmentLoading">
                                        <template x-for="dept in directory.departments || []" :key="dept.id">
                                            <button type="button" @click="selectDepartment(dept.id)"
                                                class="flex w-full items-center justify-between rounded-lg border px-3 py-2 text-left text-sm transition"
                                                :class="String(selectedDepartmentId) === String(dept.id) ? 'border-sky-300 bg-sky-50 text-sky-700 shadow-sm' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'">
                                                <div>
                                                    <div class="font-semibold text-slate-800"
                                                        x-text="dept.display_label || dept.name"></div>
                                                    <div class="text-xs text-slate-400">
                                                        Slug · <span x-text="dept.slug || '—'"></span>
                                                    </div>
                                                </div>
                                                <div class="flex flex-col items-end gap-1 text-right">
                                                    <span
                                                        class="rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-semibold text-slate-600"
                                                        x-text="dept.manager_contact || 'No contact'"></span>
                                                    <span class="text-[11px] text-slate-400"
                                                        x-text="'Updated · ' + formatDateTime(dept.updated_at)"></span>
                                                </div>
                                            </button>
                                        </template>
                                    </template>
                                </div>
                                <div class="space-y-4">
                                    <div class="rounded-lg border border-slate-200 p-4 text-sm text-slate-600"
                                        x-show="selectedDepartment">
                                        <template x-if="selectedDepartment">
                                            <div class="space-y-4">
                                                <div class="flex items-start justify-between gap-3">
                                                    <div>
                                                        <div class="text-xs uppercase tracking-wide text-slate-400">
                                                            Department</div>
                                                        <div class="mt-1 text-base font-semibold text-slate-900"
                                                            x-text="selectedDepartment.display_label || selectedDepartment.name">
                                                        </div>
                                                        <div class="text-xs text-slate-500">
                                                            Name · <span x-text="selectedDepartment.name"></span>
                                                        </div>
                                                    </div>
                                                    <div class="flex flex-col items-end gap-2 text-xs">
                                                        <span
                                                            class="rounded-full bg-slate-100 px-2 py-0.5 font-semibold text-slate-600"
                                                            x-text="selectedDepartment.color || 'No color'"></span>
                                                        <div class="flex items-center gap-2">
                                                            <button type="button"
                                                                class="inline-flex items-center gap-1 rounded-md border border-slate-200 px-2 py-1 font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-800"
                                                                @click="openDepartmentEdit(selectedDepartment.id)">
                                                                <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none"
                                                                    stroke="currentColor" stroke-width="1.6">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        d="M4 13v3h3l9-9-3-3-9 9z" />
                                                                </svg>
                                                                Edit
                                                            </button>
                                                            <button type="button"
                                                                class="inline-flex items-center gap-1 rounded-md border border-rose-200 bg-rose-50 px-2 py-1 font-semibold text-rose-600 transition hover:border-rose-300 hover:bg-rose-100"
                                                                @click="deleteDepartment(selectedDepartment.id)">
                                                                <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none"
                                                                    stroke="currentColor" stroke-width="1.6">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        d="M6 6l8 8M6 14l8-8" />
                                                                </svg>
                                                                Remove
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="grid gap-3 text-xs text-slate-500">
                                                    <div class="flex items-center justify-between">
                                                        <span>Slug</span>
                                                        <span class="font-semibold text-slate-700"
                                                            x-text="selectedDepartment.slug || '—'"></span>
                                                    </div>
                                                    <div class="flex items-center justify-between">
                                                        <span>Manager contact</span>
                                                        <span class="font-semibold text-slate-700"
                                                            x-text="selectedDepartment.manager_contact || 'Not set'"></span>
                                                    </div>
                                                    <div class="flex items-center justify-between">
                                                        <span>Created</span>
                                                        <span class="font-semibold text-slate-700"
                                                            x-text="formatDateTime(selectedDepartment.created_at)"></span>
                                                    </div>
                                                    <div class="flex items-center justify-between">
                                                        <span>Updated</span>
                                                        <span class="font-semibold text-slate-700"
                                                            x-text="formatDateTime(selectedDepartment.updated_at)"></span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="text-xs uppercase tracking-wide text-slate-400">
                                                        Description</div>
                                                    <p class="mt-1 text-xs text-slate-500"
                                                        x-text="selectedDepartment.description || 'No description provided.'">
                                                    </p>
                                                </div>
                                                <div>
                                                    <div class="text-xs uppercase tracking-wide text-slate-400">Metadata
                                                    </div>
                                                    <pre class="mt-1 max-h-40 overflow-auto rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600"
                                                        x-text="formatMetadata(selectedDepartment.metadata)"></pre>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    <template x-if="departmentFormVisible">
                                        <div
                                            class="rounded-xl border border-dashed border-slate-300 bg-slate-50/40 p-5 text-sm text-slate-600">
                                            <form class="space-y-4" @submit.prevent="saveDepartment">
                                                <header class="flex items-center justify-between">
                                                    <div>
                                                        <div class="text-xs uppercase tracking-wide text-slate-400"
                                                            x-text="departmentFormMode === 'edit' ? 'Update department' : 'Create department'">
                                                        </div>
                                                        <h3 class="text-base font-semibold text-slate-900"
                                                            x-text="departmentFormMode === 'edit' ? 'Edit department' : 'New department'">
                                                        </h3>
                                                    </div>
                                                    <button type="button"
                                                        class="text-xs font-semibold text-slate-400 transition hover:text-slate-600"
                                                        @click="cancelDepartmentForm()">Cancel</button>
                                                </header>
                                                <div class="grid gap-4 md:grid-cols-2">
                                                    <label
                                                        class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                                        Name
                                                        <input type="text" x-model="departmentDraft.name" required
                                                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                            placeholder="e.g. Customer success">
                                                    </label>
                                                    <label
                                                        class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                                        Display label
                                                        <input type="text" x-model="departmentDraft.display_label"
                                                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                            placeholder="Optional friendly name">
                                                    </label>
                                                    <label
                                                        class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                                        Slug
                                                        <input type="text" x-model="departmentDraft.slug"
                                                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                            placeholder="auto-generated if left blank">
                                                    </label>
                                                    <label
                                                        class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                                        Color
                                                        <input type="text" x-model="departmentDraft.color"
                                                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                            placeholder="#0EA5E9">
                                                    </label>
                                                    <label
                                                        class="flex flex-col gap-1 text-sm font-medium text-slate-700 md:col-span-2">
                                                        Manager contact
                                                        <input type="text" x-model="departmentDraft.manager_contact"
                                                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                            placeholder="Name or email">
                                                    </label>
                                                </div>
                                                <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                                    Description
                                                    <textarea rows="3" x-model="departmentDraft.description"
                                                        class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                        placeholder="Purpose, responsibilities, or escalation details."></textarea>
                                                </label>
                                                <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                                    Metadata (JSON)
                                                    <textarea rows="4" x-model="departmentDraft.metadataInput"
                                                        class="rounded-lg border border-slate-200 px-3 py-2 font-mono text-xs text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                        placeholder='{"timezone": "UTC"}'></textarea>
                                                    <span class="text-xs font-normal text-slate-400">Optional key/value
                                                        data stored with the department.</span>
                                                </label>
                                                <div class="flex items-center justify-end gap-3">
                                                    <button type="button"
                                                        class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:bg-slate-100"
                                                        @click="cancelDepartmentForm()">Cancel</button>
                                                    <button type="submit"
                                                        class="inline-flex items-center justify-center gap-2 rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2"
                                                        :disabled="departmentProcessing.save">
                                                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none"
                                                            stroke="currentColor" stroke-width="1.8">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                d="M5 10l3 3 7-7" />
                                                        </svg>
                                                        <span
                                                            x-text="departmentProcessing.save ? 'Saving…' : 'Save department'"></span>
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section x-show="activeTab === 'users' && canManageUsers()" x-cloak x-transition.opacity class="space-y-6"
            id="settings-tab-users" role="tabpanel" tabindex="0">
            <div class="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]">
                <div class="space-y-6">
                    <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                        <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
                            <div>
                                <h2 class="text-base font-semibold text-slate-900">Users</h2>
                                <p class="text-xs text-slate-500">Provision console access and enforce privileged
                                    account policies.</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 text-xs font-semibold text-slate-500">
                                <span class="rounded-full bg-slate-100 px-2 py-0.5 text-slate-600"
                                    x-text="userSummary"></span>
                                <button type="button"
                                    class="inline-flex items-center gap-2 rounded-lg border border-dashed border-slate-300 px-3 py-1.5 font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700"
                                    @click="openUserCreate()">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 4v12m6-6H4" />
                                    </svg>
                                    Add team member
                                </button>
                            </div>
                        </div>
                        <div class="mt-4 space-y-4">
                            <div class="grid gap-3 md:grid-cols-[minmax(0,1fr)_auto]">
                                <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                    Search
                                    <input type="search" x-model="userParams.q"
                                        @input.debounce.400ms="applyUserFilters()"
                                        class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                        placeholder="Email or username">
                                </label>
                                <div
                                    class="flex flex-col items-end gap-2 text-xs font-semibold text-slate-500 md:flex-row md:items-center">
                                    <label
                                        class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-1.5 text-xs text-slate-600 transition hover:border-slate-300 hover:text-slate-800">
                                        <input type="checkbox"
                                            class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-400"
                                            x-model="userParams.activeOnly" @change="applyUserFilters()">
                                        Active only
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <button type="button"
                                            class="inline-flex items-center gap-1 rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-800"
                                            @click="resetUserFilters()">
                                            Clear
                                        </button>
                                        <button type="button"
                                            class="inline-flex items-center gap-1 rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700"
                                            @click="fetchUsers()">
                                            Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <template x-if="userError">
                                <div class="rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700"
                                    x-text="userError"></div>
                            </template>
                            <div class="grid gap-4 lg:grid-cols-[minmax(0,1fr)_minmax(0,1fr)]">
                                <div class="space-y-2">
                                    <template x-if="userLoading">
                                        <div
                                            class="rounded-lg border border-dashed border-slate-200 px-3 py-6 text-center text-xs text-slate-400">
                                            Loading users…
                                        </div>
                                    </template>
                                    <template x-if="!userLoading && !(directory.users || []).length">
                                        <p
                                            class="rounded-lg border border-dashed border-slate-200 px-3 py-6 text-center text-xs text-slate-400">
                                            No users match the current filters.
                                        </p>
                                    </template>
                                    <template x-if="!userLoading">
                                        <template x-for="user in directory.users || []" :key="user.id">
                                            <button type="button" @click="selectUser(user.id)"
                                                class="flex w-full items-center justify-between rounded-lg border px-3 py-2 text-left text-sm transition"
                                                :class="String(selectedUserId) === String(user.id) ? 'border-sky-300 bg-sky-50 text-sky-700 shadow-sm' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'">
                                                <div>
                                                    <div class="font-semibold text-slate-800" x-text="user.username">
                                                    </div>
                                                    <div class="text-xs text-slate-400" x-text="user.email"></div>
                                                </div>
                                                <div class="flex flex-col items-end gap-1 text-right">
                                                    <span class="rounded-full px-2 py-0.5 text-[11px] font-semibold"
                                                        :class="userStatusClasses(user)"
                                                        x-text="userStatusLabel(user)"></span>
                                                    <span class="text-[11px] text-slate-400"
                                                        x-text="lastLoginLabel(user)"></span>
                                                </div>
                                            </button>
                                        </template>
                                    </template>
                                </div>
                                <div class="space-y-4">
                                    <div class="rounded-lg border border-slate-200 p-4 text-sm text-slate-600"
                                        x-show="selectedUser">
                                        <template x-if="selectedUser">
                                            <div class="space-y-4">
                                                <div class="flex items-start justify-between gap-3">
                                                    <div>
                                                        <div class="text-xs uppercase tracking-wide text-slate-400">User
                                                        </div>
                                                        <div class="mt-1 text-base font-semibold text-slate-900"
                                                            x-text="selectedUser.username"></div>
                                                        <div class="text-xs text-slate-500" x-text="selectedUser.email">
                                                        </div>
                                                    </div>
                                                    <div class="flex flex-col items-end gap-2 text-xs">
                                                        <span class="rounded-full px-2 py-0.5 text-[11px] font-semibold"
                                                            :class="userStatusClasses(selectedUser)"
                                                            x-text="userStatusLabel(selectedUser)"></span>
                                                        <div class="flex items-center gap-2">
                                                            <button type="button"
                                                                class="inline-flex items-center gap-1 rounded-md border border-slate-200 px-2 py-1 font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-800"
                                                                @click="openUserEdit(selectedUser.id)">
                                                                <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none"
                                                                    stroke="currentColor" stroke-width="1.6">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        d="M4 13v3h3l9-9-3-3-9 9z" />
                                                                </svg>
                                                                Edit
                                                            </button>
                                                            <button type="button"
                                                                class="inline-flex items-center gap-1 rounded-md border border-rose-200 bg-rose-50 px-2 py-1 font-semibold text-rose-600 transition hover:border-rose-300 hover:bg-rose-100"
                                                                @click="deleteUser(selectedUser.id)">
                                                                <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none"
                                                                    stroke="currentColor" stroke-width="1.6">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        d="M6 6l8 8M6 14l8-8" />
                                                                </svg>
                                                                Remove
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="grid gap-3 text-xs text-slate-500">
                                                    <div class="flex items-center justify-between">
                                                        <span>Last login</span>
                                                        <span class="font-semibold text-slate-700"
                                                            x-text="selectedUser.last_login_at ? formatDateTime(selectedUser.last_login_at) : '—'"></span>
                                                    </div>
                                                    <div class="flex items-center justify-between">
                                                        <span>Last IP</span>
                                                        <span class="font-semibold text-slate-700"
                                                            x-text="selectedUser.last_login_ip || '—'"></span>
                                                    </div>
                                                    <div class="flex items-center justify-between">
                                                        <span>Created</span>
                                                        <span class="font-semibold text-slate-700"
                                                            x-text="formatDateTime(selectedUser.created_at)"></span>
                                                    </div>
                                                    <div class="flex items-center justify-between">
                                                        <span>Updated</span>
                                                        <span class="font-semibold text-slate-700"
                                                            x-text="formatDateTime(selectedUser.updated_at)"></span>
                                                    </div>
                                                </div>
                                                <div class="flex flex-wrap gap-2 text-[11px]">
                                                    <span class="rounded-full px-2 py-0.5 font-semibold"
                                                        :class="selectedUser.is_active ? 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-100' : 'bg-amber-50 text-amber-600 ring-1 ring-amber-100'"
                                                        x-text="selectedUser.is_active ? 'Login enabled' : 'Login disabled'"></span>
                                                    <span class="rounded-full px-2 py-0.5 font-semibold"
                                                        :class="selectedUser.is_staff ? 'bg-sky-50 text-sky-600 ring-1 ring-sky-100' : 'bg-slate-100 text-slate-600 ring-1 ring-slate-200'"
                                                        x-text="selectedUser.is_staff ? 'Staff privileges' : 'Standard user'"></span>
                                                    <span class="rounded-full px-2 py-0.5 font-semibold"
                                                        :class="selectedUser.is_superuser ? 'bg-purple-50 text-purple-600 ring-1 ring-purple-100' : 'bg-slate-100 text-slate-600 ring-1 ring-slate-200'"
                                                        x-text="selectedUser.is_superuser ? 'Superuser' : 'Limited'"></span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    <template x-if="userFormVisible">
                                        <div
                                            class="rounded-xl border border-dashed border-slate-300 bg-slate-50/40 p-5 text-sm text-slate-600">
                                            <form class="space-y-4" @submit.prevent="saveUser">
                                                <header class="flex items-center justify-between">
                                                    <div>
                                                        <div class="text-xs uppercase tracking-wide text-slate-400"
                                                            x-text="userFormMode === 'edit' ? 'Update teammate' : 'Invite teammate'">
                                                        </div>
                                                        <h3 class="text-base font-semibold text-slate-900"
                                                            x-text="userFormMode === 'edit' ? 'Edit user' : 'New user'">
                                                        </h3>
                                                    </div>
                                                    <button type="button"
                                                        class="text-xs font-semibold text-slate-400 transition hover:text-slate-600"
                                                        @click="cancelUserForm()">Cancel</button>
                                                </header>
                                                <div class="grid gap-4 md:grid-cols-2">
                                                    <label
                                                        class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                                        Email
                                                        <input type="email" x-model="userDraft.email" required
                                                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                            placeholder="name@rustpbx.com">
                                                    </label>
                                                    <label
                                                        class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                                        Username
                                                        <input type="text" x-model="userDraft.username" required
                                                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                            placeholder="short-handle">
                                                    </label>
                                                </div>
                                                <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                                    Password
                                                    <input type="password" x-model="userDraft.password"
                                                        class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                        :placeholder="userFormMode === 'edit' ? 'Leave blank to keep current password' : 'Set an initial password'">
                                                    <span class="text-xs font-normal text-slate-400"
                                                        x-text="userFormMode === 'edit' ? 'Only fill this field to rotate the password.' : 'Password is required for new users.'"></span>
                                                </label>
                                                <div class="grid gap-3 md:grid-cols-3">
                                                    <label
                                                        class="flex items-center gap-2 text-xs font-semibold text-slate-600">
                                                        <input type="checkbox"
                                                            class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-400"
                                                            x-model="userDraft.is_active">
                                                        Active
                                                    </label>
                                                    <label
                                                        class="flex items-center gap-2 text-xs font-semibold text-slate-600">
                                                        <input type="checkbox"
                                                            class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-400"
                                                            x-model="userDraft.is_staff">
                                                        Staff access
                                                    </label>
                                                    <label
                                                        class="flex items-center gap-2 text-xs font-semibold text-slate-600">
                                                        <input type="checkbox"
                                                            class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-400"
                                                            x-model="userDraft.is_superuser">
                                                        Superuser
                                                    </label>
                                                </div>
                                                <div class="flex items-center justify-end gap-3">
                                                    <button type="button"
                                                        class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:bg-slate-100"
                                                        @click="cancelUserForm()">Cancel</button>
                                                    <button type="submit"
                                                        class="inline-flex items-center justify-center gap-2 rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2"
                                                        :disabled="userProcessing.save">
                                                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none"
                                                            stroke="currentColor" stroke-width="1.8">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                d="M5 10l3 3 7-7" />
                                                        </svg>
                                                        <span
                                                            x-text="userProcessing.save ? 'Saving…' : 'Save user'"></span>
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('settingsConsole', (options = {}) => ({
            basePath: options?.basePath || '/console',
            rawSettings: options?.settings || {},
            amiEndpoint: options?.amiEndpoint || '/ami/v1',
            currentUser: options?.currentUser || null,
            tabs: [
                { id: 'platform', label: 'Platform overview' },
                { id: 'proxy', label: 'Proxy settings' },
                { id: 'storage', label: 'Storage & retention' },
                { id: 'sipflow', label: 'SipFlow recording' },
                { id: 'recording', label: 'Recording policy' },
                { id: 'security', label: 'Security posture' },
                { id: 'departments', label: 'Departments' },
                { id: 'users', label: 'Users', requiresSuperuser: true },
            ],
            activeTab: 'platform',
            platform: {},
            proxyConfig: {},
            stats: {},
            configMeta: { key_items: [] },
            acl: { active_rules: [], embedded_count: 0, file_patterns: [], reload_supported: false, metrics: null },
            operations: [],
            platformDraft: {
                log_level: '',
                log_file: '',
                external_ip: '',
                rtp_start_port: '',
                rtp_end_port: '',
            },
            platformProcessing: false,
            proxyDraft: {
                realms: '',
                locator_webhook: {
                    url: '',
                    timeout_ms: '',
                    headers: '',
                },
                http_router: {
                    url: '',
                    timeout_ms: '',
                    headers: '',
                },
                user_backends: [],
            },
            proxyProcessing: false,
            storageDraft: {
                recorder_path: '',
                recorder_format: 'wav',
                media_cache_path: '',
                callrecord_mode: 'local',
                callrecord_root: '',
                recording_enabled: false,
                recording_auto_start: true,
                recording_direction_inbound: true,
                recording_direction_outbound: true,
                recording_direction_internal: true,
                recording_caller_allow: '',
                recording_caller_deny: '',
                recording_callee_allow: '',
                recording_callee_deny: '',
                recording_samplerate: '',
                recording_ptime: '',
                recording_filename_pattern: '',
            },
            storageProcessing: false,
            sipflowDraft: {
                backend_type: 'none',
                dir_root: '',
                dir_subdirs: 'hourly',
                local_root: '',
                local_flush_count: 1000,
                local_flush_interval_secs: 5,
                remote_udp_addr: '',
                remote_http_addr: '',
                remote_timeout_secs: 10,
            },
            sipflowProcessing: false,
            sipflowSettings: { backend_type: 'none', config: {} },
            securityDraft: {
                acl_rules: '',
            },
            securityProcessing: false,
            aclReloading: false,
            aclReloadModal: {
                open: false,
                status: 'idle',
                error: null,
                message: '',
                action: null,
            },
            appReloading: false,
            appReloadModal: {
                open: false,
                status: 'idle',
                error: null,
                message: '',
                action: null,
                mode: 'reload',
                checks: [],
            },
            server: {},
            recordingPolicy: null,
            retention: {},
            security: {},
            directory: { departments: [], users: [], pending_invites: [] },
            selectedStorageProfile: '',
            selectedDepartmentId: '',
            selectedUserId: '',
            lastOperation: null,
            departmentLoading: false,
            departmentError: null,
            departmentPagination: null,
            departmentParams: { page: 1, perPage: 20, q: '' },
            departmentProcessing: { save: false, delete: null },
            departmentFormVisible: false,
            departmentFormMode: 'create',
            departmentEditingId: '',
            departmentDraft: {
                name: '',
                display_label: '',
                slug: '',
                color: '',
                manager_contact: '',
                description: '',
                metadataInput: '',
            },
            userLoading: false,
            userError: null,
            userPagination: null,
            userParams: { page: 1, perPage: 20, q: '', activeOnly: false },
            userProcessing: { save: false, delete: null },
            userFormVisible: false,
            userFormMode: 'create',
            userEditingId: '',
            userDraft: {
                email: '',
                username: '',
                password: '',
                is_active: true,
                is_staff: false,
                is_superuser: false,
            },
            canManageUsers() {
                return Boolean(this.currentUser && this.currentUser.is_superuser);
            },
            ensureCanManageUsers(notify = false) {
                if (this.canManageUsers()) {
                    return true;
                }
                if (notify) {
                    this.$dispatch('toast', {
                        title: 'Limited access',
                        message: 'Superuser privileges required.',
                    });
                }
                return false;
            },
            init() {
                const data = typeof this.rawSettings === 'string'
                    ? JSON.parse(this.rawSettings || '{}')
                    : (this.rawSettings || {});
                this.currentUser = options?.currentUser || data.current_user || this.currentUser || null;
                if (!this.canManageUsers() && this.activeTab === 'users') {
                    this.activeTab = 'platform';
                }
                this.amiEndpoint = options?.amiEndpoint || data.ami_endpoint || '/ami/v1';
                this.platform = data.platform || {};
                this.proxyConfig = data.proxy || {};
                if (!Array.isArray(this.proxyConfig.realms)) {
                    if (typeof this.proxyConfig.realms === 'string' && this.proxyConfig.realms.length) {
                        this.proxyConfig.realms = [this.proxyConfig.realms];
                    } else {
                        this.proxyConfig.realms = [];
                    }
                }
                this.stats = data.stats || {};
                this.configMeta = data.config || { key_items: [] };
                if (!Array.isArray(this.configMeta.key_items)) {
                    this.configMeta.key_items = [];
                }
                this.acl = data.acl || { active_rules: [], embedded_count: 0, file_patterns: [], reload_supported: false, metrics: null };
                if (!Array.isArray(this.acl.active_rules)) {
                    this.acl.active_rules = [];
                }
                if (!Array.isArray(this.acl.file_patterns)) {
                    this.acl.file_patterns = [];
                }
                this.operations = Array.isArray(data.operations)
                    ? data.operations
                    : (Array.isArray((data.server || {}).operations) ? data.server.operations : []);
                this.server = data.server || {};
                this.recordingPolicy = data.recording || null;
                if (!this.operations.length && Array.isArray(this.server.operations)) {
                    this.operations = this.server.operations;
                }
                this.retention = data.retention || {};
                this.security = data.security || { trusted_ips: [], blocked_user_agents: [], rate_limits: {}, threat_feed: [], audit: {} };
                if (!this.security || typeof this.security !== 'object') {
                    this.security = {};
                }
                if (!this.security.rate_limits || typeof this.security.rate_limits !== 'object') {
                    this.security.rate_limits = {};
                }
                if (this.security.rate_limits.max_call_concurrency === undefined || this.security.rate_limits.max_call_concurrency === null) {
                    this.security.rate_limits.max_call_concurrency = 0;
                }
                if (this.security.rate_limits.max_registration_concurrency === undefined || this.security.rate_limits.max_registration_concurrency === null) {
                    this.security.rate_limits.max_registration_concurrency = 0;
                }
                this.security.acl_rules = this.formatAclRules(this.acl.active_rules);
                const storageMeta = this.server.storage || {};
                this.selectedStorageProfile = storageMeta.active_profile
                    || storageMeta.mode
                    || (this.server.storage_profiles?.[0]?.id || '');
                if (this.storageProfiles.length) {
                    const exists = this.storageProfiles.find((profile) => profile.id === this.selectedStorageProfile);
                    if (!exists) {
                        this.selectedStorageProfile = this.storageProfiles[0].id;
                    }
                }
                this.initPlatformDraft();
                this.initProxyDraft();
                this.initStorageDraft();
                this.initSecurityDraft();
                this.fetchSipFlowSettings();
                this.directory = { departments: [], users: [], pending_invites: [] };
                this.departmentPagination = null;
                this.userPagination = null;
                this.departmentError = null;
                this.userError = null;
                this.departmentParams.page = 1;
                this.departmentParams.perPage = 20;
                this.departmentParams.q = '';
                this.userParams.page = 1;
                this.userParams.perPage = 20;
                this.userParams.q = '';
                this.userParams.activeOnly = false;
                this.departmentDraft = this.defaultDepartmentDraft();
                this.userDraft = this.defaultUserDraft();
                this.departmentFormMode = 'create';
                this.departmentFormVisible = false;
                this.departmentEditingId = '';
                this.userFormMode = 'create';
                this.userFormVisible = false;
                this.userEditingId = '';
                this.selectedDepartmentId = '';
                this.selectedUserId = '';
                this.fetchDepartments();
                this.fetchUsers();
                this.resetAclReloadModal();
                this.resetReloadModal();
            },
            get visibleTabs() {
                return this.tabs.filter((tab) => !tab.requiresSuperuser || this.canManageUsers());
            },
            get storageProfiles() {
                return Array.isArray(this.server.storage_profiles) ? this.server.storage_profiles : [];
            },
            selectStorageProfile(id) {
                this.selectedStorageProfile = id;
            },
            get selectedStorageProfileData() {
                return this.storageProfiles.find((item) => item.id === this.selectedStorageProfile) || null;
            },
            profileConfig(profile) {
                if (!profile || typeof profile.config !== 'object') {
                    return [];
                }
                return Object.entries(profile.config).map(([key, value]) => {
                    let display;
                    if (value === null || value === undefined) {
                        display = '—';
                    } else if (typeof value === 'number') {
                        display = value.toString();
                    } else if (typeof value === 'boolean') {
                        display = value ? 'true' : 'false';
                    } else if (typeof value === 'object') {
                        try {
                            display = JSON.stringify(value, null, 2);
                        } catch (err) {
                            display = String(value);
                        }
                    } else {
                        display = String(value);
                    }
                    return {
                        key,
                        label: this.labelize(key),
                        value: display,
                    };
                });
            },
            labelize(key) {
                return String(key)
                    .replace(/[_-]/g, ' ')
                    .replace(/\b\w/g, (match) => match.toUpperCase());
            },
            storageModeLabel(mode) {
                switch ((mode || '').toLowerCase()) {
                    case 'local':
                        return 'Local only';
                    case 'hybrid':
                        return 'Hybrid';
                    case 'http':
                        return 'HTTP webhook';
                    case 's3':
                    case 'remote':
                        return 'Remote (S3)';
                    default:
                        return mode || 'Unknown';
                }
            },
            get selectedDepartment() {
                return (this.directory.departments || []).find((dept) => String(dept.id) === String(this.selectedDepartmentId)) || null;
            },
            selectDepartment(id) {
                this.selectedDepartmentId = id;
            },
            get departmentSummary() {
                const total = this.departmentPagination?.total_items;
                if (typeof total === 'number') {
                    return `${total} ${total === 1 ? 'department' : 'departments'}`;
                }
                const count = (this.directory.departments || []).length;
                return `${count} ${count === 1 ? 'department' : 'departments'}`;
            },
            get selectedUser() {
                return (this.directory.users || []).find((user) => String(user.id) === String(this.selectedUserId)) || null;
            },
            selectUser(id) {
                this.selectedUserId = id;
            },
            get userSummary() {
                const total = this.userPagination?.total_items;
                if (typeof total === 'number') {
                    return `${total} ${total === 1 ? 'user' : 'users'}`;
                }
                const count = (this.directory.users || []).length;
                return `${count} ${count === 1 ? 'user' : 'users'}`;
            },
            userStatusClasses(user) {
                if (!user) {
                    return 'bg-slate-100 text-slate-600 ring-1 ring-slate-200';
                }
                if (!user.is_active) {
                    return 'bg-amber-50 text-amber-600 ring-1 ring-amber-200';
                }
                if (user.is_superuser) {
                    return 'bg-purple-50 text-purple-600 ring-1 ring-purple-200';
                }
                if (user.is_staff) {
                    return 'bg-sky-50 text-sky-600 ring-1 ring-sky-200';
                }
                return 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200';
            },
            userStatusLabel(user) {
                if (!user) {
                    return 'Unknown';
                }
                if (!user.is_active) {
                    return 'Inactive';
                }
                if (user.is_superuser) {
                    return 'Superuser';
                }
                if (user.is_staff) {
                    return 'Staff';
                }
                return 'Active';
            },
            lastLoginLabel(user) {
                if (!user) {
                    return 'Last login · —';
                }
                const label = user.last_login_at ? this.formatDateTime(user.last_login_at) : '—';
                return `Last login · ${label}`;
            },
            formatDateTime(value) {
                if (!value) {
                    return '—';
                }
                try {
                    const date = new Date(value);
                    if (Number.isNaN(date.getTime())) {
                        return value;
                    }
                    return date.toLocaleString();
                } catch (err) {
                    return value;
                }
            },
            capitalize(input) {
                if (!input) {
                    return '';
                }
                return String(input).charAt(0).toUpperCase() + String(input).slice(1);
            },
            formatMetadata(value) {
                if (value === null || value === undefined) {
                    return '—';
                }
                if (typeof value === 'string') {
                    return value;
                }
                try {
                    return JSON.stringify(value, null, 2);
                } catch (err) {
                    return String(value);
                }
            },
            departmentEndpoint() {
                return `${this.basePath}/settings/departments`;
            },
            departmentDetailEndpoint(id) {
                return `${this.departmentEndpoint()}/${id}`;
            },
            buildDepartmentParams() {
                return {
                    page: this.departmentParams.page || 1,
                    per_page: this.departmentParams.perPage || 20,
                    filters: {
                        q: (this.departmentParams.q || '').trim(),
                    },
                };
            },
            applyDepartmentFilters() {
                this.departmentParams.page = 1;
                this.fetchDepartments();
            },
            resetDepartmentFilters() {
                this.departmentParams.q = '';
                this.departmentParams.page = 1;
                this.fetchDepartments();
            },
            async fetchDepartments() {
                this.departmentLoading = true;
                this.departmentError = null;
                try {
                    const response = await fetch(`${this.departmentEndpoint()}`, {
                        method: 'POST',
                        headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(this.buildDepartmentParams()),
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to load departments');
                    }

                    const items = Array.isArray(data?.items) ? data.items : [];

                    const perPageRaw = Number(data?.per_page);
                    const totalItemsRaw = Number(data?.total_items);
                    const totalPagesRaw = Number(data?.total_pages);
                    const currentPageRaw = Number(data?.page);

                    const fallbackPerPage = this.departmentParams.perPage || 20;
                    const perPage = Number.isFinite(perPageRaw) && perPageRaw > 0 ? perPageRaw : fallbackPerPage;
                    const totalItems = Number.isFinite(totalItemsRaw) && totalItemsRaw >= 0 ? totalItemsRaw : items.length;
                    const inferredTotalPages = Math.max(Math.ceil(totalItems / Math.max(perPage, 1)), 1);
                    const totalPages = Number.isFinite(totalPagesRaw) && totalPagesRaw >= 1
                        ? Math.max(Math.min(totalPagesRaw, inferredTotalPages || 1), 1)
                        : inferredTotalPages;
                    const currentPage = Number.isFinite(currentPageRaw) && currentPageRaw >= 1
                        ? Math.min(currentPageRaw, totalPages)
                        : Math.min(this.departmentParams.page || 1, totalPages);

                    const hasPrevApi = typeof data?.has_prev === 'boolean' ? data.has_prev : null;
                    const hasNextApi = typeof data?.has_next === 'boolean' ? data.has_next : null;
                    const resultsCount = items.length;
                    const showingFrom = resultsCount ? ((currentPage - 1) * perPage) + 1 : 0;
                    const showingTo = resultsCount ? Math.min(showingFrom + resultsCount - 1, totalItems) : 0;
                    const hasPrev = hasPrevApi !== null ? hasPrevApi : currentPage > 1;
                    const hasNext = hasNextApi !== null ? hasNextApi : currentPage < totalPages;
                    const prevPage = hasPrev ? Math.max(currentPage - 1, 1) : null;
                    const nextPage = hasNext ? Math.min(currentPage + 1, totalPages) : null;

                    this.directory.departments = items;
                    this.departmentPagination = {
                        current_page: currentPage,
                        per_page: perPage,
                        total_items: totalItems,
                        total_pages: totalPages,
                        has_prev: hasPrev,
                        has_next: hasNext,
                        prev_page: prevPage,
                        next_page: nextPage,
                        showing_from: showingFrom,
                        showing_to: showingTo,
                    };
                    this.departmentParams.page = currentPage;
                    this.departmentParams.perPage = perPage;
                    if (!items.some((item) => String(item.id) === String(this.selectedDepartmentId))) {
                        this.selectedDepartmentId = items[0]?.id ?? '';
                    }
                } catch (err) {
                    console.error(err);
                    this.departmentError = err.message || 'Failed to load departments';
                    this.directory.departments = [];
                    this.departmentPagination = null;
                    this.selectedDepartmentId = '';
                } finally {
                    this.departmentLoading = false;
                }
            },
            async loadDepartmentDetail(id) {
                if (id === undefined || id === null) {
                    return null;
                }
                try {
                    const response = await fetch(this.departmentDetailEndpoint(id), {
                        method: 'GET',
                        headers: {
                            Accept: 'application/json',
                        },
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to load department');
                    }
                    let updated = false;
                    this.directory.departments = (this.directory.departments || []).map((dept) => {
                        if (String(dept.id) === String(id)) {
                            updated = true;
                            return data;
                        }
                        return dept;
                    });
                    if (!updated) {
                        this.directory.departments.push(data);
                    }
                    return data;
                } catch (err) {
                    console.error(err);
                    this.$dispatch('toast', {
                        title: 'Unable to load',
                        message: err.message || 'Failed to load department details.',
                    });
                    return null;
                }
            },
            metadataToInput(value) {
                if (value === null || value === undefined) {
                    return '';
                }
                if (typeof value === 'string') {
                    return value;
                }
                try {
                    return JSON.stringify(value, null, 2);
                } catch (_) {
                    return '';
                }
            },
            parseMetadataInput(input) {
                const raw = (input || '').trim();
                if (!raw.length) {
                    return null;
                }
                try {
                    return JSON.parse(raw);
                } catch (_) {
                    throw new Error('Metadata must be valid JSON.');
                }
            },
            normalizeOptionalString(value) {
                if (value === null || value === undefined) {
                    return null;
                }
                const trimmed = String(value).trim();
                return trimmed.length ? trimmed : null;
            },
            normalizeOptionalNumber(value) {
                const trimmed = this.normalizeOptionalString(value);
                if (trimmed === null) {
                    return null;
                }
                const numeric = Number(trimmed);
                if (!Number.isFinite(numeric) || numeric <= 0) {
                    return null;
                }
                return Math.floor(numeric);
            },
            listFromTextarea(value) {
                if (value === null || value === undefined) {
                    return [];
                }
                const items = String(value)
                    .split(/\n|,/)
                    .map((line) => line.trim())
                    .filter((line) => line.length);
                return items;
            },
            slugify(value) {
                return String(value || '')
                    .toLowerCase()
                    .trim()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '')
                    .substring(0, 120);
            },
            defaultDepartmentDraft() {
                return {
                    name: '',
                    display_label: '',
                    slug: '',
                    color: '',
                    manager_contact: '',
                    description: '',
                    metadataInput: '',
                };
            },
            departmentToDraft(dept) {
                return {
                    name: dept?.name || '',
                    display_label: dept?.display_label || '',
                    slug: dept?.slug || '',
                    color: dept?.color || '',
                    manager_contact: dept?.manager_contact || '',
                    description: dept?.description || '',
                    metadataInput: this.metadataToInput(dept?.metadata),
                };
            },
            openDepartmentCreate() {
                this.departmentFormMode = 'create';
                this.departmentEditingId = '';
                this.departmentDraft = this.defaultDepartmentDraft();
                this.departmentFormVisible = true;
            },
            async openDepartmentEdit(id) {
                const detail = await this.loadDepartmentDetail(id);
                if (!detail) {
                    return;
                }
                this.departmentFormMode = 'edit';
                this.departmentEditingId = id;
                this.departmentDraft = this.departmentToDraft(detail);
                this.departmentFormVisible = true;
            },
            cancelDepartmentForm() {
                this.departmentFormVisible = false;
                this.departmentEditingId = '';
                this.departmentFormMode = 'create';
                this.departmentDraft = this.defaultDepartmentDraft();
            },
            async saveDepartment() {
                if (this.departmentProcessing.save) {
                    return;
                }
                const draft = this.departmentDraft || this.defaultDepartmentDraft();
                const name = (draft.name || '').trim();
                if (!name.length) {
                    this.$dispatch('toast', {
                        title: 'Missing information',
                        message: 'Department name is required.',
                    });
                    return;
                }
                let metadata;
                try {
                    metadata = this.parseMetadataInput(draft.metadataInput);
                } catch (err) {
                    this.$dispatch('toast', {
                        title: 'Invalid metadata',
                        message: err.message || 'Metadata must be valid JSON.',
                    });
                    return;
                }
                const body = {
                    name,
                    display_label: this.normalizeOptionalString(draft.display_label),
                    description: this.normalizeOptionalString(draft.description),
                    color: this.normalizeOptionalString(draft.color),
                    manager_contact: this.normalizeOptionalString(draft.manager_contact),
                    metadata,
                };
                const slugInput = (draft.slug || '').trim();
                if (this.departmentFormMode === 'edit') {
                    body.slug = slugInput.length ? slugInput : null;
                } else {
                    body.slug = slugInput.length ? slugInput : this.slugify(name);
                }
                this.departmentProcessing.save = true;
                try {
                    const method = this.departmentFormMode === 'edit' ? 'PATCH' : 'PUT';
                    const endpoint = method === 'PATCH'
                        ? this.departmentDetailEndpoint(this.departmentEditingId)
                        : this.departmentEndpoint();
                    const response = await fetch(endpoint, {
                        method,
                        headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body),
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to save department');
                    }
                    if (method === 'PUT' && data?.id !== undefined) {
                        this.selectedDepartmentId = data.id;
                    }
                    this.$dispatch('toast', {
                        title: 'Saved',
                        message: method === 'PUT' ? 'Department created successfully.' : 'Department updated successfully.',
                    });
                    this.cancelDepartmentForm();
                    await this.fetchDepartments();
                } catch (err) {
                    console.error(err);
                    this.$dispatch('toast', {
                        title: 'Save failed',
                        message: err.message || 'Unable to save department.',
                    });
                } finally {
                    this.departmentProcessing.save = false;
                }
            },
            deleteDepartment(id) {
                const dept = (this.directory.departments || []).find((item) => String(item.id) === String(id));
                if (!dept) {
                    return;
                }
                window.dispatchEvent(new CustomEvent('console:confirm', {
                    detail: {
                        title: 'Delete department',
                        message: `Delete ${dept.name}? This action cannot be undone.`,
                        confirmLabel: 'Delete',
                        cancelLabel: 'Cancel',
                        destructive: true,
                        onConfirm: () => this.performDeleteDepartment(id),
                    },
                }));
            },
            async performDeleteDepartment(id) {
                this.departmentProcessing.delete = id;
                this.departmentError = null;
                try {
                    const response = await fetch(this.departmentDetailEndpoint(id), {
                        method: 'DELETE',
                        headers: {
                            Accept: 'application/json',
                        },
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to delete department');
                    }
                    this.$dispatch('toast', {
                        title: 'Deleted',
                        message: 'Department removed successfully.',
                    });
                    if (String(this.selectedDepartmentId) === String(id)) {
                        this.selectedDepartmentId = '';
                    }
                    await this.fetchDepartments();
                } catch (err) {
                    console.error(err);
                    this.departmentError = err.message || 'Failed to delete department';
                    this.$dispatch('toast', {
                        title: 'Delete failed',
                        message: this.departmentError,
                    });
                } finally {
                    this.departmentProcessing.delete = null;
                }
            },
            userEndpoint() {
                return `${this.basePath}/settings/users`;
            },
            userDetailEndpoint(id) {
                return `${this.userEndpoint()}/${id}`;
            },
            buildUserParams() {
                return {
                    filters: {
                        q: (this.userParams.q || '').trim(),
                        active: this.userParams.activeOnly ? true : undefined,
                    },
                    page: this.userParams.page || 1,
                    per_page: this.userParams.perPage || 20,
                };
            },
            applyUserFilters() {
                this.userParams.page = 1;
                this.fetchUsers();
            },
            resetUserFilters() {
                this.userParams.q = '';
                this.userParams.activeOnly = false;
                this.userParams.page = 1;
                this.fetchUsers();
            },
            async fetchUsers() {
                this.userError = null;
                if (!this.canManageUsers()) {
                    this.userLoading = false;
                    this.directory.users = [];
                    this.userPagination = null;
                    this.selectedUserId = '';
                    return;
                }
                this.userLoading = true;
                try {
                    const response = await fetch(`${this.userEndpoint()}`, {
                        method: 'POST',
                        headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(this.buildUserParams()),
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to load users');
                    }

                    const items = Array.isArray(data?.items) ? data.items : [];

                    const perPageRaw = Number(data?.per_page);
                    const totalItemsRaw = Number(data?.total_items);
                    const totalPagesRaw = Number(data?.total_pages);
                    const currentPageRaw = Number(data?.page);

                    const fallbackPerPage = this.userParams.perPage || 20;
                    const perPage = Number.isFinite(perPageRaw) && perPageRaw > 0 ? perPageRaw : fallbackPerPage;
                    const totalItems = Number.isFinite(totalItemsRaw) && totalItemsRaw >= 0 ? totalItemsRaw : items.length;
                    const inferredTotalPages = Math.max(Math.ceil(totalItems / Math.max(perPage, 1)), 1);
                    const totalPages = Number.isFinite(totalPagesRaw) && totalPagesRaw >= 1
                        ? Math.max(Math.min(totalPagesRaw, inferredTotalPages || 1), 1)
                        : inferredTotalPages;
                    const currentPage = Number.isFinite(currentPageRaw) && currentPageRaw >= 1
                        ? Math.min(currentPageRaw, totalPages)
                        : Math.min(this.userParams.page || 1, totalPages);

                    const hasPrevApi = typeof data?.has_prev === 'boolean' ? data.has_prev : null;
                    const hasNextApi = typeof data?.has_next === 'boolean' ? data.has_next : null;
                    const resultsCount = items.length;
                    const showingFrom = resultsCount ? ((currentPage - 1) * perPage) + 1 : 0;
                    const showingTo = resultsCount ? Math.min(showingFrom + resultsCount - 1, totalItems) : 0;
                    const hasPrev = hasPrevApi !== null ? hasPrevApi : currentPage > 1;
                    const hasNext = hasNextApi !== null ? hasNextApi : currentPage < totalPages;
                    const prevPage = hasPrev ? Math.max(currentPage - 1, 1) : null;
                    const nextPage = hasNext ? Math.min(currentPage + 1, totalPages) : null;

                    this.directory.users = items;
                    this.userPagination = {
                        current_page: currentPage,
                        per_page: perPage,
                        total_items: totalItems,
                        total_pages: totalPages,
                        has_prev: hasPrev,
                        has_next: hasNext,
                        prev_page: prevPage,
                        next_page: nextPage,
                        showing_from: showingFrom,
                        showing_to: showingTo,
                    };
                    this.userParams.page = currentPage;
                    this.userParams.perPage = perPage;
                    if (!items.some((item) => String(item.id) === String(this.selectedUserId))) {
                        this.selectedUserId = items[0]?.id ?? '';
                    }
                } catch (err) {
                    console.error(err);
                    this.userError = err.message || 'Failed to load users';
                    this.directory.users = [];
                    this.userPagination = null;
                    this.selectedUserId = '';
                } finally {
                    this.userLoading = false;
                }
            },
            async loadUserDetail(id) {
                if (!this.canManageUsers()) {
                    return null;
                }
                if (id === undefined || id === null) {
                    return null;
                }
                try {
                    const response = await fetch(this.userDetailEndpoint(id), {
                        method: 'GET',
                        headers: {
                            Accept: 'application/json',
                        },
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to load user');
                    }
                    let updated = false;
                    this.directory.users = (this.directory.users || []).map((user) => {
                        if (String(user.id) === String(id)) {
                            updated = true;
                            return data;
                        }
                        return user;
                    });
                    if (!updated) {
                        this.directory.users.push(data);
                    }
                    return data;
                } catch (err) {
                    console.error(err);
                    this.$dispatch('toast', {
                        title: 'Unable to load',
                        message: err.message || 'Failed to load user details.',
                    });
                    return null;
                }
            },
            defaultUserDraft() {
                return {
                    email: '',
                    username: '',
                    password: '',
                    is_active: true,
                    is_staff: false,
                    is_superuser: false,
                };
            },
            userToDraft(user) {
                return {
                    email: user?.email || '',
                    username: user?.username || '',
                    password: '',
                    is_active: !!user?.is_active,
                    is_staff: !!user?.is_staff,
                    is_superuser: !!user?.is_superuser,
                };
            },
            openUserCreate() {
                if (!this.ensureCanManageUsers(true)) {
                    return;
                }
                this.userFormMode = 'create';
                this.userEditingId = '';
                this.userDraft = this.defaultUserDraft();
                this.userFormVisible = true;
            },
            async openUserEdit(id) {
                if (!this.ensureCanManageUsers(true)) {
                    return;
                }
                const detail = await this.loadUserDetail(id);
                if (!detail) {
                    return;
                }
                this.userFormMode = 'edit';
                this.userEditingId = id;
                this.userDraft = this.userToDraft(detail);
                this.userFormVisible = true;
            },
            cancelUserForm() {
                this.userFormVisible = false;
                this.userEditingId = '';
                this.userFormMode = 'create';
                this.userDraft = this.defaultUserDraft();
            },
            async saveUser() {
                if (!this.ensureCanManageUsers(true)) {
                    return;
                }
                if (this.userProcessing.save) {
                    return;
                }
                const draft = this.userDraft || this.defaultUserDraft();
                const email = (draft.email || '').trim();
                const username = (draft.username || '').trim();
                if (!email.length || !username.length) {
                    this.$dispatch('toast', {
                        title: 'Missing information',
                        message: 'Email and username are required.',
                    });
                    return;
                }
                const body = {
                    email,
                    username,
                    is_active: !!draft.is_active,
                    is_staff: !!draft.is_staff,
                    is_superuser: !!draft.is_superuser,
                };
                const password = (draft.password || '').trim();
                if (this.userFormMode === 'edit') {
                    if (password.length) {
                        body.password = password;
                    }
                } else if (!password.length) {
                    this.$dispatch('toast', {
                        title: 'Missing password',
                        message: 'Set an initial password for new users.',
                    });
                    return;
                } else {
                    body.password = password;
                }
                this.userProcessing.save = true;
                try {
                    const method = this.userFormMode === 'edit' ? 'PATCH' : 'PUT';
                    const endpoint = method === 'PATCH'
                        ? this.userDetailEndpoint(this.userEditingId)
                        : this.userEndpoint();
                    const response = await fetch(endpoint, {
                        method,
                        headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body),
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to save user');
                    }
                    if (method === 'PUT' && data?.id !== undefined) {
                        this.selectedUserId = data.id;
                    }
                    this.$dispatch('toast', {
                        title: 'Saved',
                        message: method === 'PUT' ? 'User created successfully.' : 'User updated successfully.',
                    });
                    this.cancelUserForm();
                    await this.fetchUsers();
                } catch (err) {
                    console.error(err);
                    this.$dispatch('toast', {
                        title: 'Save failed',
                        message: err.message || 'Unable to save user.',
                    });
                } finally {
                    this.userProcessing.save = false;
                }
            },
            deleteUser(id) {
                if (!this.ensureCanManageUsers(true)) {
                    return;
                }
                const user = (this.directory.users || []).find((item) => String(item.id) === String(id));
                if (!user) {
                    return;
                }
                window.dispatchEvent(new CustomEvent('console:confirm', {
                    detail: {
                        title: 'Delete user',
                        message: `Delete ${user.username || user.email}? This action cannot be undone.`,
                        confirmLabel: 'Delete',
                        cancelLabel: 'Cancel',
                        destructive: true,
                        onConfirm: () => this.performDeleteUser(id),
                    },
                }));
            },
            async performDeleteUser(id) {
                if (!this.ensureCanManageUsers(true)) {
                    return;
                }
                this.userProcessing.delete = id;
                this.userError = null;
                try {
                    const response = await fetch(this.userDetailEndpoint(id), {
                        method: 'DELETE',
                        headers: {
                            Accept: 'application/json',
                        },
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to delete user');
                    }
                    this.$dispatch('toast', {
                        title: 'Deleted',
                        message: 'User removed successfully.',
                    });
                    if (String(this.selectedUserId) === String(id)) {
                        this.selectedUserId = '';
                    }
                    await this.fetchUsers();
                } catch (err) {
                    console.error(err);
                    this.userError = err.message || 'Failed to delete user';
                    this.$dispatch('toast', {
                        title: 'Delete failed',
                        message: this.userError,
                    });
                } finally {
                    this.userProcessing.delete = null;
                }
            },
            generateId(prefix = 'id') {
                if (typeof window !== 'undefined' && window.crypto && typeof window.crypto.randomUUID === 'function') {
                    return `${prefix}-${window.crypto.randomUUID()}`;
                }
                return `${prefix}-${Date.now().toString(36)}-${Math.random().toString(16).slice(2, 8)}`;
            },
            operationDisabled(action) {
                if (!action) {
                    return true;
                }
                if (action.id === 'reload-acl') {
                    return !this.acl.reload_supported || this.aclReloading || this.aclReloadModal.open;
                }
                if (action.id === 'reload-app') {
                    return this.appReloading || this.appReloadModal.open;
                }
                return false;
            },
            operationButtonLabel(action) {
                if (!action) {
                    return 'Run action';
                }
                if (action.id === 'reload-acl') {
                    if (!this.acl.reload_supported) {
                        return 'Proxy offline';
                    }
                    if (this.aclReloading) {
                        return 'Reloading...';
                    }
                    if (this.aclReloadModal.open) {
                        return 'Confirming...';
                    }
                    return 'Run action';
                }
                if (action.id === 'reload-app') {
                    return this.appReloading ? 'Reloading...' : 'Run action';
                }
                return 'Run action';
            },
            async triggerOperation(action) {
                if (!action) {
                    return;
                }
                if (action.id === 'reload-acl') {
                    this.showAclReloadModal(action);
                    return;
                }
                if (action.id === 'reload-app') {
                    this.showReloadModal(action);
                    return;
                }
                const timestamp = new Date().toLocaleTimeString();
                this.lastOperation = {
                    label: action.label,
                    timestamp,
                    status: 'Operation acknowledged (no handler configured).',
                };
                this.$dispatch('toast', {
                    title: 'Operation queued',
                    message: `${action.label || 'Operation'} acknowledged.`,
                });
            },
            showAclReloadModal(action) {
                this.resetAclReloadModal();
                this.aclReloadModal.open = true;
                this.aclReloadModal.action = action;
            },
            closeAclReloadModal() {
                if (this.aclReloading) {
                    return;
                }
                this.aclReloadModal.open = false;
            },
            resetAclReloadModal() {
                this.aclReloadModal = {
                    open: false,
                    status: 'idle',
                    error: null,
                    message: '',
                    action: null,
                };
            },
            get aclReloadStatusLabel() {
                switch (this.aclReloadModal.status) {
                    case 'running':
                        return 'Reload in progress…';
                    case 'success':
                        return 'Rules refreshed successfully';
                    case 'error':
                        return 'Reload request failed';
                    default:
                        return 'Awaiting confirmation';
                }
            },
            async startAclReload() {
                if (this.aclReloading || this.aclReloadModal.status === 'running') {
                    return;
                }
                this.aclReloadModal.status = 'running';
                this.aclReloadModal.error = null;
                this.aclReloadModal.message = '';
                await this.reloadAcl();
            },
            async reloadAcl() {
                if (!this.acl.reload_supported) {
                    this.$dispatch('toast', {
                        title: 'Not available',
                        message: 'ACL reload is only available while the SIP proxy is running.',
                    });
                    if (this.aclReloadModal.open) {
                        this.aclReloadModal.status = 'error';
                        this.aclReloadModal.error = 'SIP proxy is offline. Reload unavailable.';
                    }
                    return;
                }
                if (this.aclReloading) {
                    return;
                }
                this.aclReloading = true;
                try {
                    if (this.aclReloadModal.open && this.aclReloadModal.status !== 'running') {
                        this.aclReloadModal.status = 'running';
                        this.aclReloadModal.error = null;
                        this.aclReloadModal.message = '';
                    }
                    const endpoint = `${this.amiEndpoint.replace(/\/$/, '')}/reload/acl`;
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            Accept: 'application/json',
                        },
                        credentials: 'include',
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to reload ACL rules');
                    }
                    if (Array.isArray(data?.active_rules)) {
                        this.acl.active_rules = data.active_rules;
                    }
                    if (data?.metrics) {
                        this.acl.metrics = data.metrics;
                    }
                    this.security.acl_rules = this.formatAclRules(this.acl.active_rules);
                    const total = Number.isFinite(Number(data?.acl_rules_reloaded))
                        ? Number(data.acl_rules_reloaded)
                        : (data?.metrics?.total ?? this.acl.active_rules.length);
                    const durationText = this.formatDuration(data?.metrics?.duration_ms);
                    const message = durationText
                        ? `Loaded ${total} rule${total === 1 ? '' : 's'} in ${durationText}.`
                        : `Loaded ${total} rule${total === 1 ? '' : 's'}.`;
                    this.$dispatch('toast', {
                        title: 'ACL reloaded',
                        message,
                    });
                    if (this.aclReloadModal.open) {
                        this.aclReloadModal.status = 'success';
                        this.aclReloadModal.error = null;
                        this.aclReloadModal.message = message;
                    }
                    this.lastOperation = {
                        label: 'Reload ACL rules',
                        timestamp: new Date().toLocaleString(),
                        status: message,
                    };
                } catch (err) {
                    if (this.aclReloadModal.open) {
                        this.aclReloadModal.status = 'error';
                        this.aclReloadModal.error = err?.message || 'Unable to reload ACL rules.';
                        this.aclReloadModal.message = '';
                    }
                    this.$dispatch('toast', {
                        title: 'Reload failed',
                        message: err?.message || 'Unable to reload ACL rules.',
                    });
                } finally {
                    this.aclReloading = false;
                }
            },
            showReloadModal(action) {
                this.resetReloadModal();
                this.appReloadModal.open = true;
                this.appReloadModal.action = action;
                this.appReloadModal.mode = 'reload';
                this.appReloadModal.checks = this.buildReloadChecklist();
            },
            closeReloadModal() {
                if (this.appReloading) {
                    return;
                }
                this.appReloadModal.open = false;
            },
            resetReloadModal() {
                this.appReloadModal = {
                    open: false,
                    status: 'idle',
                    error: null,
                    message: '',
                    action: null,
                    mode: 'reload',
                    checks: [],
                };
            },
            buildReloadChecklist() {
                return [
                    {
                        id: 'config-parse',
                        label: 'Load configuration file',
                        hint: 'Ensure the TOML file is parseable and present.',
                        status: 'pending',
                    },
                    {
                        id: 'console-enabled',
                        label: 'Console availability',
                        hint: 'Console must stay enabled to manage reloads.',
                        status: 'pending',
                    },
                    {
                        id: 'ports-available',
                        label: 'Port availability',
                        hint: 'New bindings must be free before restart.',
                        status: 'pending',
                    },
                    {
                        id: 'restart-services',
                        label: 'Restart services',
                        hint: 'Stop running services and relaunch with new config.',
                        status: 'pending',
                    },
                ];
            },
            reloadCheckIndicatorClass(status) {
                switch (status) {
                    case 'success':
                        return 'bg-emerald-500';
                    case 'running':
                        return 'bg-sky-400 animate-pulse';
                    case 'error':
                        return 'bg-rose-500';
                    default:
                        return 'bg-slate-300';
                }
            },
            reloadCheckStatusClass(status) {
                switch (status) {
                    case 'success':
                        return 'text-emerald-600';
                    case 'running':
                        return 'text-sky-600';
                    case 'error':
                        return 'text-rose-600';
                    default:
                        return 'text-slate-400';
                }
            },
            reloadCheckStatusLabel(status) {
                switch (status) {
                    case 'success':
                        return 'Done';
                    case 'running':
                        return 'Running';
                    case 'error':
                        return 'Failed';
                    default:
                        return 'Pending';
                }
            },
            get reloadStatusLabel() {
                const mode = this.appReloadModal.mode || 'reload';
                switch (this.appReloadModal.status) {
                    case 'running':
                        return mode === 'check' ? 'Validating configuration…' : 'Running preflight checks…';
                    case 'success':
                        return mode === 'check'
                            ? 'Configuration valid. Ready to reload.'
                            : 'Reload succeeded. Services restarting…';
                    case 'error':
                        return mode === 'check'
                            ? 'Validation failed. Review configuration.'
                            : 'Reload request failed.';
                    default:
                        return 'Awaiting confirmation';
                }
            },
            get reloadConfirmLabel() {
                if (this.appReloadModal.mode === 'check') {
                    if (this.appReloadModal.status === 'success') {
                        return 'Reload now';
                    }
                    return 'Confirm reload';
                }
                return this.appReloadModal.status === 'error' ? 'Retry reload' : 'Confirm reload';
            },
            markCheck(id, status, detail = null) {
                this.appReloadModal.checks = this.appReloadModal.checks.map((item) =>
                    item.id === id ? { ...item, status, detail: detail || item.detail } : item
                );
            },
            async startReloadApplication() {
                if (this.appReloading || this.appReloadModal.status === 'running') {
                    return;
                }
                await this.performReload({ checkOnly: false });
            },
            async startReloadCheck() {
                if (this.appReloading || this.appReloadModal.status === 'running') {
                    return;
                }
                await this.performReload({ checkOnly: true });
            },
            async performReload({ checkOnly = false } = {}) {
                const action = this.appReloadModal.action || {};
                const baseEndpoint = action.endpoint || `${this.amiEndpoint.replace(/\/$/, '')}/reload/app`;
                const method = action.method || 'POST';
                let endpoint = baseEndpoint;
                if (checkOnly) {
                    const separator = endpoint.includes('?') ? '&' : '?';
                    endpoint = `${endpoint}${separator}mode=check`;
                }

                this.appReloading = true;
                this.appReloadModal.mode = checkOnly ? 'check' : 'reload';
                this.appReloadModal.status = 'running';
                this.appReloadModal.error = null;
                this.appReloadModal.message = checkOnly ? 'Validating configuration…' : '';
                this.markCheck('config-parse', 'running');
                this.markCheck('console-enabled', 'pending');
                this.markCheck('ports-available', 'pending');
                this.markCheck('restart-services', 'pending');

                try {
                    const response = await fetch(endpoint, {
                        method,
                        headers: {
                            Accept: 'application/json',
                        },
                        credentials: 'include',
                    });
                    const data = await response.json().catch(() => ({}));

                    if (!response.ok) {
                        const message = this.handleReloadErrors(data);
                        throw new Error(message);
                    }

                    this.markCheck('config-parse', 'success');
                    this.markCheck('console-enabled', 'success');
                    this.markCheck('ports-available', 'success');

                    if (checkOnly) {
                        this.markCheck('restart-services', 'success', 'Ready to restart once you confirm reload.');
                        const message = data?.message || 'Configuration validated. Services not restarted.';
                        this.appReloadModal.status = 'success';
                        this.appReloadModal.message = message;
                        this.$dispatch('toast', {
                            title: 'Configuration valid',
                            message,
                        });
                        this.lastOperation = {
                            label: 'Check',
                            timestamp: new Date().toLocaleString(),
                            status: message,
                        };
                        return;
                    }

                    this.markCheck('restart-services', 'running');
                    this.markCheck('restart-services', 'success');
                    const message = data?.message || 'Configuration validated. Services will restart automatically.';
                    this.appReloadModal.status = 'success';
                    this.appReloadModal.message = message;
                    this.$dispatch('toast', {
                        title: 'Reloading',
                        message,
                    });
                    this.lastOperation = {
                        label: action.label || 'Reload application',
                        timestamp: new Date().toLocaleString(),
                        status: 'Restart scheduled. Waiting for services to return…',
                    };
                    window.setTimeout(() => {
                        window.location.reload();
                    }, 2500);
                } catch (err) {
                    const fallback = checkOnly ? 'Unable to validate configuration.' : 'Unable to reload application.';
                    const message = err?.message || fallback;
                    this.appReloadModal.status = 'error';
                    this.appReloadModal.error = message;
                    this.appReloadModal.message = '';
                    this.$dispatch('toast', {
                        title: checkOnly ? 'Validation failed' : 'Reload failed',
                        message,
                    });
                    this.lastOperation = {
                        label: checkOnly ? 'Check' : (action.label || 'Reload'),
                        timestamp: new Date().toLocaleString(),
                        status: message,
                    };
                } finally {
                    this.appReloading = false;
                }
            },
            handleReloadErrors(payload) {
                const errors = Array.isArray(payload?.errors) ? payload.errors : [];
                let message = this.formatOperationError(payload);
                if (!errors.length) {
                    this.markCheck('config-parse', 'error', message);
                    return message;
                }

                const lowered = (value) => (value || '').toString().toLowerCase();
                let consoleSet = false;
                let portsSet = false;
                let configSet = false;
                for (const issue of errors) {
                    const field = lowered(issue.field);
                    const detail = issue.message || message;
                    if (field.includes('console')) {
                        this.markCheck('console-enabled', 'error', detail);
                        consoleSet = true;
                    } else if (field.includes('port') || field.includes('addr') || field.includes('http')) {
                        this.markCheck('ports-available', 'error', detail);
                        portsSet = true;
                    } else if (field.includes('config')) {
                        this.markCheck('config-parse', 'error', detail);
                        configSet = true;
                    }
                }

                if (!configSet) {
                    this.markCheck('config-parse', 'success');
                }
                if (!consoleSet) {
                    this.markCheck('console-enabled', 'success');
                }
                if (!portsSet) {
                    this.markCheck('ports-available', 'success');
                }

                this.markCheck('restart-services', 'error', message);
                return message;
            },
            formatAclRules(rules) {
                if (!Array.isArray(rules) || !rules.length) {
                    return 'allow all';
                }
                return rules.join('\n');
            },
            formatOperationError(payload) {
                if (!payload || typeof payload !== 'object') {
                    return 'Request failed.';
                }
                if (Array.isArray(payload.errors) && payload.errors.length) {
                    return payload.errors
                        .map((item) => {
                            if (!item || typeof item !== 'object') {
                                return String(item);
                            }
                            const field = item.field ? `${item.field}: ` : '';
                            return `${field}${item.message || 'Invalid configuration'}`;
                        })
                        .join('; ');
                }
                return payload.message || payload.error || 'Request failed.';
            },
            keyConfigRows() {
                const items = Array.isArray(this.configMeta?.key_items) ? this.configMeta.key_items : [];
                return items.map((item) => {
                    const label = item?.label || '—';
                    const rawValue = item?.value;
                    const value = rawValue === undefined || rawValue === null
                        ? '—'
                        : (typeof rawValue === 'string' ? rawValue : JSON.stringify(rawValue));
                    const hint = item?.hint || null;
                    return { label, value, hint };
                });
            },
            displayMetric(value) {
                return value === undefined || value === null ? '—' : value;
            },
            formatDuration(milliseconds) {
                const value = Number(milliseconds);
                if (!Number.isFinite(value) || value < 0) {
                    return null;
                }
                if (value >= 1000) {
                    const seconds = value / 1000;
                    if (seconds >= 10) {
                        return `${Math.round(seconds)}s`;
                    }
                    return `${seconds.toFixed(1)}s`;
                }
                return `${Math.round(value)}ms`;
            },
            initPlatformDraft() {
                const rtp = this.proxyConfig?.rtp || {};
                const toStringOrEmpty = (value) => (value === undefined || value === null || value === ''
                    ? ''
                    : String(value));
                this.platformDraft = {
                    log_level: this.platform?.log_level || '',
                    log_file: this.platform?.log_file || '',
                    external_ip: rtp?.external_ip || '',
                    rtp_start_port: toStringOrEmpty(rtp?.start_port),
                    rtp_end_port: toStringOrEmpty(rtp?.end_port),
                };
            },
            initProxyDraft() {
                const proxy = this.proxyConfig || {};
                this.proxyDraft = {
                    realms: (proxy.realms || []).join('\n'),
                    locator_webhook: {
                        url: proxy.locator_webhook?.url || '',
                        timeout_ms: proxy.locator_webhook?.timeout_ms || '',
                        headers: this.formatHeaders(proxy.locator_webhook?.headers),
                    },
                    http_router: {
                        url: proxy.http_router?.url || '',
                        timeout_ms: proxy.http_router?.timeout_ms || '',
                        headers: this.formatHeaders(proxy.http_router?.headers),
                    },
                    user_backends: JSON.parse(JSON.stringify(proxy.user_backends || [])),
                };
            },
            resetProxyDraft() {
                this.initProxyDraft();
            },
            addUserBackend(type) {
                const backend = { type };
                if (type === 'memory') backend.users = [];
                else if (type === 'http') { backend.url = ''; backend.method = 'GET'; }
                else if (type === 'database') { backend.url = ''; }
                else if (type === 'plain') { backend.path = ''; }
                else if (type === 'extension') { backend.database_url = ''; }
                this.proxyDraft.user_backends.push(backend);
            },
            removeUserBackend(index) {
                this.proxyDraft.user_backends.splice(index, 1);
            },
            async saveProxySettings() {
                if (this.proxyProcessing) return;
                const body = {
                    realms: this.listFromTextarea(this.proxyDraft.realms),
                    user_backends: this.proxyDraft.user_backends,
                };

                if (this.proxyDraft.locator_webhook.url) {
                    body.locator_webhook = {
                        url: this.proxyDraft.locator_webhook.url,
                        timeout_ms: this.normalizeOptionalNumber(this.proxyDraft.locator_webhook.timeout_ms),
                        headers: this.parseHeaders(this.proxyDraft.locator_webhook.headers),
                    };
                }

                if (this.proxyDraft.http_router.url) {
                    body.http_router = {
                        url: this.proxyDraft.http_router.url,
                        timeout_ms: this.normalizeOptionalNumber(this.proxyDraft.http_router.timeout_ms),
                        headers: this.parseHeaders(this.proxyDraft.http_router.headers),
                    };
                }

                this.proxyProcessing = true;
                try {
                    const response = await fetch(`${this.basePath}/settings/config/proxy`, {
                        method: 'PATCH',
                        headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body),
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data?.message || 'Failed to update proxy settings');
                    this.$dispatch('toast', { title: 'Settings saved', message: data.message });
                    this.proxyConfig.realms = body.realms;
                    this.proxyConfig.user_backends = body.user_backends;
                    this.proxyConfig.locator_webhook = body.locator_webhook;
                    this.proxyConfig.http_router = body.http_router;
                    this.initProxyDraft();
                } catch (err) {
                    console.error(err);
                    this.$dispatch('toast', { title: 'Update failed', message: err.message });
                } finally {
                    this.proxyProcessing = false;
                }
            },
            async testLocatorWebhook() {
                const draft = this.proxyDraft.locator_webhook;
                if (!draft.url) return;
                this.proxyProcessing = true;
                try {
                    const response = await fetch(`${this.basePath}/settings/config/proxy/locator-webhook/test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: draft.url, headers: this.parseHeaders(draft.headers) }),
                    });
                    const data = await response.json();
                    this.$dispatch('toast', { title: response.ok ? 'Success' : 'Failed', message: data.message });
                } catch (err) {
                    this.$dispatch('toast', { title: 'Test failed', message: err.message });
                } finally {
                    this.proxyProcessing = false;
                }
            },
            async testHttpRouter() {
                const draft = this.proxyDraft.http_router;
                if (!draft.url) return;
                this.proxyProcessing = true;
                try {
                    const response = await fetch(`${this.basePath}/settings/config/proxy/http-router/test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: draft.url, headers: this.parseHeaders(draft.headers) }),
                    });
                    const data = await response.json();
                    this.$dispatch('toast', { title: response.ok ? 'Success' : 'Failed', message: data.message });
                } catch (err) {
                    this.$dispatch('toast', { title: 'Test failed', message: err.message });
                } finally {
                    this.proxyProcessing = false;
                }
            },
            async testUserBackend(index) {
                const backend = this.proxyDraft.user_backends[index];
                this.proxyProcessing = true;
                try {
                    const response = await fetch(`${this.basePath}/settings/config/proxy/user-backend/test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ backend }),
                    });
                    const data = await response.json();
                    this.$dispatch('toast', { title: response.ok ? 'Success' : 'Failed', message: data.message });
                } catch (err) {
                    this.$dispatch('toast', { title: 'Test failed', message: err.message });
                } finally {
                    this.proxyProcessing = false;
                }
            },
            parseHeaders(text) {
                const headers = {};
                (text || '').split('\n').forEach(line => {
                    const idx = line.indexOf(':');
                    if (idx > 0) {
                        const key = line.substring(0, idx).trim();
                        const val = line.substring(idx + 1).trim();
                        if (key && val) headers[key] = val;
                    }
                });
                return Object.keys(headers).length ? headers : null;
            },
            formatHeaders(headers) {
                if (!headers || typeof headers !== 'object') return '';
                return Object.entries(headers).map(([k, v]) => `${k}: ${v}`).join('\n');
            },
            resetPlatformDraft() {
                this.initPlatformDraft();
            },
            parsePortValue(value) {
                const trimmed = String(value ?? '').trim();
                if (!trimmed.length) {
                    return null;
                }
                const parsed = Number.parseInt(trimmed, 10);
                if (!Number.isInteger(parsed) || parsed <= 0 || parsed > 65535) {
                    return undefined;
                }
                return parsed;
            },
            async savePlatformSettings() {
                if (this.platformProcessing) {
                    return;
                }
                const startPortValue = this.parsePortValue(this.platformDraft.rtp_start_port);
                if (startPortValue === undefined) {
                    this.$dispatch('toast', {
                        title: 'Invalid value',
                        message: 'Start port must be a number between 1 and 65535.',
                    });
                    return;
                }
                const endPortValue = this.parsePortValue(this.platformDraft.rtp_end_port);
                if (endPortValue === undefined) {
                    this.$dispatch('toast', {
                        title: 'Invalid value',
                        message: 'End port must be a number between 1 and 65535.',
                    });
                    return;
                }
                if (startPortValue !== null && endPortValue !== null && startPortValue > endPortValue) {
                    this.$dispatch('toast', {
                        title: 'Invalid range',
                        message: 'Start port must be less than or equal to end port.',
                    });
                    return;
                }
                const body = {
                    log_level: this.normalizeOptionalString(this.platformDraft.log_level),
                    log_file: this.normalizeOptionalString(this.platformDraft.log_file),
                    external_ip: this.normalizeOptionalString(this.platformDraft.external_ip),
                    rtp_start_port: startPortValue,
                    rtp_end_port: endPortValue,
                };
                this.platformProcessing = true;
                try {
                    const response = await fetch(`${this.basePath}/settings/config/platform`, {
                        method: 'PATCH',
                        headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body),
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to update platform settings');
                    }
                    this.platform.log_level = data?.platform?.log_level ?? null;
                    this.platform.log_file = data?.platform?.log_file ?? null;
                    const rtp = data?.rtp || {};
                    if (!this.proxyConfig.rtp || typeof this.proxyConfig.rtp !== 'object') {
                        this.proxyConfig.rtp = {};
                    }
                    this.proxyConfig.rtp.external_ip = rtp.external_ip ?? null;
                    this.proxyConfig.rtp.start_port = rtp.start_port ?? null;
                    this.proxyConfig.rtp.end_port = rtp.end_port ?? null;
                    this.initPlatformDraft();
                    this.$dispatch('toast', {
                        title: 'Settings saved',
                        message: data?.message || 'Platform settings saved. Restart required to apply.',
                    });
                    this.lastOperation = {
                        label: 'Platform settings',
                        timestamp: new Date().toLocaleString(),
                        status: 'Saved. Restart required.',
                    };
                } catch (err) {
                    console.error(err);
                    this.$dispatch('toast', {
                        title: 'Update failed',
                        message: err?.message || 'Unable to update platform settings.',
                    });
                } finally {
                    this.platformProcessing = false;
                }
            },
            initStorageDraft() {
                const meta = this.server?.storage || {};
                const recorderPath = meta?.recorder_path || '';
                const recorderFormat = (meta?.recorder_format || 'wav').toString();
                const mediaCache = meta?.media_cache_path || '';

                let callrecordRoot = '';
                const callrecordProfile = (this.storageProfiles || []).find((profile) => String(profile?.id || '').startsWith('callrecord'));
                if (callrecordProfile && callrecordProfile.config && callrecordProfile.config.root) {
                    callrecordRoot = callrecordProfile.config.root;
                }

                const recording = meta?.recording || this.recordingPolicy || {};
                const normalizeList = (list) => Array.isArray(list) ? list.join('\n') : '';
                const directionList = Array.isArray(recording?.directions)
                    ? recording.directions.map((d) => String(d || '').toLowerCase())
                    : null;
                const directionDefault = directionList === null;
                const directionInbound = directionDefault ? true : directionList.includes('inbound');
                const directionOutbound = directionDefault ? true : directionList.includes('outbound');
                const directionInternal = directionDefault ? true : directionList.includes('internal');
                this.storageDraft = {
                    recorder_path: recorderPath,
                    recorder_format: recorderFormat || 'wav',
                    media_cache_path: mediaCache,
                    callrecord_root: callrecordRoot || '',
                    recording_enabled: !!recording?.enabled,
                    recording_auto_start: recording?.auto_start !== undefined ? !!recording.auto_start : true,
                    recording_direction_inbound: directionInbound,
                    recording_direction_outbound: directionOutbound,
                    recording_direction_internal: directionInternal,
                    recording_caller_allow: normalizeList(recording?.caller_allow),
                    recording_caller_deny: normalizeList(recording?.caller_deny),
                    recording_callee_allow: normalizeList(recording?.callee_allow),
                    recording_callee_deny: normalizeList(recording?.callee_deny),
                    recording_samplerate: recording?.samplerate ? String(recording.samplerate) : '',
                    recording_ptime: recording?.ptime ? String(recording.ptime) : '',
                    recording_filename_pattern: recording?.filename_pattern || '',
                };
            },
            resetStorageDraft() {
                this.initStorageDraft();
            },
            async saveStorageSettings() {
                if (this.storageProcessing) {
                    return;
                }
                let recorderFormat = this.normalizeOptionalString(this.storageDraft.recorder_format);
                if (recorderFormat) {
                    recorderFormat = recorderFormat.toLowerCase();
                    if (recorderFormat !== 'wav' && recorderFormat !== 'ogg') {
                        this.$dispatch('toast', {
                            title: 'Invalid value',
                            message: 'Recorder format must be "wav" or "ogg".',
                        });
                        return;
                    }
                }
                let callrecordPayload = null;
                const root = this.normalizeOptionalString(this.storageDraft.callrecord_root);
                if (root) {
                    callrecordPayload = { mode: 'local', root };
                }
                if (
                    this.storageDraft.recording_enabled &&
                    !(
                        this.storageDraft.recording_direction_inbound ||
                        this.storageDraft.recording_direction_outbound ||
                        this.storageDraft.recording_direction_internal
                    )
                ) {
                    this.$dispatch('toast', {
                        title: 'Select a direction',
                        message: 'Choose at least one call direction when recording is enabled.',
                    });
                    return;
                }
                const recordingDirections = [];
                if (this.storageDraft.recording_direction_inbound) {
                    recordingDirections.push('inbound');
                }
                if (this.storageDraft.recording_direction_outbound) {
                    recordingDirections.push('outbound');
                }
                if (this.storageDraft.recording_direction_internal) {
                    recordingDirections.push('internal');
                }
                const recordingPayload = {
                    enabled: !!this.storageDraft.recording_enabled,
                    auto_start: !!this.storageDraft.recording_auto_start,
                    caller_allow: this.listFromTextarea(this.storageDraft.recording_caller_allow),
                    caller_deny: this.listFromTextarea(this.storageDraft.recording_caller_deny),
                    callee_allow: this.listFromTextarea(this.storageDraft.recording_callee_allow),
                    callee_deny: this.listFromTextarea(this.storageDraft.recording_callee_deny),
                    samplerate: this.normalizeOptionalNumber(this.storageDraft.recording_samplerate),
                    ptime: this.normalizeOptionalNumber(this.storageDraft.recording_ptime),
                    filename_pattern: this.normalizeOptionalString(this.storageDraft.recording_filename_pattern),
                };
                if (recordingDirections.length && recordingDirections.length < 3) {
                    recordingPayload.directions = recordingDirections;
                }
                const body = {
                    recorder_path: this.normalizeOptionalString(this.storageDraft.recorder_path),
                    media_cache_path: this.normalizeOptionalString(this.storageDraft.media_cache_path),
                    recorder_format: recorderFormat,
                    callrecord: callrecordPayload,
                    recording_policy: recordingPayload,
                };
                this.storageProcessing = true;
                try {
                    const response = await fetch(`${this.basePath}/settings/config/storage`, {
                        method: 'PATCH',
                        headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body),
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to update storage settings');
                    }
                    this.server.storage = data?.storage || {};
                    this.server.storage_profiles = Array.isArray(data?.storage_profiles) ? data.storage_profiles : [];
                    this.recordingPolicy = this.server.storage?.recording || null;
                    const storageMeta = this.server.storage || {};
                    this.selectedStorageProfile = storageMeta.active_profile || storageMeta.mode || (this.storageProfiles[0]?.id || '');
                    this.initStorageDraft();
                    this.$dispatch('toast', {
                        title: 'Settings saved',
                        message: data?.message || 'Storage settings saved. Restart required to apply.',
                    });
                    this.lastOperation = {
                        label: 'Storage settings',
                        timestamp: new Date().toLocaleString(),
                        status: 'Saved. Restart required.',
                    };
                } catch (err) {
                    console.error(err);
                    this.$dispatch('toast', {
                        title: 'Update failed',
                        message: err?.message || 'Unable to update storage settings.',
                    });
                } finally {
                    this.storageProcessing = false;
                }
            },
            async fetchSipFlowSettings() {
                try {
                    const response = await fetch(`${this.basePath}/sipflow/settings`, {
                        method: 'GET',
                        headers: {
                            Accept: 'application/json',
                        },
                    });
                    if (!response.ok) {
                        console.warn('Failed to fetch sipflow settings');
                        return;
                    }
                    const data = await response.json();
                    this.sipflowSettings = {
                        backend_type: data.backend_type || 'none',
                        config: data.config || {},
                    };
                    this.initSipFlowDraft();
                } catch (err) {
                    console.error('Error fetching sipflow settings:', err);
                }
            },
            initSipFlowDraft() {
                const config = this.sipflowSettings.config || {};
                const backendType = this.sipflowSettings.backend_type || 'none';

                this.sipflowDraft = {
                    backend_type: backendType,
                    // Dir backend
                    dir_root: backendType === 'dir' ? (config.root || '') : '',
                    dir_subdirs: backendType === 'dir' ? (config.subdirs || 'hourly') : 'hourly',
                    // Local backend
                    local_root: backendType === 'local' ? (config.root || '') : '',
                    local_flush_count: backendType === 'local' ? (config.flush_count || 1000) : 1000,
                    local_flush_interval_secs: backendType === 'local' ? (config.flush_interval_secs || 5) : 5,
                    // Remote backend
                    remote_udp_addr: backendType === 'remote' ? (config.udp_addr || '') : '',
                    remote_http_addr: backendType === 'remote' ? (config.http_addr || '') : '',
                    remote_timeout_secs: backendType === 'remote' ? (config.timeout_secs || 10) : 10,
                };
            },
            resetSipFlowDraft() {
                this.initSipFlowDraft();
            },
            async saveSipFlowSettings() {
                if (this.sipflowProcessing) {
                    return;
                }

                const backendType = this.sipflowDraft.backend_type || 'none';
                let config = {};

                if (backendType === 'dir') {
                    const root = (this.sipflowDraft.dir_root || '').trim();
                    if (!root) {
                        this.$dispatch('toast', {
                            title: 'Missing information',
                            message: 'Root directory is required for Dir backend.',
                        });
                        return;
                    }
                    config = {
                        root,
                        subdirs: this.sipflowDraft.dir_subdirs || 'hourly',
                    };
                } else if (backendType === 'local') {
                    const root = (this.sipflowDraft.local_root || '').trim();
                    if (!root) {
                        this.$dispatch('toast', {
                            title: 'Missing information',
                            message: 'Data directory is required for Local backend.',
                        });
                        return;
                    }
                    config = {
                        root,
                        flush_count: this.sipflowDraft.local_flush_count || 1000,
                        flush_interval_secs: this.sipflowDraft.local_flush_interval_secs || 5,
                    };
                } else if (backendType === 'remote') {
                    const udp_addr = (this.sipflowDraft.remote_udp_addr || '').trim();
                    const http_addr = (this.sipflowDraft.remote_http_addr || '').trim();
                    if (!udp_addr || !http_addr) {
                        this.$dispatch('toast', {
                            title: 'Missing information',
                            message: 'UDP and HTTP addresses are required for Remote backend.',
                        });
                        return;
                    }
                    config = {
                        udp_addr,
                        http_addr,
                        timeout_secs: this.sipflowDraft.remote_timeout_secs || 10,
                    };
                }

                const body = {
                    enabled: backendType !== 'none',
                    backend_type: backendType,
                    config,
                };

                this.sipflowProcessing = true;
                try {
                    const response = await fetch(`${this.basePath}/sipflow/settings`, {
                        method: 'PUT',
                        headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body),
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || data?.error || 'Failed to update SipFlow settings');
                    }

                    this.sipflowSettings = {
                        backend_type: backendType,
                        config,
                    };

                    this.$dispatch('toast', {
                        title: 'Settings saved',
                        message: data?.message || 'SipFlow settings saved. Restart required to apply.',
                    });

                    this.lastOperation = {
                        label: 'SipFlow settings',
                        timestamp: new Date().toLocaleString(),
                        status: 'Saved. Restart required.',
                    };
                } catch (err) {
                    console.error(err);
                    this.$dispatch('toast', {
                        title: 'Update failed',
                        message: err?.message || 'Unable to update SipFlow settings.',
                    });
                } finally {
                    this.sipflowProcessing = false;
                }
            },
            async testStorageConnection() {
                if (this.storageProcessing) {
                    return;
                }
                const vendor = this.normalizeOptionalString(this.storageDraft.callrecord_s3_vendor);
                const bucket = this.normalizeOptionalString(this.storageDraft.callrecord_s3_bucket);
                const region = this.normalizeOptionalString(this.storageDraft.callrecord_s3_region);
                const access_key = this.normalizeOptionalString(this.storageDraft.callrecord_s3_access_key);
                const secret_key = this.normalizeOptionalString(this.storageDraft.callrecord_s3_secret_key);
                const endpoint = this.normalizeOptionalString(this.storageDraft.callrecord_s3_endpoint);
                const root = this.normalizeOptionalString(this.storageDraft.callrecord_s3_root);

                if (!vendor || !bucket || !region || !access_key || !secret_key) {
                    this.$dispatch('toast', {
                        title: 'Missing information',
                        message: 'Vendor, bucket, region, access key, and secret key are required for S3 test.',
                    });
                    return;
                }

                const body = {
                    vendor,
                    bucket,
                    region,
                    access_key,
                    secret_key,
                    endpoint,
                    root,
                };

                this.storageProcessing = true;
                try {
                    const response = await fetch(`${this.basePath}/settings/config/storage/test`, {
                        method: 'POST',
                        headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body),
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Storage connection test failed');
                    }
                    this.$dispatch('toast', {
                        title: 'Connection successful',
                        message: data?.message || 'Successfully connected to storage, created and deleted a test file.',
                    });
                } catch (err) {
                    console.error(err);
                    this.$dispatch('toast', {
                        title: 'Test failed',
                        message: err?.message || 'Unable to connect to storage.',
                    });
                } finally {
                    this.storageProcessing = false;
                }
            },
            normalizeMultilineList(value) {
                if (value === undefined || value === null) {
                    return null;
                }
                const entries = String(value)
                    .split('\n')
                    .map((line) => line.trim())
                    .filter((line) => line.length);
                if (!entries.length) {
                    return null;
                }
                return entries.join('\n');
            },
            initSecurityDraft() {
                this.securityDraft.acl_rules = this.formatAclRules(this.acl.active_rules || []);
            },
            resetSecurityDraft() {
                this.initSecurityDraft();
            },
            async saveSecuritySettings() {
                if (this.securityProcessing) {
                    return;
                }
                const body = {
                    acl_rules: this.normalizeMultilineList(this.securityDraft.acl_rules),
                };
                this.securityProcessing = true;
                try {
                    const response = await fetch(`${this.basePath}/settings/config/security`, {
                        method: 'PATCH',
                        headers: {
                            Accept: 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body),
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to update security settings');
                    }
                    const acl_rules = Array.isArray(data?.security?.acl_rules) ? data.security.acl_rules : [];
                    this.acl.active_rules = acl_rules;
                    this.securityDraft.acl_rules = this.formatAclRules(this.acl.active_rules);
                    this.$dispatch('toast', {
                        title: 'Settings saved',
                        message: data?.message || 'Security settings saved. Restart required to apply.',
                    });
                    this.lastOperation = {
                        label: 'Security settings',
                        timestamp: new Date().toLocaleString(),
                        status: 'Saved. Restart required.',
                    };
                } catch (err) {
                    console.error(err);
                    this.$dispatch('toast', {
                        title: 'Update failed',
                        message: err?.message || 'Unable to update security settings.',
                    });
                } finally {
                    this.securityProcessing = false;
                }
            },
        }));
    });
</script>
{% endblock %}