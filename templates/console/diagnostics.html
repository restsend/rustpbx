{% extends "console/layout.html" %}
{% block title %}Testing · {{site_name|default('RustPBX')}}{% endblock %}
{% block content %}
<div class="p-6">
    <div class="mx-auto max-w-7xl space-y-6" x-data="testingConsole({{ test_data | escape }})">
        <header class="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
            <div class="space-y-1">
                <p class="text-xs font-semibold uppercase tracking-wide text-sky-600">Operational validation</p>
                <h1 class="text-2xl font-semibold text-slate-900">Testing & diagnostics</h1>
                <p class="text-sm text-slate-500">Verify trunk reachability, routing decisions, and place synthetic
                    calls without leaving the console.</p>
            </div>
            <div class="text-xs text-slate-500">
                Last audit:
                <span class="font-semibold text-slate-700" x-text="formatDateTime(lastAudit)"></span>
            </div>
        </header>

        <nav
            class="inline-flex rounded-lg border border-slate-200 bg-slate-50 p-1 text-xs font-semibold text-slate-600">
            <template x-for="tab in tabs" :key="tab.id">
                <button type="button" @click="activeTab = tab.id" class="rounded-md px-3 py-1.5 transition"
                    :class="activeTab === tab.id ? 'bg-white text-sky-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'">
                    <span x-text="tab.label"></span>
                </button>
            </template>
        </nav>

        <section x-show="activeTab === 'trunks'" x-cloak x-transition.opacity class="space-y-6">
            <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <div>
                        <h2 class="text-base font-semibold text-slate-900">Trunk health probes</h2>
                        <p class="text-xs text-slate-500">Send SIP OPTIONS or media loopback to validate reachability
                            and performance.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Simulated
                            mode</label>
                        <span
                            class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600">
                            <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                            Safe preview
                        </span>
                    </div>
                </div>

                <div class="mt-5 divide-y divide-slate-100">
                    <template x-for="trunk in trunks" :key="trunk.id">
                        <article class="py-4"
                            :class="testing.trunk === trunk.id ? 'md:pl-3 md:border-l-2 md:border-sky-200 md:bg-sky-50/40 rounded-lg' : ''">
                            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                                <div class="flex flex-col gap-2">
                                    <div class="flex flex-wrap items-center gap-2">
                                        <h3 class="text-sm font-semibold text-slate-900" x-text="trunk.label"></h3>
                                        <span
                                            class="rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-medium text-slate-600"
                                            x-text="trunk.id"></span>
                                        <span
                                            class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-semibold"
                                            :class="statusPill(trunk.status)">
                                            <span class="h-1.5 w-1.5 rounded-full"
                                                :class="statusDot(trunk.status)"></span>
                                            <span x-text="statusLabel(trunk.status)"></span>
                                        </span>
                                    </div>
                                    <div class="flex flex-wrap gap-4 text-xs text-slate-500">
                                        <div>
                                            <span class="font-semibold text-slate-700">Latency:</span>
                                            <span x-text="trunk.latency_ms + ' ms'"></span>
                                        </div>
                                        <div>
                                            <span class="font-semibold text-slate-700">Loss:</span>
                                            <span x-text="trunk.packet_loss_percent + '%' "></span>
                                        </div>
                                        <div>
                                            <span class="font-semibold text-slate-700">Concurrency:</span>
                                            <span
                                                x-text="trunk.concurrency.current + ' / ' + trunk.concurrency.limit"></span>
                                        </div>
                                        <div>
                                            <span class="font-semibold text-slate-700">Last probe:</span>
                                            <span x-text="formatDateTime(trunk.last_test_at)"></span>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap items-center gap-2 text-[11px] text-slate-500">
                                        <span class="rounded-full bg-slate-100 px-2 py-0.5 font-semibold text-slate-600"
                                            x-text="trunk.direction.join(' / ') || 'Unknown'"></span>
                                        <span x-text="trunk.egress"></span>
                                    </div>
                                    <p class="text-xs text-slate-500" x-text="trunk.notes"></p>
                                </div>
                                <div class="flex flex-col items-start gap-2 sm:flex-row sm:items-center">
                                    <button type="button" @click="runTrunkTest(trunk.id, 'options')"
                                        :disabled="testing.trunk === trunk.id && testing.state === 'running'"
                                        class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700 disabled:cursor-not-allowed disabled:opacity-60">
                                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                            stroke-width="1.8">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 4v12m6-6H4" />
                                        </svg>
                                        OPTIONS ping
                                    </button>
                                    <button type="button" @click="runTrunkTest(trunk.id, 'loopback')"
                                        :disabled="testing.trunk === trunk.id && testing.state === 'running'"
                                        class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 transition hover:border-emerald-300 hover:text-emerald-700 disabled:cursor-not-allowed disabled:opacity-60">
                                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                            stroke-width="1.8">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M5 10h10M10 5l5 5-5 5" />
                                        </svg>
                                        Media loopback
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3 text-xs" x-show="testing.trunk === trunk.id">
                                <template x-if="testing.state === 'running'">
                                    <div class="rounded-lg border border-sky-200 bg-sky-50 px-4 py-3 text-sky-700">
                                        Running <span class="font-semibold" x-text="testing.mode"></span> probe…
                                    </div>
                                </template>
                                <template x-if="testing.state === 'complete'">
                                    <div class="rounded-lg border px-4 py-3"
                                        :class="testing.success ? 'border-emerald-200 bg-emerald-50 text-emerald-700' : 'border-rose-200 bg-rose-50 text-rose-700'">
                                        <div class="flex items-center justify-between">
                                            <span class="font-semibold"
                                                x-text="testing.success ? 'Probe successful' : 'Probe reported issues'"></span>
                                            <span x-text="testing.completed_at"></span>
                                        </div>
                                        <p class="mt-1 text-xs" x-text="testing.message"></p>
                                    </div>
                                </template>
                            </div>
                        </article>
                    </template>
                </div>
            </div>
        </section>

        <section x-show="activeTab === 'routing'" x-cloak x-transition.opacity class="space-y-6">
            <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <div>
                        <h2 class="text-base font-semibold text-slate-900">Routing validation</h2>
                        <p class="text-xs text-slate-500">Predict how dialled numbers are normalised and which trunk or
                            route they match.</p>
                    </div>
                    <button type="button" @click="loadSampleRouting"
                        class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700">
                        Use sample
                    </button>
                </div>

                <form class="mt-4 grid gap-4 md:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]"
                    @submit.prevent="runRoutingCheck">
                    <label class="flex flex-col gap-2">
                        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Dialled number</span>
                        <input type="text" x-model.trim="routingInput"
                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                            placeholder="e.g. +14155550123">
                    </label>
                    <label class="flex flex-col gap-2">
                        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Direction</span>
                        <select x-model="routingDirection"
                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200">
                            <option value="outbound">Outbound</option>
                            <option value="inbound">Inbound</option>
                            <option value="internal">Internal</option>
                        </select>
                    </label>
                    <div class="md:col-span-2 flex flex-wrap items-center gap-3">
                        <button type="submit"
                            class="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2">
                            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                stroke-width="1.8">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10 4v12m6-6H4" />
                            </svg>
                            Evaluate
                        </button>
                        <template x-if="routingResult">
                            <div
                                class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-2 text-xs text-slate-600">
                                Matched <span class="font-semibold" x-text="routingResult.matched_route"></span>
                                → <span class="font-semibold" x-text="routingResult.selected_trunk"></span>
                                · <span x-text="routingResult.rewrites.join(', ') || 'no rewrite'"></span>
                            </div>
                        </template>
                        <template x-if="routingResult && routingResult.result === 'warning'">
                            <span
                                class="rounded-lg border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-semibold text-amber-700">
                                <svg class="mr-1 inline h-3 w-3" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                    stroke-width="1.8">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 4l6 12H4l6-12z" />
                                </svg>
                                Uses backup trunk
                            </span>
                        </template>
                    </div>
                </form>
            </div>

            <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                <h3 class="text-base font-semibold text-slate-900">Recent checks</h3>
                <div class="mt-4 grid gap-3 md:grid-cols-2">
                    <template x-for="item in routingChecks" :key="item.id">
                        <div class="rounded-lg border border-slate-200 bg-white p-3">
                            <div
                                class="flex items-center justify-between text-[11px] uppercase tracking-wide text-slate-400">
                                <span x-text="item.direction"></span>
                                <span x-text="item.latency_ms + ' ms'"></span>
                            </div>
                            <div class="mt-1 text-sm font-semibold text-slate-800" x-text="item.input"></div>
                            <div class="text-xs text-slate-500">Route → <span class="font-semibold"
                                    x-text="item.matched_route"></span></div>
                            <div class="text-xs text-slate-500">Trunk → <span class="font-semibold"
                                    x-text="item.selected_trunk"></span></div>
                            <div class="mt-2 inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-semibold"
                                :class="item.result === 'ok' ? 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200' : 'bg-amber-50 text-amber-600 ring-1 ring-amber-200'">
                                <span x-text="item.result === 'ok' ? 'Pass' : 'Warning'"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        <section x-show="activeTab === 'dialer'" x-cloak x-transition.opacity class="space-y-6">
            <div class="max-w-3xl rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                <h2 class="text-base font-semibold text-slate-900">Dial a synthetic call</h2>
                <p class="mt-1 text-xs text-slate-500">Place a controlled call to verify audio quality and queue
                    behaviour. Real signalling is skipped in preview mode.</p>
                <form class="mt-4 space-y-4" @submit.prevent="startDialTest">
                    <label class="flex flex-col gap-2">
                        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Source</span>
                        <select x-model="dial.source"
                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200">
                            <template x-for="item in dialer.source_options" :key="item">
                                <option :value="item" x-text="item"></option>
                            </template>
                        </select>
                    </label>
                    <label class="flex flex-col gap-2">
                        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Destination</span>
                        <div class="flex gap-2">
                            <input type="text" x-model.trim="dial.destination"
                                class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="Number or feature code">
                            <div class="relative" x-data="{ open: false }" @click.outside="open = false">
                                <button type="button" @click="open = !open"
                                    class="inline-flex h-10 w-10 items-center justify-center rounded-lg border border-slate-200 text-slate-500 transition hover:border-sky-300 hover:text-sky-700">
                                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 8l4 4 4-4" />
                                    </svg>
                                </button>
                                <div x-cloak x-show="open" x-transition.origin.top.right
                                    class="absolute right-0 z-20 mt-2 w-56 rounded-lg border border-slate-200 bg-white p-2 text-sm shadow-xl">
                                    <template x-for="sample in dialer.destination_samples" :key="sample.value">
                                        <button type="button" @click="dial.destination = sample.value; open = false"
                                            class="flex w-full flex-col gap-0.5 rounded-md px-2 py-1.5 text-left transition hover:bg-slate-100">
                                            <span class="text-xs font-semibold text-slate-600"
                                                x-text="sample.label"></span>
                                            <span class="font-mono text-xs text-slate-500" x-text="sample.value"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </label>
                    <label class="flex flex-col gap-2">
                        <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Preferred
                            trunk</span>
                        <select x-model="dial.trunk"
                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200">
                            <template x-for="option in dialer.trunk_options" :key="option.id">
                                <option :value="option.id" x-text="option.label"></option>
                            </template>
                        </select>
                    </label>
                    <button type="submit" :disabled="dialing"
                        class="inline-flex w-full items-center justify-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60">
                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 4h2l2 12h4l2-12h2" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 4L9 2h2l2 2" />
                        </svg>
                        Start test call
                    </button>
                </form>
                <div class="mt-4" x-show="dialResult">
                    <div class="rounded-lg border px-4 py-3 text-xs"
                        :class="dialResult.status === 'pass' ? 'border-emerald-200 bg-emerald-50 text-emerald-700' : 'border-rose-200 bg-rose-50 text-rose-700'">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold"
                                x-text="dialResult.status === 'pass' ? 'Simulation successful' : 'Simulation failed'"></span>
                            <span x-text="dialResult.timestamp"></span>
                        </div>
                        <p class="mt-1" x-text="dialResult.details"></p>
                    </div>
                </div>
            </div>
        </section>

        <section x-show="activeTab === 'history'" x-cloak x-transition.opacity class="space-y-6">
            <div class="max-w-3xl rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                <div class="flex items-center justify-between">
                    <h2 class="text-base font-semibold text-slate-900">Recent diagnostics</h2>
                    <button type="button" @click="clearHistory"
                        class="text-xs font-semibold text-slate-400 hover:text-rose-500">Clear</button>
                </div>
                <ul class="mt-4 space-y-3 text-xs text-slate-600">
                    <template x-for="item in history" :key="item.timestamp + item.subject">
                        <li class="rounded-lg border border-slate-200 px-3 py-2">
                            <div class="flex items-center justify-between">
                                <span
                                    class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-semibold"
                                    :class="historyPill(item.type)">
                                    <span x-text="historyLabel(item.type)"></span>
                                </span>
                                <span class="text-[11px] text-slate-400" x-text="formatDateTime(item.timestamp)"></span>
                            </div>
                            <div class="mt-1 font-semibold text-slate-800" x-text="item.subject"></div>
                            <p class="mt-1 text-[11px] text-slate-500" x-text="item.details"></p>
                        </li>
                    </template>
                    <template x-if="!history.length">
                        <li
                            class="rounded-lg border border-dashed border-slate-200 px-3 py-6 text-center text-slate-400">
                            No diagnostics recorded yet.
                        </li>
                    </template>
                </ul>
            </div>
        </section>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('testingConsole', (payload) => ({
            init() {
                const data = typeof payload === 'string' ? JSON.parse(payload || '{}') : (payload || {});
                this.lastAudit = data.last_audit || null;
                this.trunks = Array.isArray(data.trunks) ? data.trunks : [];
                this.routingChecks = Array.isArray(data.routing_checks) ? data.routing_checks : [];
                this.history = Array.isArray(data.recent_tests) ? data.recent_tests : [];
                this.dialer = data.dialer || { source_options: [], destination_samples: [], trunk_options: [] };
                this.dial.source = this.dialer.default_source || (this.dialer.source_options[0] || '');
                this.dial.trunk = this.dialer.trunk_options?.[0]?.id || '';
                this.dial.destination = this.dialer.destination_samples?.[0]?.value || '';
                this.routingInput = this.routingChecks?.[0]?.input || '';
                this.routingDirection = this.routingChecks?.[0]?.direction || 'outbound';
            },
            lastAudit: null,
            trunks: [],
            routingChecks: [],
            routingInput: '',
            routingDirection: 'outbound',
            routingResult: null,
            testing: { trunk: null, state: 'idle', success: false, message: '', mode: 'OPTIONS', completed_at: '' },
            history: [],
            dialer: {},
            dial: { source: '', destination: '', trunk: '' },
            dialing: false,
            dialResult: null,
            tabs: [
                { id: 'trunks', label: 'Trunks' },
                { id: 'routing', label: 'Routing' },
                { id: 'dialer', label: 'Dialer' },
                { id: 'history', label: 'History' },
            ],
            activeTab: 'trunks',
            get healthyTrunks() {
                return this.trunks.filter((item) => this.statusLabel(item.status) === 'Healthy').length;
            },
            get warningTrunks() {
                return this.trunks.filter((item) => this.statusLabel(item.status) !== 'Healthy').length;
            },
            get recentCall() {
                return this.history.find((item) => item.type === 'call') || null;
            },
            statusLabel(value) {
                switch ((value || '').toLowerCase()) {
                    case 'healthy':
                        return 'Healthy';
                    case 'warning':
                        return 'Warning';
                    case 'lab':
                        return 'Lab';
                    default:
                        return value || 'Unknown';
                }
            },
            statusPill(value) {
                const key = (value || '').toLowerCase();
                if (key === 'healthy') {
                    return 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200';
                }
                if (key === 'warning') {
                    return 'bg-amber-50 text-amber-600 ring-1 ring-amber-200';
                }
                if (key === 'lab') {
                    return 'bg-sky-50 text-sky-600 ring-1 ring-sky-200';
                }
                return 'bg-slate-100 text-slate-600 ring-1 ring-slate-200';
            },
            statusDot(value) {
                switch ((value || '').toLowerCase()) {
                    case 'healthy':
                        return 'bg-emerald-500';
                    case 'warning':
                        return 'bg-amber-500';
                    case 'lab':
                        return 'bg-sky-500';
                    default:
                        return 'bg-slate-400';
                }
            },
            runTrunkTest(trunkId, mode) {
                this.testing = {
                    trunk: trunkId,
                    state: 'running',
                    success: false,
                    message: '',
                    mode: mode.toUpperCase(),
                    completed_at: ''
                };
                window.setTimeout(() => {
                    const trunk = this.trunks.find((item) => item.id === trunkId) || {};
                    const success = mode === 'options' ? trunk.status !== 'lab' : trunk.packet_loss_percent < 2;
                    const message = success
                        ? `Round-trip ${Math.max(8, Math.round(trunk.latency_ms * (mode === 'loopback' ? 1.4 : 1)))} ms · loss ${trunk.packet_loss_percent}%`
                        : 'Probe reported elevated packet loss and jitter.';
                    const entry = {
                        timestamp: new Date().toISOString(),
                        type: 'trunk',
                        subject: `${trunk.label || trunkId} (${mode.toUpperCase()})`,
                        status: success ? 'pass' : 'fail',
                        details: message,
                    };
                    this.history = [entry, ...this.history].slice(0, 12);
                    this.testing = {
                        trunk: trunkId,
                        state: 'complete',
                        success,
                        message,
                        mode: mode.toUpperCase(),
                        completed_at: new Date().toLocaleTimeString(),
                    };
                }, 900);
            },
            loadSampleRouting() {
                if (!this.routingChecks.length) {
                    return;
                }
                const sample = this.routingChecks[0];
                this.routingInput = sample.input;
                this.routingDirection = sample.direction;
                this.routingResult = sample;
            },
            runRoutingCheck() {
                const lookup = this.routingChecks.find((item) => {
                    return item.input === this.routingInput && item.direction === this.routingDirection;
                });
                if (lookup) {
                    this.routingResult = lookup;
                } else {
                    const generated = {
                        id: `dynamic-${Math.random().toString(36).slice(2, 7)}`,
                        input: this.routingInput,
                        direction: this.routingDirection,
                        matched_route: 'Fallback-policy',
                        selected_trunk: this.trunks[0]?.id || 'default',
                        rewrites: ['no rewrite'],
                        result: 'ok',
                        latency_ms: 40,
                    };
                    this.routingChecks = [generated, ...this.routingChecks].slice(0, 8);
                    this.routingResult = generated;
                }
                const historyEntry = {
                    timestamp: new Date().toISOString(),
                    type: 'routing',
                    subject: this.routingInput || 'unknown dialled number',
                    status: 'pass',
                    details: `Matched route ${this.routingResult.matched_route} → ${this.routingResult.selected_trunk}`,
                };
                this.history = [historyEntry, ...this.history].slice(0, 12);
            },
            startDialTest() {
                if (!this.dial.destination) {
                    return;
                }
                this.dialing = true;
                this.dialResult = null;
                window.setTimeout(() => {
                    this.dialing = false;
                    const success = Math.random() > 0.15;
                    const detail = success
                        ? `Simulated ${this.dial.destination} via ${this.dial.trunk} · MOS 4.${Math.floor(Math.random() * 2) + 2}`
                        : 'Synthetic call reported 486 Busy Here (simulated).';
                    const entry = {
                        timestamp: new Date().toISOString(),
                        type: 'call',
                        subject: `${this.dial.source} → ${this.dial.destination}`,
                        status: success ? 'pass' : 'fail',
                        details: detail,
                    };
                    this.history = [entry, ...this.history].slice(0, 12);
                    this.dialResult = {
                        status: success ? 'pass' : 'fail',
                        details: detail,
                        timestamp: new Date().toLocaleTimeString(),
                    };
                }, 1100);
            },
            clearHistory() {
                this.history = [];
            },
            historyPill(kind) {
                const key = (kind || '').toLowerCase();
                if (key === 'trunk') {
                    return 'bg-sky-50 text-sky-600 ring-1 ring-sky-200';
                }
                if (key === 'routing') {
                    return 'bg-amber-50 text-amber-600 ring-1 ring-amber-200';
                }
                if (key === 'call') {
                    return 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200';
                }
                return 'bg-slate-100 text-slate-600 ring-1 ring-slate-200';
            },
            historyLabel(kind) {
                switch ((kind || '').toLowerCase()) {
                    case 'trunk':
                        return 'Trunk';
                    case 'routing':
                        return 'Routing';
                    case 'call':
                        return 'Call';
                    default:
                        return 'Log';
                }
            },
            formatDateTime(value) {
                if (!value) {
                    return '—';
                }
                try {
                    const date = new Date(value);
                    if (Number.isNaN(date.getTime())) {
                        return value;
                    }
                    return date.toLocaleString();
                } catch (err) {
                    return value;
                }
            },
        }));
    });
</script>
{% endblock %}