{% extends "console/layout.html" %}
{% block title %}Extensions Â· {{site_name|default('RustPBX')}}{% endblock %}
{% block content %}
<div class="p-6">
    <div class="mx-auto max-w-7xl space-y-6">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
            <div class="space-y-1">
                <p class="text-xs font-semibold uppercase tracking-wide text-sky-600">Directory management</p>
                <h1 class="text-2xl font-semibold text-slate-900">Extensions</h1>
                <p class="text-sm text-slate-500">Search, review, and manage every extension in your PBX.</p>
            </div>
            <div class="flex gap-3">
                <a href="{{ create_url }}"
                    class="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 4v12m6-6H4" />
                    </svg>
                    New extension
                </a>
            </div>
        </div>

        <div x-data='extensionFilters({{ filters | tojson }})'
            class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-black/5">
            <div class="flex flex-wrap items-center justify-between gap-3 text-xs">
                <div class="flex flex-wrap items-center gap-2">
                    <span class="rounded-full bg-slate-100 px-2 py-0.5 font-semibold text-slate-600"
                        x-text="activeFilters.length ? activeFilters.length + ' filters' : 'No filters'"></span>
                    <span class="text-slate-400" x-show="activeFilters.length" x-text="activeFiltersSummary()"></span>
                </div>
                <button type="button"
                    class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-1.5 font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700"
                    @click="reset()">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 3v14m-7-7h14" />
                    </svg>
                    Reset filters
                </button>
            </div>

            <div class="mt-3 grid gap-3 md:grid-cols-2 xl:grid-cols-4">
                <template x-for="option in availableFilters" :key="option.id">
                    <div class="flex flex-col gap-1">
                        <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-400"
                            x-text="option.label"></span>
                        <div class="relative" x-data="{ open: false }" @keydown.escape.window="open = false"
                            @click.outside="open = false">
                            <button type="button"
                                class="flex w-full items-center justify-between gap-2 rounded-lg border border-slate-200 px-3 py-2 text-sm font-medium transition hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2"
                                :class="isActive(option.id) ? 'bg-sky-50 border-sky-200 text-sky-700' : 'bg-white text-slate-600'"
                                @click="open = !open">
                                <span class="truncate" x-text="summaryFor(option)"></span>
                                <svg class="h-4 w-4 text-slate-400 transition-transform duration-150"
                                    :class="open ? 'rotate-180' : ''" viewBox="0 0 20 20" fill="none"
                                    stroke="currentColor" stroke-width="1.8">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 8l4 4 4-4" />
                                </svg>
                            </button>
                            <div x-cloak x-show="open" x-transition.origin.top.left
                                class="absolute z-20 mt-2 w-64 rounded-lg border border-slate-200 bg-white p-3 text-sm shadow-xl">
                                <template x-if="option.type === 'select'">
                                    <div class="space-y-2">
                                        <template x-for="choice in option.options" :key="choice.value">
                                            <label
                                                class="flex cursor-pointer items-center gap-2 rounded-md px-2 py-1.5 hover:bg-slate-100">
                                                <input type="checkbox"
                                                    class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-400"
                                                    :checked="isSelected(option.id, choice.value)"
                                                    @change="toggleSelectOption(option, choice.value, $event.target.checked)">
                                                <span x-text="choice.label"></span>
                                            </label>
                                        </template>
                                        <div class="flex justify-between gap-2 pt-2">
                                            <button type="button"
                                                class="w-full rounded-md border border-slate-200 px-2 py-1 text-xs font-medium text-slate-500 hover:bg-slate-50"
                                                @click="clearFilter(option); open = false">
                                                Clear
                                            </button>
                                            <button type="button"
                                                class="w-full rounded-md bg-sky-600 px-2 py-1 text-xs font-semibold text-white hover:bg-sky-500"
                                                @click="open = false">
                                                Done
                                            </button>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="option.type === 'single'">
                                    <div class="space-y-1">
                                        <template x-for="choice in option.options" :key="choice.value">
                                            <button type="button"
                                                class="flex w-full items-center justify-between rounded-md px-2 py-1.5 text-left hover:bg-slate-100"
                                                @click="selectSingleOption(option, choice.value); open = false">
                                                <span x-text="choice.label"></span>
                                                <svg x-show="isSingleSelected(option, choice.value)"
                                                    class="h-4 w-4 text-sky-500" viewBox="0 0 20 20" fill="none"
                                                    stroke="currentColor" stroke-width="1.8">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M5 10l3 3 7-7" />
                                                </svg>
                                            </button>
                                        </template>
                                        <div class="flex justify-between gap-2 pt-2">
                                            <button type="button"
                                                class="w-full rounded-md border border-slate-200 px-2 py-1 text-xs font-medium text-slate-500 hover:bg-slate-50"
                                                @click="clearFilter(option); open = false">
                                                Clear
                                            </button>
                                            <button type="button"
                                                class="w-full rounded-md bg-sky-600 px-2 py-1 text-xs font-semibold text-white hover:bg-sky-500"
                                                @click="open = false">
                                                Done
                                            </button>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="option.type === 'daterange'">
                                    <div class="space-y-3">
                                        <label class="block text-xs font-medium text-slate-500">
                                            Start date
                                            <input type="date"
                                                class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                :value="getActive(option.id)?.value?.start || ''"
                                                @input="updateRange(option, 'start', $event.target.value)">
                                        </label>
                                        <label class="block text-xs font-medium text-slate-500">
                                            End date
                                            <input type="date"
                                                class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                :value="getActive(option.id)?.value?.end || ''"
                                                @input="updateRange(option, 'end', $event.target.value)">
                                        </label>
                                        <div class="flex justify-between gap-2 pt-2">
                                            <button type="button"
                                                class="w-full rounded-md border border-slate-200 px-2 py-1 text-xs font-medium text-slate-500 hover:bg-slate-50"
                                                @click="clearFilter(option); open = false">
                                                Clear
                                            </button>
                                            <button type="button"
                                                class="w-full rounded-md bg-sky-600 px-2 py-1 text-xs font-semibold text-white hover:bg-sky-500"
                                                @click="open = false">
                                                Done
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <div class="mt-3 flex flex-wrap gap-2" x-show="activeFilters.length">
                <template x-for="filter in activeFilters" :key="filter.id">
                    <span
                        class="group inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-medium text-slate-600">
                        <span x-text="filter.label"></span>
                        <span class="text-slate-400" x-text="filterSummary(filter)"></span>
                        <button type="button"
                            class="rounded-full p-1 text-slate-400 transition hover:bg-slate-200 hover:text-slate-600"
                            @click="removeFilter(filter.id)">
                            <span class="sr-only">Remove filter</span>
                            <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l8 8M6 14l8-8" />
                            </svg>
                        </button>
                    </span>
                </template>
            </div>
            <p class="mt-3 text-xs text-slate-400" x-show="!activeFilters.length">No filters applied.</p>
        </div>
        <div class="overflow-hidden rounded-xl bg-white ring-1 ring-black/5">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 text-left text-sm">
                    <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500">
                        <tr>
                            <th scope="col" class="px-4 py-2">Extension</th>
                            <th scope="col" class="px-4 py-2">Department</th>
                            <th scope="col" class="px-4 py-2">Status</th>
                            <th scope="col" class="px-4 py-2">Enabled</th>
                            <th scope="col" class="px-4 py-2">Forwarding</th>
                            <th scope="col" class="px-4 py-2">Created</th>
                            <th scope="col" class="px-4 py-2">Registered</th>
                            <th scope="col" class="px-4 py-2">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 bg-white text-sm text-slate-600">
                        {% for extension in extensions %}
                        <tr class="hover:bg-slate-50">
                            <td class="whitespace-nowrap px-4 py-2">
                                <div class="font-medium text-slate-900">{{ extension.display_name | default('â') }}
                                </div>
                                <div class="text-xs text-slate-400">Ext {{ extension.extension }}</div>
                            </td>
                            <td class="whitespace-nowrap px-4 py-2">
                                {% if extension.department is string %}
                                <span
                                    class="mr-1 inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700 ring-1 ring-slate-200">{{
                                    extension.department }}</span>
                                {% elif extension.department %}
                                {% for dept in extension.department %}
                                <span
                                    class="mr-1 inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-700 ring-1 ring-slate-200">{{
                                    dept }}</span>
                                {% endfor %}
                                {% else %}
                                <span class="text-slate-400">â</span>
                                {% endif %}
                            </td>
                            <td class="whitespace-nowrap px-4 py-2">
                                <span
                                    class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-semibold {{ 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-100' if extension.status == 'Online' else ('bg-amber-50 text-amber-600 ring-1 ring-amber-100' if extension.status == 'Ringing' or extension.status == 'Idle' else 'bg-slate-100 text-slate-600 ring-1 ring-slate-200') }}">
                                    <span
                                        class="h-1.5 w-1.5 rounded-full {{ 'bg-emerald-400' if extension.status == 'Online' else ('bg-amber-400' if extension.status == 'Ringing' or extension.status == 'Idle' else 'bg-slate-400') }}"></span>
                                    {{ extension.status }}
                                </span>
                            </td>
                            <td class="whitespace-nowrap px-4 py-2">
                                {% if extension.login_allowed %}
                                <span
                                    class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2.5 py-0.5 text-xs font-medium text-emerald-600 ring-1 ring-emerald-100">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l4 4 6-8" />
                                    </svg>
                                    Enabled
                                </span>
                                {% else %}
                                <span
                                    class="inline-flex items-center gap-1 rounded-full bg-rose-50 px-2.5 py-0.5 text-xs font-medium text-rose-600 ring-1 ring-rose-100">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l8 8M6 14l8-8" />
                                    </svg>
                                    Disabled
                                </span>
                                {% endif %}
                            </td>
                            <td class="whitespace-nowrap px-4 py-2">
                                {% set mode = extension.call_forwarding_mode | default('none') %}
                                {% if mode != 'none' %}
                                <span
                                    class="inline-flex items-center gap-1 rounded-full bg-sky-50 px-2.5 py-0.5 text-xs font-medium text-sky-600 ring-1 ring-sky-100">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 5l6 5-6 5" />
                                    </svg>
                                    {% if mode == 'always' %}
                                    Always
                                    {% elif mode == 'when_busy' %}
                                    When busy
                                    {% elif mode == 'when_not_answered' %}
                                    When not answered
                                    {% else %}
                                    {{ mode }}
                                    {% endif %}
                                </span>
                                {% if extension.call_forwarding_destination %}
                                <div class="mt-1 max-w-[12rem] truncate text-xs text-slate-400"
                                    title="{{ extension.call_forwarding_destination }}">
                                    {{ extension.call_forwarding_destination }}
                                </div>
                                {% endif %}
                                {% else %}
                                <span
                                    class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-600 ring-1 ring-slate-200">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l8 8M6 14l8-8" />
                                    </svg>
                                    None
                                </span>
                                {% endif %}
                            </td>
                            <td class="whitespace-nowrap px-4 py-2 text-slate-500">{{ extension.created_at }}</td>
                            <td class="whitespace-nowrap px-4 py-2 text-slate-600">
                                {% if extension.registered_at %}
                                <div class="flex items-start gap-2">
                                    <span
                                        class="mt-0.5 inline-flex h-4 w-4 items-center justify-center rounded-full bg-emerald-100 text-emerald-600 ring-1 ring-emerald-200">
                                        <svg class="h-3 w-3" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l3 3 7-7" />
                                        </svg>
                                    </span>
                                    <div class="leading-tight">
                                        <div class="text-sm text-slate-700">{{ extension.registrar | default('Unknown
                                            device') }}</div>
                                        <div class="text-xs text-slate-400">{{ extension.registered_at }}</div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="flex items-center gap-2 text-slate-400">
                                    <span
                                        class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-slate-100 text-slate-500 ring-1 ring-slate-200">
                                        <svg class="h-3 w-3" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M6 6l8 8M6 14l8-8" />
                                        </svg>
                                    </span>
                                    <span class="text-xs">Not registered</span>
                                </div>
                                {% endif %}
                            </td>
                            <td class="px-4 py-2">
                                <div class="flex items-center gap-2">
                                    <a href="{{ extension.edit_url }}" title="Edit extension"
                                        class="inline-flex items-center justify-center rounded-full border border-slate-200 p-2 text-slate-500 transition hover:border-sky-300 hover:text-sky-600">
                                        <span class="sr-only">Edit</span>
                                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                            stroke-width="1.6">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M13.5 3.5l3 3-8 8H5.5v-3l8-8z" />
                                        </svg>
                                    </a>
                                    <a href="{{ extension.delete_url }}" title="Delete extension"
                                        class="inline-flex items-center justify-center rounded-full border border-slate-200 p-2 text-slate-500 transition hover:border-rose-300 hover:text-rose-600">
                                        <span class="sr-only">Delete</span>
                                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                            stroke-width="1.6">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M6 7h8m-7 0v8m3-8v8m3-8v8M4 7h12M8 4h4a1 1 0 011 1v2H7V5a1 1 0 011-1z" />
                                        </svg>
                                    </a>
                                    {% set toggle_label = 'Disable login' if extension.login_allowed else 'Enable login'
                                    %}
                                    <a href="{{ extension.toggle_url }}" title="{{ toggle_label }}"
                                        class="inline-flex items-center justify-center rounded-full border border-slate-200 p-2 text-slate-500 transition hover:border-amber-300 hover:text-amber-600">
                                        <span class="sr-only">{{ toggle_label }}</span>
                                        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                            stroke-width="1.6">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M7 5h6a2 2 0 012 2v6a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 10h2" />
                                        </svg>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div
                class="flex flex-col gap-3 border-t border-slate-100 px-4 py-4 text-xs text-slate-500 sm:flex-row sm:items-center sm:justify-between">
                <div>
                    Showing
                    <span class="font-semibold text-slate-700">{{ pagination.showing_from }}</span>
                    â
                    <span class="font-semibold text-slate-700">{{ pagination.showing_to }}</span>
                    of
                    <span class="font-semibold text-slate-700">{{ pagination.total_records }}</span>
                    extensions
                </div>
                <div class="flex items-center gap-2">
                    <a href="?page={{ pagination.prev_page }}"
                        class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold {{ 'pointer-events-none opacity-40' if not pagination.has_prev else 'hover:border-sky-300 hover:text-sky-700' }}"
                        aria-disabled="{{ 'true' if not pagination.has_prev else 'false' }}">
                        <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 5l-4 5 4 5" />
                        </svg>
                        Prev
                    </a>
                    <span class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600">
                        Page {{ pagination.current_page }} / {{ pagination.total_pages }}
                    </span>
                    <a href="?page={{ pagination.next_page }}"
                        class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold {{ 'pointer-events-none opacity-40' if not pagination.has_next else 'hover:border-sky-300 hover:text-sky-700' }}"
                        aria-disabled="{{ 'true' if not pagination.has_next else 'false' }}">
                        Next
                        <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 5l4 5-4 5" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('extensionFilters', (rawFilters) => {
            let parsed = rawFilters;
            if (typeof rawFilters === 'string') {
                try {
                    parsed = JSON.parse(rawFilters);
                } catch (error) {
                    parsed = {};
                    console.warn('Failed to parse filters JSON:', error);
                }
            }
            parsed = parsed || {};

            const normalizeChoice = (choice) => {
                if (choice && typeof choice === 'object') {
                    const value = choice.value ?? '';
                    const label = choice.label ?? value;
                    return { value, label };
                }
                const value = String(choice ?? '');
                return { value, label: value };
            };

            const normalizeOptions = (options = []) => options.map(normalizeChoice);

            const normalize = (item = {}) => ({
                ...item,
                type: item.type || 'select',
                options: normalizeOptions(item.options || []),
            });

            const availableFilters = (parsed.available || []).map(normalize);
            const activeFilters = (parsed.active || []).map((item) => {
                const source = availableFilters.find((opt) => opt.id === item.id) || {};
                const base = normalize({ ...source, ...item });
                let value = item.value;
                if (base.type === 'select') {
                    value = Array.isArray(value) ? value : [];
                } else if (base.type === 'single') {
                    value = typeof value === 'string' ? value : (base.default ?? '');
                } else if (base.type === 'daterange') {
                    value = value && typeof value === 'object' ? value : { start: '', end: '' };
                }
                return {
                    ...base,
                    value,
                };
            });

            return {
                availableFilters,
                activeFilters,
                getActive(id) {
                    return this.activeFilters.find((filter) => filter.id === id);
                },
                isActive(id) {
                    return Boolean(this.getActive(id));
                },
                ensureFilter(option) {
                    let current = this.getActive(option.id);
                    if (!current) {
                        const value = option.type === 'select'
                            ? []
                            : option.type === 'single'
                                ? (option.default ?? '')
                                : { start: '', end: '' };
                        current = {
                            ...option,
                            options: normalizeOptions(option.options || []),
                            value,
                        };
                        this.activeFilters.push(current);
                    } else if (!current.options?.length) {
                        current.options = normalizeOptions(option.options || []);
                    }
                    return current;
                },
                removeFilter(id) {
                    this.activeFilters = this.activeFilters.filter((filter) => filter.id !== id);
                },
                toggleSelectOption(option, choice, checked) {
                    const filter = this.ensureFilter(option);
                    const values = new Set(Array.isArray(filter.value) ? filter.value : []);
                    if (checked) {
                        values.add(choice);
                    } else {
                        values.delete(choice);
                    }
                    filter.value = Array.from(values);
                    if (!filter.value.length) {
                        this.removeFilter(option.id);
                    }
                },
                isSelected(id, choice) {
                    const filter = this.getActive(id);
                    if (!filter || !Array.isArray(filter.value)) {
                        return false;
                    }
                    return filter.value.includes(choice);
                },
                isSingleSelected(option, choice) {
                    const filter = this.getActive(option.id);
                    if (!filter) {
                        return false;
                    }
                    return filter.value === choice;
                },
                selectSingleOption(option, choice) {
                    if (!choice || choice === option.default) {
                        this.removeFilter(option.id);
                        return;
                    }
                    const filter = this.ensureFilter(option);
                    filter.value = choice;
                },
                updateRange(option, key, value) {
                    const filter = this.ensureFilter(option);
                    filter.value = { ...(filter.value || { start: '', end: '' }), [key]: value };
                    if (!filter.value.start && !filter.value.end) {
                        this.removeFilter(option.id);
                    }
                },
                labelFor(option, value) {
                    const candidates = option.options || [];
                    const match = candidates.find((opt) => opt.value === value);
                    return match ? match.label : value;
                },
                summaryFor(option) {
                    const filter = this.getActive(option.id);
                    if (!filter) {
                        if (option.type === 'select') {
                            return 'All';
                        }
                        if (option.type === 'single') {
                            return option.default || 'All';
                        }
                        if (option.type === 'daterange') {
                            return 'Any time';
                        }
                        return '';
                    }
                    return this.filterSummary(filter);
                },
                filterSummary(filter) {
                    if (filter.type === 'select') {
                        if (!filter.value?.length) {
                            return 'All';
                        }
                        if (filter.value.length <= 2) {
                            return filter.value
                                .map((val) => this.labelFor(filter, val))
                                .join(', ');
                        }
                        return `${filter.value.length} selected`;
                    }
                    if (filter.type === 'single') {
                        return this.labelFor(filter, filter.value) || filter.default || 'All';
                    }
                    if (filter.type === 'daterange') {
                        const start = filter.value?.start || '';
                        const end = filter.value?.end || '';
                        if (!start && !end) {
                            return 'Any time';
                        }
                        return `${start || 'Start'} â ${end || 'End'}`;
                    }
                    return '';
                },
                activeFiltersSummary() {
                    if (!this.activeFilters.length) {
                        return '';
                    }
                    const parts = this.activeFilters
                        .map((filter) => this.filterSummary(filter))
                        .filter(Boolean);
                    if (!parts.length) {
                        return '';
                    }
                    if (parts.length <= 2) {
                        return parts.join(' Â· ');
                    }
                    return `${parts.slice(0, 2).join(' Â· ')} +${parts.length - 2} more`;
                },
                clearFilter(option) {
                    this.removeFilter(option.id);
                },
                reset() {
                    this.activeFilters = [];
                },
            };
        });
    });
</script>

{% endblock %}