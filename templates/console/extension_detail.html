{% extends "console/layout.html" %}
{% set has_model = model is defined and model is not none %}
{% set mode_text = '"edit"' if has_model else '"create"' %}
{% set model_data = model if has_model else {} %}
{% block title %}{{ model_data.extension | default("New extension") }} · {{ site_name | default('RustPBX') }}{% endblock
%}
{% block content %}
{% set base_url = base_path | default('/console') %}
<div class="p-6" x-data='extensionDetailPage({
        basePath: {{ base_url | tojson }},
        mode: {{ mode_text }},
        model: {{ model_data | tojson }},
        departments: {{ filters.departments | default([]) | tojson }},
        assignedDepartments: {{ departments | default([]) | tojson }},
    locator: {{ registration_info | default({}) | tojson }},
    forwardingCatalog: {{ forwarding_catalog | default({}) | tojson }}
    })' x-init="init()">
    <div class="mx-auto max-w-5xl space-y-6">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
            <div class="space-y-3">
                <a :href="listUrl"
                    class="inline-flex items-center gap-2 text-sm font-medium text-slate-500 hover:text-slate-700">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5l-4 5 4 5" />
                    </svg>
                    Back to list
                </a>
                <div>
                    <h1 class="text-2xl font-semibold text-slate-900" x-text="pageTitle"></h1>
                    <p class="mt-2 text-sm text-slate-500"
                        x-text="mode === 'create' ? 'Define credentials, departments, and availability for the new extension.' : 'Update profile, credentials, routing, and access controls for this extension.'">
                    </p>
                </div>
            </div>
            <div class="rounded-xl bg-white p-5 text-sm text-slate-600 shadow-sm ring-1 ring-black/5">
                <div class="flex items-center justify-between">
                    <div class="font-semibold text-slate-900">Extension summary</div>
                    <template x-if="mode === 'edit'">
                        <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-semibold"
                            :class="hasActiveRegistration()
                                ? 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200'
                                : locator.error
                                    ? 'bg-rose-50 text-rose-600 ring-1 ring-rose-200'
                                    : 'bg-slate-100 text-slate-600 ring-1 ring-slate-200'">
                            <span class="h-1.5 w-1.5 rounded-full"
                                :class="hasActiveRegistration() ? 'bg-emerald-400' : locator.error ? 'bg-rose-400' : 'bg-slate-300'"></span>
                            <span
                                x-text="hasActiveRegistration() ? 'Active' : locator.error ? 'Unavailable' : 'Pending'"></span>
                        </span>
                    </template>
                </div>
                <dl class="mt-4 space-y-3 text-xs text-slate-500">
                    <div class="flex items-center justify-between gap-6">
                        <dt class="uppercase tracking-wide">Extension</dt>
                        <dd class="text-sm text-slate-700" x-text="form.extension || '—'"></dd>
                    </div>
                    <div class="flex items-center justify-between gap-6">
                        <dt class="uppercase tracking-wide">Created</dt>
                        <dd class="text-sm text-slate-700" x-text="formatDate(model?.created_at)"></dd>
                    </div>
                    <div class="flex items-center justify-between gap-6">
                        <dt class="uppercase tracking-wide">Last registered</dt>
                        <dd class="text-sm text-slate-700">
                            <div x-text="registrationStatusText()"></div>
                            <template x-if="locator.error">
                                <div class="text-xs text-rose-500" x-text="locator.error"></div>
                            </template>
                        </dd>
                    </div>
                    <div class="flex items-center justify-between gap-6">
                        <dt class="uppercase tracking-wide">Public access</dt>
                        <dd class="text-sm text-slate-700" x-text="form.public_call_allowed ? 'Allowed' : 'Restricted'">
                        </dd>
                    </div>
                </dl>
            </div>
        </div>

        <template x-if="success">
            <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700"
                x-text="success"></div>
        </template>
        <template x-if="error">
            <div class="rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700" x-text="error">
            </div>
        </template>

        <form class="space-y-6" @submit.prevent="submit">
            <div class="space-y-6">
                <div class="rounded-xl bg-white p-3 shadow-sm ring-1 ring-black/5">
                    <nav class="inline-flex w-full flex-wrap gap-2 rounded-lg border border-slate-200 bg-slate-50 p-1 text-xs font-semibold text-slate-600"
                        role="tablist" aria-label="Extension configuration sections">
                        <template x-for="tab in tabs" :key="tab.id">
                            <button type="button" @click="setActiveTab(tab.id)"
                                class="flex-1 rounded-md px-4 py-2 text-left transition sm:flex-none"
                                :class="isActiveTab(tab.id) ? 'bg-white text-sky-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'"
                                :aria-selected="isActiveTab(tab.id)" :aria-controls="`tab-panel-${tab.id}`">
                                <div class="flex flex-col">
                                    <span class="text-sm" x-text="tab.label"></span>
                                    <span class="text-[11px] font-normal text-slate-400"
                                        x-text="tab.description"></span>
                                </div>
                            </button>
                        </template>
                    </nav>
                </div>

                <div x-cloak x-show="activeTab === 'profile'" x-transition.opacity.duration.200ms
                    :id="`tab-panel-profile`" role="tabpanel" tabindex="0" class="space-y-6">
                    <div class="grid gap-6 md:grid-cols-2">
                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                            Extension number
                            <input type="text" x-model.trim="form.extension" required maxlength="32"
                                class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="e.g. 1007">
                            <span class="text-xs font-normal text-slate-400">Numbers only. This becomes the SIP user ID
                                for
                                clients.</span>
                        </label>
                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                            Display name
                            <input type="text" x-model.trim="form.display_name" maxlength="160"
                                class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="Visible to teammates and call logs">
                        </label>
                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                            Email (optional)
                            <input type="email" x-model.trim="form.email" maxlength="160"
                                class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="name@rustpbx.com">
                        </label>
                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                            SIP password
                            <div class="relative">
                                <input
                                    :type="sipPasswordVisible ? 'text' : (hasExistingSipPassword() ? 'text' : 'password')"
                                    :readonly="!sipPasswordVisible && hasExistingSipPassword()"
                                    x-model="sipPasswordInput" @input="onSipPasswordInput" maxlength="160"
                                    class="w-full rounded-lg border border-slate-200 px-3 py-2 pr-20 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="Leave blank to keep current or auto-generate">
                                <button type="button"
                                    class="absolute inset-y-0 right-2 inline-flex items-center text-xs font-semibold uppercase tracking-wide text-slate-500 transition hover:text-slate-700"
                                    @click="toggleSipPasswordVisibility" x-text="sipPasswordVisible ? 'Hide' : 'Show'"
                                    :aria-pressed="sipPasswordVisible"></button>
                            </div>
                            <span class="text-xs font-normal text-slate-400">Provide a strong password. Leave blank to
                                keep
                                the existing secret.</span>
                        </label>
                    </div>
                </div>

                <div x-cloak x-show="activeTab === 'access'" x-transition.opacity.duration.200ms
                    :id="`tab-panel-access`" role="tabpanel" tabindex="0" class="space-y-6">
                    <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                        <h2 class="text-sm font-semibold text-slate-900">Departments</h2>
                        <p class="mt-1 text-xs text-slate-500">Assignments load once and remain available while editing.
                        </p>
                        <div class="mt-4 flex flex-wrap gap-2">
                            <template x-if="!availableDepartments.length">
                                <span class="rounded-full border border-slate-200 px-3 py-1 text-xs text-slate-400">No
                                    departments configured.</span>
                            </template>
                            <template x-for="dept in availableDepartments" :key="dept.id">
                                <label
                                    class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700">
                                    <input type="checkbox"
                                        class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-400"
                                        :value="String(dept.id)" x-model="selectedDepartments">
                                    <span x-text="dept.name"></span>
                                </label>
                            </template>
                        </div>
                    </div>

                    <div class="grid gap-6 md:grid-cols-3">
                        <div class="space-y-3 rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h2 class="text-sm font-semibold text-slate-900">Portal login</h2>
                                    <p class="text-xs text-slate-500">Controls whether softphone or web clients can sign
                                        in.
                                    </p>
                                </div>
                                <button type="button" @click="form.login_allowed = !form.login_allowed"
                                    :class="form.login_allowed ? 'bg-emerald-100 text-emerald-600 ring-emerald-200' : 'bg-slate-100 text-slate-500 ring-slate-200'"
                                    class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ring-2 transition">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 22 22" fill="none" stroke="currentColor"
                                        stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z" />
                                    </svg>
                                    <span x-text="form.login_allowed ? 'Enabled' : 'Disabled'"></span>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-3 rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h2 class="text-sm font-semibold text-slate-900">Voicemail inbox</h2>
                                    <p class="text-xs text-slate-500">Allow unanswered calls to drop voicemail messages.
                                    </p>
                                </div>
                                <button type="button" @click="form.voicemail_enabled = !form.voicemail_enabled"
                                    :class="form.voicemail_enabled ? 'bg-sky-100 text-sky-600 ring-sky-200' : 'bg-slate-100 text-slate-500 ring-slate-200'"
                                    class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ring-2 transition">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 22 22" fill="none" stroke="currentColor"
                                        stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H6.911a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z" />
                                    </svg>
                                    <span x-text="form.voicemail_enabled ? 'Enabled' : 'Disabled'"></span>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-3 rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h2 class="text-sm font-semibold text-slate-900">Public inbound calls</h2>
                                    <p class="text-xs text-slate-500">Allow anonymous SIP INVITEs to reach this
                                        extension.</p>
                                </div>
                                <button type="button" @click="form.public_call_allowed = !form.public_call_allowed"
                                    :class="form.public_call_allowed ? 'bg-emerald-100 text-emerald-600 ring-emerald-200' : 'bg-slate-100 text-slate-500 ring-slate-200'"
                                    class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ring-2 transition">
                                    <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                        stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M4.75 3.75h2.5l1 3-1.5.75a7 7 0 0 0 4.5 4.5l.75-1.5 3 1v2.5a1 1 0 0 1-1 1c-6.351 0-11.5-5.149-11.5-11.5a1 1 0 0 1 1-1Z" />
                                    </svg>
                                    <span x-text="form.public_call_allowed ? 'Allowed' : 'Restricted'"></span>
                                </button>
                            </div>
                            <p class="text-xs text-slate-500">Registration still requires credentials even when public
                                calling is enabled.</p>
                        </div>
                    </div>
                </div>

                <div x-cloak x-show="activeTab === 'routing'" x-transition.opacity.duration.200ms
                    :id="`tab-panel-routing`" role="tabpanel" tabindex="0" class="space-y-6">
                    <div class="space-y-4 rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                        <header class="flex flex-col gap-1">
                            <h2 class="text-sm font-semibold text-slate-900">Call forwarding</h2>
                            <p class="text-xs text-slate-500">Configure destination and timeout. Disabled fields are
                                ignored
                                when forwarding is off.</p>
                        </header>
                        <div class="grid gap-3 md:grid-cols-2">
                            <template x-for="option in forwardingModes" :key="option.value">
                                <label
                                    class="flex cursor-pointer items-start gap-3 rounded-lg border px-4 py-3 text-sm transition"
                                    :class="form.call_forwarding_mode === option.value ? 'border-sky-200 bg-sky-50/60 shadow-sm' : 'border-slate-200 hover:border-slate-300'">
                                    <input type="radio"
                                        class="mt-1 h-4 w-4 border-slate-300 text-sky-600 focus:ring-sky-400"
                                        x-model="form.call_forwarding_mode" :value="option.value">
                                    <span>
                                        <span class="font-semibold text-slate-900" x-text="option.label"></span>
                                        <span class="block text-xs text-slate-500" x-text="option.description"></span>
                                    </span>
                                </label>
                            </template>
                        </div>
                        <template x-if="form.call_forwarding_mode === 'none'">
                            <div
                                class="rounded-lg border border-dashed border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-500">
                                Enable a forwarding mode above to configure destinations.
                            </div>
                        </template>
                        <div class="grid gap-5 md:grid-cols-2" x-show="form.call_forwarding_mode !== 'none'" x-cloak>
                            <div class="space-y-3 text-sm font-medium text-slate-700">
                                <div class="flex flex-col gap-2">
                                    <span>Destination type</span>
                                    <div class="flex flex-wrap gap-2 text-xs font-semibold">
                                        <label
                                            class="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-slate-600 transition"
                                            :class="forwardingTargetType === 'uri' ? 'border-sky-200 bg-sky-50 text-sky-700 shadow-sm' : 'border-slate-200 hover:border-slate-300'">
                                            <input type="radio" class="h-4 w-4 border-slate-300 text-sky-600"
                                                :checked="forwardingTargetType === 'uri'"
                                                @change="setForwardingTargetType('uri')">
                                            <span>Standard URI</span>
                                        </label>
                                        <label x-show="queueEnabled"
                                            class="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-slate-600 transition"
                                            :class="forwardingTargetType === 'queue' ? 'border-sky-200 bg-sky-50 text-sky-700 shadow-sm' : 'border-slate-200 hover:border-slate-300'">
                                            <input type="radio" class="h-4 w-4 border-slate-300 text-sky-600"
                                                :checked="forwardingTargetType === 'queue'"
                                                @change="setForwardingTargetType('queue')">
                                            <span>Queue</span>
                                        </label>
                                    </div>
                                </div>
                                <div x-show="forwardingTargetType === 'uri'" x-cloak>
                                    <label class="flex flex-col gap-2">
                                        Forward destination
                                        <input type="text" maxlength="160" x-model.trim="forwardingTargetValue"
                                            @input="syncForwardingDestination()"
                                            :disabled="form.call_forwarding_mode === 'none'"
                                            :class="form.call_forwarding_mode === 'none' ? 'border-slate-200 bg-slate-50 text-slate-400 cursor-not-allowed' : 'border-slate-200 focus:border-sky-300 focus:ring-2 focus:ring-sky-200'"
                                            class="rounded-lg border px-3 py-2 text-sm text-slate-700"
                                            placeholder="SIP URI, PSTN number, or internal extension">
                                        <span class="text-xs font-normal text-slate-400">Required whenever forwarding is
                                            enabled.</span>
                                    </label>
                                </div>
                                <div x-show="forwardingTargetType === 'queue'" x-cloak class="space-y-3">
                                    <template x-if="queueTargets.length">
                                        <label class="flex flex-col gap-1 text-sm font-medium text-slate-700">
                                            Select Queue
                                            <select
                                                class="rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                                :disabled="form.call_forwarding_mode === 'none'"
                                                x-model="forwardingTargetValue" @change="syncForwardingDestination()">
                                                <option value="">Select queue…</option>
                                                <template x-for="queue in queueTargets" :key="queue.reference">
                                                    <option :value="queue.reference" x-text="queue.name"></option>
                                                </template>
                                            </select>
                                            <span class="text-xs font-normal text-slate-400">Saved as <code
                                                    class="font-mono text-[11px]">queue:&lt;id&gt;</code>.</span>
                                        </label>
                                    </template>
                                    <template x-if="!queueTargets.length">
                                        <div
                                            class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-500">
                                            No queues available. Please create a queue first.
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                                Ring timeout (seconds)
                                <input type="number" min="5" max="120" step="1"
                                    x-model.number="form.call_forwarding_timeout"
                                    :disabled="form.call_forwarding_mode === 'none'"
                                    :class="form.call_forwarding_mode === 'none' ? 'border-slate-200 bg-slate-50 text-slate-400 cursor-not-allowed' : 'border-slate-200 focus:border-sky-300 focus:ring-2 focus:ring-sky-200'"
                                    class="rounded-lg border px-3 py-2 text-sm text-slate-700">
                                <span class="text-xs font-normal text-slate-400">Accepted range: 5–120 seconds.</span>
                            </label>
                        </div>
                    </div>

                    <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                        <h2 class="text-sm font-semibold text-slate-900">Internal notes</h2>
                        <textarea rows="4" x-model="form.notes"
                            class="mt-3 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                            placeholder="Optional notes for provisioning or troubleshooting."></textarea>
                    </div>
                </div>

                <div x-cloak x-show="activeTab === 'registrations'" x-transition.opacity.duration.200ms
                    :id="`tab-panel-registrations`" role="tabpanel" tabindex="0" class="space-y-6">
                    <div class="space-y-4 rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <h2 class="text-sm font-semibold text-slate-900">Active registrations</h2>
                                <p class="text-xs text-slate-500">Locator bindings currently associated with this
                                    extension.</p>
                            </div>
                            <template x-if="locator.query_uri">
                                <div
                                    class="inline-flex items-center gap-2 rounded-md bg-slate-100 px-2.5 py-1 text-[11px] font-medium text-slate-600 ring-1 ring-slate-200">
                                    <span class="uppercase tracking-wide text-slate-400">AoR</span>
                                    <span x-text="locator.query_uri"></span>
                                </div>
                            </template>
                        </div>

                        <template x-if="locator.error">
                            <div class="rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-xs text-rose-600"
                                x-text="locator.error"></div>
                        </template>

                        <template x-if="locator.available && locator.records.length">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200 text-left text-xs">
                                    <thead
                                        class="bg-slate-50 text-[11px] font-semibold uppercase tracking-wide text-slate-500">
                                        <tr>
                                            <th scope="col" class="px-3 py-2">Contact</th>
                                            <th scope="col" class="px-3 py-2">Destination</th>
                                            <th scope="col" class="px-3 py-2">Transport</th>
                                            <th scope="col" class="px-3 py-2">TTL</th>
                                            <th scope="col" class="px-3 py-2">Updated</th>
                                            <th scope="col" class="px-3 py-2">Flags</th>
                                            <th scope="col" class="px-3 py-2">User agent</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 text-slate-600">
                                        <template x-for="record in locator.records" :key="record.binding_key">
                                            <tr>
                                                <td class="px-3 py-2 align-top">
                                                    <div class="font-medium text-slate-900"
                                                        x-text="record.contact || record.registered_aor || record.aor">
                                                    </div>
                                                    <template x-if="record.binding_key">
                                                        <div class="text-[11px] text-slate-400"
                                                            x-text="record.binding_key"></div>
                                                    </template>
                                                </td>
                                                <td class="px-3 py-2 align-top">
                                                    <span x-text="record.destination || '—'"></span>
                                                </td>
                                                <td class="px-3 py-2 align-top">
                                                    <div class="flex flex-col gap-1">
                                                        <span x-text="record.transport || '—'"></span>
                                                        <template x-if="record.supports_webrtc">
                                                            <span
                                                                class="inline-flex w-max items-center rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-medium text-emerald-600 ring-1 ring-emerald-100">
                                                                WebRTC
                                                            </span>
                                                        </template>
                                                    </div>
                                                </td>
                                                <td class="px-3 py-2 align-top">
                                                    <div class="font-semibold text-slate-900"
                                                        x-text="formatDuration(remainingTtl(record))"></div>
                                                    <div class="text-[11px] text-slate-400">Max
                                                        <span x-text="formatDuration(record.expires)"></span>
                                                    </div>
                                                </td>
                                                <td class="px-3 py-2 align-top">
                                                    <div class="text-sm font-semibold text-slate-700"
                                                        x-text="formatRelativeSeconds(record.age_seconds)"></div>
                                                </td>
                                                <td class="px-3 py-2 align-top">
                                                    <div class="flex flex-wrap gap-1">
                                                        <template x-for="flag in recordFlags(record)" :key="flag">
                                                            <span
                                                                class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-medium text-slate-600 ring-1 ring-slate-200"
                                                                x-text="flag"></span>
                                                        </template>
                                                        <template x-if="!recordFlags(record).length">
                                                            <span class="text-[11px] text-slate-400">—</span>
                                                        </template>
                                                    </div>
                                                </td>
                                                <td class="px-3 py-2 align-top">
                                                    <span class="block max-w-xs truncate text-xs"
                                                        :title="record.user_agent || undefined"
                                                        x-text="record.user_agent || '—'"></span>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>

                        <template x-if="locator.available && !locator.records.length && !locator.error">
                            <div
                                class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-500">
                                No active registrations found for this extension.
                            </div>
                        </template>

                        <template x-if="!locator.available && !locator.error">
                            <div
                                class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-500">
                                Registration data will appear when the SIP server is connected and this extension has an
                                active binding.
                            </div>
                        </template>
                    </div>
                </div>

                <div x-cloak x-show="activeTab === 'presence'" x-transition.opacity.duration.200ms
                    :id="`tab-panel-presence`" role="tabpanel" tabindex="0" class="space-y-6">
                    <div class="space-y-4 rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <h2 class="text-sm font-semibold text-slate-900">Current presence</h2>
                                <p class="text-xs text-slate-500">Real-time status aggregated from endpoints and manual
                                    settings.</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span
                                    class="inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-sm font-semibold ring-1"
                                    :class="{
                                        'bg-emerald-50 text-emerald-600 ring-emerald-200': presence.status === 'available',
                                        'bg-rose-50 text-rose-600 ring-rose-200': presence.status === 'busy',
                                        'bg-amber-50 text-amber-600 ring-amber-200': presence.status === 'away',
                                        'bg-slate-50 text-slate-600 ring-slate-200': presence.status === 'offline'
                                    }">
                                    <span class="h-2 w-2 rounded-full" :class="{
                                            'bg-emerald-400': presence.status === 'available',
                                            'bg-rose-400': presence.status === 'busy',
                                            'bg-amber-400': presence.status === 'away',
                                            'bg-slate-300': presence.status === 'offline'
                                        }"></span>
                                    <span
                                        x-text="presence.status.charAt(0).toUpperCase() + presence.status.slice(1)"></span>
                                </span>
                            </div>
                        </div>

                        <div class="grid gap-6 md:grid-cols-2">
                            <div class="space-y-4">
                                <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Manual Override
                                </h3>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="status in ['available', 'busy', 'away', 'offline']">
                                        <button type="button" @click="updateManualPresence(status)"
                                            :disabled="presence.saving_manual"
                                            class="inline-flex items-center gap-2 rounded-lg border px-3 py-2 text-sm font-medium transition"
                                            :class="presence.status === status ? 'border-sky-600 bg-sky-50 text-sky-700' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'">
                                            <span class="h-2 w-2 rounded-full" :class="{
                                                    'bg-emerald-400': status === 'available',
                                                    'bg-rose-400': status === 'busy',
                                                    'bg-amber-400': status === 'away',
                                                    'bg-slate-300': status === 'offline'
                                                }"></span>
                                            <span x-text="status.charAt(0).toUpperCase() + status.slice(1)"></span>
                                        </button>
                                    </template>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-medium text-slate-700">Status note</label>
                                    <input type="text" x-model="presence.note"
                                        class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none"
                                        placeholder="e.g. In a meeting">
                                    <button type="button" @click="updateManualPresence(presence.status)"
                                        class="text-xs font-semibold text-sky-600 hover:text-sky-700">Save note</button>
                                </div>
                            </div>

                            <div class="rounded-lg bg-slate-50 p-4 text-xs text-slate-500">
                                <h3 class="font-semibold text-slate-700">How it works</h3>
                                <ul class="mt-2 list-disc space-y-1 pl-4">
                                    <li><strong>Aggregated:</strong> Available if registered and not manually set to
                                        busy/away.</li>
                                    <li><strong>SIP PUBLISH:</strong> Endpoints can update status automatically via SIP.
                                    </li>
                                    <li><strong>Manual:</strong> Setting status here overrides SIP endpoint updates.
                                    </li>
                                </ul>
                                <template x-if="presence.updated_at">
                                    <div
                                        class="mt-4 pt-4 border-t border-slate-200 text-[10px] text-slate-400 uppercase tracking-widest">
                                        Last updated: <span
                                            x-text="new Date(presence.updated_at * 1000).toLocaleString()"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="text-xs text-slate-400">
                    Submissions update immediately through the API. All actions run via AJAX—no full page reloads
                    required.
                </div>
                <div class="flex items-center gap-3">
                    <a :href="listUrl"
                        class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">
                        Cancel
                    </a>
                    <button type="submit"
                        class="inline-flex items-center justify-center gap-2 rounded-lg bg-sky-600 px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2"
                        :disabled="saving">
                        <svg class="h-4 w-4 animate-spin" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                            stroke-width="1.6" x-show="saving">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M4 10a6 6 0 0 1 6-6m0-3v3m6 6a6 6 0 0 1-6 6m0 3v-3m9-6h-3M1 10h3m10.95 4.95-2.12-2.12M4.05 5.05l2.12 2.12m0 5.66-2.12 2.12m9.9-9.9 2.12-2.12" />
                        </svg>
                        <span x-text="mode === 'create' ? 'Create extension' : 'Save changes'"></span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('extensionDetailPage', (options) => {
            const normalizeLocator = (raw) => {
                if (!raw || typeof raw !== 'object') {
                    return {
                        available: false,
                        query_uri: null,
                        realm: null,
                        total: 0,
                        records: [],
                        error: null,
                    };
                }
                return {
                    available: !!raw.available,
                    query_uri: raw.query_uri || null,
                    realm: raw.realm || null,
                    total: Number(raw.total) || 0,
                    records: Array.isArray(raw.records) ? raw.records : [],
                    error: raw.error || null,
                };
            };

            const normalizeForwardingCatalog = (raw) => {
                const catalog = {
                    queues: [],
                };
                if (raw && Array.isArray(raw.queues)) {
                    catalog.queues = raw.queues
                        .map((queue) => {
                            const reference = typeof queue.reference === 'string'
                                ? queue.reference.trim()
                                : '';
                            return {
                                id: queue.id,
                                name: queue.name || 'Unnamed queue',
                                reference,
                                description: queue.description || null,
                            };
                        })
                        .filter((queue) => queue.reference.length);
                }
                return catalog;
            };

            const existingSipPassword = typeof options.model?.sip_password === 'string'
                ? options.model.sip_password
                : '';

            return {
                basePath: options.basePath || '/console',
                mode: options.mode || 'create',
                model: options.model || {},
                availableDepartmentsRaw: options.departments || [],
                assignedDepartmentsRaw: options.assignedDepartments || [],
                locator: normalizeLocator(options.locator || options.registrations),
                listUrl: `${options.basePath || '/console'}/extensions`,
                success: null,
                error: null,
                saving: false,
                activeTab: 'profile',
                forwardingCatalog: normalizeForwardingCatalog(options.forwardingCatalog || {}),
                queueEnabled: window.queueAddonEnabled || false,
                tabs: [
                    { id: 'profile', label: 'Profile', description: 'Extension details' },
                    { id: 'access', label: 'Access & Departments', description: 'Departments and access permissions' },
                    { id: 'routing', label: 'Call forwarding', description: 'Call forwarding and internal notes' },
                ],
                form: {
                    extension: options.model?.extension || '',
                    display_name: options.model?.display_name || '',
                    email: options.model?.email || '',
                    sip_password: '',
                    login_allowed: !(options.model?.login_disabled ?? false),
                    voicemail_enabled: !(options.model?.voicemail_disabled ?? false),
                    public_call_allowed: !!(options.model?.allow_guest_calls ?? false),
                    call_forwarding_mode: options.model?.call_forwarding_mode || 'none',
                    call_forwarding_destination: options.model?.call_forwarding_destination || '',
                    call_forwarding_timeout: options.model?.call_forwarding_timeout || 30,
                    notes: options.model?.notes || '',
                },
                presence: {
                    status: 'offline',
                    note: '',
                    updated_at: null,
                    loading: false,
                    saving_manual: false
                },
                forwardingTargetType: 'uri',
                forwardingTargetValue: '',
                sipPasswordVisible: false,
                sipPasswordDirty: false,
                sipPasswordStored: existingSipPassword,
                sipPasswordInput: existingSipPassword && (options.mode || 'create') === 'edit' ? '****' : '',
                selectedDepartments: [],
                forwardingModes: [
                    { value: 'none', label: 'No forwarding', description: 'Ring this extension only.' },
                    { value: 'always', label: 'Always forward', description: 'Forward every call immediately.' },
                    { value: 'when_busy', label: 'When busy', description: 'Forward only when already on a call.' },
                    { value: 'when_not_answered', label: 'When not answered', description: 'Forward if unanswered within the timeout.' },
                ],
                get queueTargets() {
                    return this.forwardingCatalog.queues;
                },
                setActiveTab(tabId) {
                    const fallback = this.tabs[0]?.id || 'profile';
                    this.activeTab = this.tabs.some((tab) => tab.id === tabId) ? tabId : fallback;
                },
                isActiveTab(tabId) {
                    return this.activeTab === tabId;
                },
                get availableDepartments() {
                    return this.availableDepartmentsRaw.map((item) => ({
                        id: item.id,
                        name: item.name || item.display_name || item.label || `Department #${item.id}`,
                    }));
                },
                get pageTitle() {
                    return this.mode === 'edit'
                        ? `Edit ${this.form.display_name || this.form.extension || 'extension'}`
                        : 'Create extension';
                },
                submitUrl() {
                    if (this.mode === 'edit' && this.model?.id) {
                        return `${this.basePath}/extensions/${this.model.id}`;
                    }
                    return `${this.basePath}/extensions`;
                },
                submitMethod() {
                    return this.mode === 'edit' ? 'PATCH' : 'PUT';
                },
                init() {
                    this.selectedDepartments = (this.assignedDepartmentsRaw || [])
                        .map((dept) => String(dept.id))
                        .filter(Boolean);
                    this.form.call_forwarding_timeout = this.clampTimeout(this.form.call_forwarding_timeout);
                    this.initializeForwardingTargetUI();
                    if (this.mode === 'edit' && !this.tabs.some((tab) => tab.id === 'registrations')) {
                        this.tabs.push({
                            id: 'registrations',
                            label: 'Registrations',
                            description: 'Locator bindings and device presence',
                        });
                        this.tabs.push({
                            id: 'presence',
                            label: 'Presence',
                            description: 'SIP presence status and manual override',
                        });
                        this.fetchPresence();
                    }
                },
                async fetchPresence() {
                    if (this.mode !== 'edit' || !this.form.extension) return;
                    this.presence.loading = true;
                    try {
                        const response = await fetch(`/api/presence/${this.form.extension}`);
                        if (response.ok) {
                            const result = await response.json();
                            const data = result.data || {};
                            this.presence.status = data.status || 'offline';
                            this.presence.note = data.note || '';
                            this.presence.updated_at = data.last_updated;
                        }
                    } catch (err) {
                        console.error('Failed to fetch presence:', err);
                    } finally {
                        this.presence.loading = false;
                    }
                },
                async updateManualPresence(status) {
                    this.presence.saving_manual = true;
                    try {
                        const response = await fetch(`/api/presence/${this.form.extension}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status, note: this.presence.note })
                        });
                        if (response.ok) {
                            await this.fetchPresence();
                        } else {
                            const data = await response.json();
                            this.error = data.message || 'Failed to update presence';
                        }
                    } catch (err) {
                        this.error = 'Network error while updating presence';
                    } finally {
                        this.presence.saving_manual = false;
                    }
                },
                clampTimeout(value) {
                    const numeric = Number(value);
                    if (!Number.isFinite(numeric)) {
                        return 30;
                    }
                    return Math.min(120, Math.max(5, Math.round(numeric)));
                },
                formatDate(value) {
                    if (!value) {
                        return '—';
                    }
                    const date = new Date(value);
                    if (Number.isNaN(date.getTime())) {
                        return value;
                    }
                    return date.toLocaleString();
                },
                remainingTtl(record) {
                    if (!record || typeof record !== 'object') {
                        return 0;
                    }
                    const expires = Number(record.expires) || 0;
                    const age = Number(record.age_seconds) || 0;
                    return Math.max(expires - age, 0);
                },
                formatDuration(value) {
                    const seconds = Math.max(Number(value) || 0, 0);
                    if (seconds < 1) {
                        return '0s';
                    }
                    if (seconds < 60) {
                        return `${Math.round(seconds)}s`;
                    }
                    const minutes = Math.floor(seconds / 60);
                    const remSeconds = Math.round(seconds % 60);
                    if (minutes < 60) {
                        return remSeconds
                            ? `${minutes}m ${remSeconds}s`
                            : `${minutes}m`;
                    }
                    const hours = Math.floor(minutes / 60);
                    const remMinutes = minutes % 60;
                    if (hours < 24) {
                        return remMinutes
                            ? `${hours}h ${remMinutes}m`
                            : `${hours}h`;
                    }
                    const days = Math.floor(hours / 24);
                    const remHours = hours % 24;
                    return remHours
                        ? `${days}d ${remHours}h`
                        : `${days}d`;
                },
                formatRelativeSeconds(value) {
                    const seconds = Number(value);
                    if (!Number.isFinite(seconds) || seconds <= 0) {
                        return 'moments ago';
                    }
                    if (seconds < 60) {
                        return `${Math.round(seconds)}s ago`;
                    }
                    if (seconds < 3600) {
                        const minutes = Math.floor(seconds / 60);
                        const rem = Math.round(seconds % 60);
                        return rem ? `${minutes}m ${rem}s ago` : `${minutes}m ago`;
                    }
                    if (seconds < 86400) {
                        const hours = Math.floor(seconds / 3600);
                        const remMinutes = Math.floor((seconds % 3600) / 60);
                        return remMinutes ? `${hours}h ${remMinutes}m ago` : `${hours}h ago`;
                    }
                    const days = Math.floor(seconds / 86400);
                    const remHours = Math.floor((seconds % 86400) / 3600);
                    return remHours ? `${days}d ${remHours}h ago` : `${days}d ago`;
                },
                recordFlags(record) {
                    if (!record || typeof record !== 'object') {
                        return [];
                    }
                    const flags = [];
                    if (record.supports_webrtc) {
                        flags.push('WebRTC');
                    }
                    if (record.gruu) {
                        flags.push('GRUU');
                    }
                    if (record.temp_gruu) {
                        flags.push('Temp GRUU');
                    }
                    if (Array.isArray(record.path) && record.path.length) {
                        flags.push('Path');
                    }
                    if (Array.isArray(record.service_route) && record.service_route.length) {
                        flags.push('Service Route');
                    }
                    if (record.instance_id) {
                        flags.push('Instance');
                    }
                    return flags;
                },
                hasActiveRegistration() {
                    return !!(this.locator?.available && Array.isArray(this.locator.records) && this.locator.records.length);
                },
                firstRegistration() {
                    if (!this.hasActiveRegistration()) {
                        return null;
                    }
                    return this.locator.records[0];
                },
                registrationStatusText() {
                    const record = this.firstRegistration();
                    if (!record) {
                        if (this.model?.registered_at) {
                            return `Last seen ${this.formatDate(this.model.registered_at)}`;
                        }
                        return 'Awaiting registration';
                    }
                    const ttl = this.formatDuration(this.remainingTtl(record));
                    const seen = this.formatRelativeSeconds(record.age_seconds);
                    return `${seen} • TTL ${ttl}`;
                },
                buildPayload() {
                    return {
                        'extension': this.form.extension.trim(),
                        'display_name': this.form.display_name.trim(),
                        'email': this.form.email.trim(),
                        'sip_password': this.sipPasswordPayload(),
                        'login_disabled': this.form.login_allowed ? false : true,
                        'voicemail_disabled': this.form.voicemail_enabled ? false : true,
                        'allow_guest_calls': this.form.public_call_allowed === true,
                        'call_forwarding_mode': this.form.call_forwarding_mode || 'none',
                        'call_forwarding_destination': this.form.call_forwarding_mode !== 'none' && this.form.call_forwarding_destination.trim()
                            ? this.form.call_forwarding_destination.trim()
                            : undefined,
                        'call_forwarding_timeout': this.form.call_forwarding_mode !== 'none'
                            ? this.clampTimeout(this.form.call_forwarding_timeout)
                            : undefined,
                        'notes': this.form.notes ? this.form.notes.trim() : '',
                        'department_ids': this.selectedDepartments.map((id) => id.trim()).filter(Boolean),
                    }
                },
                async submit() {
                    if (!this.form.extension.trim()) {
                        this.error = 'Extension number is required.';
                        return;
                    }
                    if (this.form.call_forwarding_mode !== 'none' && !this.form.call_forwarding_destination.trim()) {
                        this.error = 'Forwarding destination is required when call forwarding is enabled.';
                        return;
                    }

                    this.saving = true;
                    this.error = null;
                    this.success = null;
                    try {
                        const body = this.buildPayload();
                        const response = await fetch(this.submitUrl(), {
                            method: this.submitMethod(),
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(body),
                        });
                        const data = await response.json().catch(() => ({}));
                        if (!response.ok) {
                            throw new Error(data?.message || 'Failed to save extension');
                        }

                        this.success = this.mode === 'create'
                            ? 'Extension created successfully. Returning to the list...'
                            : 'Changes saved. Returning to the list...';
                        setTimeout(() => {
                            window.location.href = this.listUrl;
                        }, 600);
                    } catch (err) {
                        console.error(err);
                        this.error = err.message || 'Failed to submit form';
                    } finally {
                        this.saving = false;
                    }
                },
                hasExistingSipPassword() {
                    return !!this.sipPasswordStored;
                },
                toggleSipPasswordVisibility() {
                    if (!this.sipPasswordVisible) {
                        if (!this.sipPasswordDirty && this.hasExistingSipPassword()) {
                            this.sipPasswordInput = this.sipPasswordStored;
                        }
                        this.sipPasswordVisible = true;
                        return;
                    }

                    this.sipPasswordVisible = false;
                    if (!this.sipPasswordDirty && this.hasExistingSipPassword()) {
                        this.sipPasswordInput = '****';
                    }
                },
                onSipPasswordInput() {
                    if (!this.sipPasswordDirty) {
                        this.sipPasswordDirty = true;
                    }
                    this.form.sip_password = this.sipPasswordInput;
                },
                sipPasswordPayload() {
                    if (!this.sipPasswordDirty) {
                        return undefined;
                    }
                    const trimmed = this.sipPasswordInput.trim();
                    return trimmed.length ? trimmed : undefined;
                },
                applyForwardingReference(reference, kind) {
                    const trimmed = (reference || '').trim();
                    if (!trimmed) {
                        return;
                    }
                    const normalizedKind = 'queue';
                    this.forwardingTargetType = normalizedKind;
                    this.forwardingTargetValue = trimmed;
                    this.syncForwardingDestination();
                    if (this.form.call_forwarding_mode === 'none') {
                        this.form.call_forwarding_mode = 'always';
                    }
                },
                onCatalogSelect(event, kind) {
                    const reference = (event?.target?.value || '').trim();
                    if (!reference) {
                        return;
                    }
                    this.applyForwardingReference(reference, kind);
                    if (event && event.target) {
                        event.target.value = '';
                    }
                },
                initializeForwardingTargetUI() {
                    const destination = (this.form.call_forwarding_destination || '').trim();
                    if (!destination) {
                        this.forwardingTargetType = 'uri';
                        this.forwardingTargetValue = '';
                        return;
                    }
                    const lower = destination.toLowerCase();
                    if (lower.startsWith('queue:')) {
                        this.forwardingTargetType = 'queue';
                        this.forwardingTargetValue = destination.slice(6);
                    } else {
                        this.forwardingTargetType = 'uri';
                        this.forwardingTargetValue = destination;
                    }
                },
                setForwardingTargetType(type) {
                    const allowed = ['uri', 'queue'];
                    const normalized = allowed.includes(type) ? type : 'uri';
                    if (this.forwardingTargetType === normalized) {
                        return;
                    }
                    this.forwardingTargetType = normalized;
                    if (!this.form.call_forwarding_destination) {
                        this.forwardingTargetValue = '';
                    } else if (normalized === 'queue' && this.form.call_forwarding_destination.toLowerCase().startsWith('queue:')) {
                        this.forwardingTargetValue = this.form.call_forwarding_destination.slice(6);
                    } else if (normalized === 'uri' && !this.form.call_forwarding_destination.toLowerCase().startsWith('queue:')) {
                        this.forwardingTargetValue = this.form.call_forwarding_destination;
                    } else {
                        this.forwardingTargetValue = '';
                    }
                    this.syncForwardingDestination();
                },
                syncForwardingDestination() {
                    const value = this.forwardingTargetValue.trim();
                    if (!value) {
                        this.form.call_forwarding_destination = '';
                        return;
                    }
                    if (this.forwardingTargetType === 'queue') {
                        this.form.call_forwarding_destination = `queue:${value}`;
                    } else {
                        this.form.call_forwarding_destination = value;
                    }
                },
            };
        });
    });
</script>

{% endblock %}