{% extends "console/layout.html" %}
{% set has_model = model is defined and model is not none %}
{% set page_mode = mode | default('create') %}
{% set model_data = model if has_model else {} %}
{% block title %}{{ model_data.name | default('New queue') }} · {{ site_name | default('RustPBX') }}{% endblock %}
{% block content %}
{% set base_url = base_path | default('/console') %}
<div class="p-6" x-data='queueDetailPage({
        basePath: {{ base_url | tojson }},
        mode: {{ page_mode | tojson }},
        model: {{ model_data | tojson }},
        createUrl: {{ create_url | tojson }},
        updateUrl: {{ update_url | tojson }},
        listUrl: {{ list_url | default(create_url) | tojson }}
    })' x-init="init()">
    <div class="mx-auto max-w-4xl space-y-6">
        <header class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
            <div class="space-y-3">
                <a :href="listUrl"
                    class="inline-flex items-center gap-2 text-sm font-medium text-slate-500 hover:text-slate-700">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5l-4 5 4 5" />
                    </svg>
                    Back to queues
                </a>
                <div>
                    <h1 class="text-2xl font-semibold text-slate-900" x-text="pageTitle"></h1>
                    <p class="mt-2 text-sm text-slate-500"
                        x-text="mode === 'create' ? 'Publish a new voice queue with hold prompts and failure handling.' : 'Update hold flow, fallback action, and status for this queue.'">
                    </p>
                </div>
            </div>
            <div class="rounded-xl bg-white p-4 text-sm text-slate-600 shadow-sm ring-1 ring-black/5"
                x-show="mode === 'edit'" x-cloak>
                <div class="flex items-center justify-between gap-4">
                    <div class="font-semibold text-slate-900">Queue summary</div>
                    <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-semibold"
                        :class="form.is_active ? 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-100' : 'bg-amber-50 text-amber-600 ring-1 ring-amber-100'">
                        <span class="h-1.5 w-1.5 rounded-full"
                            :class="form.is_active ? 'bg-emerald-400' : 'bg-amber-400'"></span>
                        <span x-text="form.is_active ? 'Active' : 'Paused'"></span>
                    </span>
                </div>
                <dl class="mt-4 space-y-2 text-xs text-slate-500">
                    <div class="flex items-center justify-between gap-6">
                        <dt class="uppercase tracking-wide">Name</dt>
                        <dd class="text-sm text-slate-700" x-text="form.name || '—'"></dd>
                    </div>
                    <div class="flex items-center justify-between gap-6">
                        <dt class="uppercase tracking-wide">Last updated</dt>
                        <dd class="text-sm text-slate-700" x-text="formatDate(model?.updated_at)"></dd>
                    </div>
                </dl>
            </div>
        </header>

        <template x-if="success">
            <div class="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700"
                x-text="success"></div>
        </template>
        <template x-if="error">
            <div class="rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700" x-text="error">
            </div>
        </template>

        <form class="space-y-6" @submit.prevent="submit">
            <div class="rounded-xl bg-white p-2 shadow-sm ring-1 ring-black/5">
                <div class="flex flex-wrap gap-2">
                    <button type="button" @click="activeTab = 'overview'" :class="tabButtonClasses('overview')">
                        Overview
                    </button>
                    <button type="button" @click="activeTab = 'targets'" :class="tabButtonClasses('targets')">
                        Targets
                    </button>
                    <button type="button" @click="activeTab = 'fallback'" :class="tabButtonClasses('fallback')">
                        Fallback
                    </button>
                </div>
            </div>

            <section class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5" x-show="activeTab === 'overview'"
                x-cloak>
                <h2 class="text-sm font-semibold text-slate-900">Queue basics</h2>
                <div class="mt-4 grid gap-4 md:grid-cols-2">
                    <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                        Queue name
                        <input type="text" x-model.trim="form.name" maxlength="160" required
                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                            placeholder="support-primary">
                        <span class="text-xs font-normal text-slate-400">Used in routing destinations.</span>
                    </label>
                    <div class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                        Status
                        <button type="button" @click="toggleActive()"
                            class="inline-flex items-center gap-2 rounded-lg px-3 py-1 text-xs font-semibold ring-2 transition"
                            :class="form.is_active ? 'bg-emerald-50 text-emerald-600 ring-emerald-200' : 'bg-slate-100 text-slate-500 ring-slate-200'">
                            <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                stroke-width="1.6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l4 4 6-8"
                                    x-show="form.is_active"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l8 8M6 14l8-8"
                                    x-show="!form.is_active"></path>
                            </svg>
                            <span x-text="form.is_active ? 'Active' : 'Paused'"></span>
                        </button>
                        <span class="text-xs font-normal text-slate-400">Paused queues remain available for edits but
                            will not receive calls.</span>
                    </div>
                    <label class="md:col-span-2 flex flex-col gap-2 text-sm font-medium text-slate-700">
                        Description
                        <textarea rows="3" x-model.trim="form.description"
                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                            placeholder="Internal notes for operators."></textarea>
                    </label>
                    <div class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                        Accept immediately
                        <label class="inline-flex items-center gap-2 text-sm font-medium text-slate-700">
                            <input type="checkbox"
                                class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-400"
                                x-model="form.spec.accept_immediately">
                            <span>Bridge caller to agent before hold audio</span>
                        </label>
                    </div>
                    <div class="flex flex-col gap-2 text-sm font-medium text-slate-700"
                        x-show="form.spec.accept_immediately" x-cloak>
                        Remote ringback handling
                        <label class="inline-flex items-start gap-2 text-sm font-medium text-slate-700">
                            <input type="checkbox"
                                class="mt-1 h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-400"
                                x-model="form.spec.passthrough_ringback">
                            <span class="text-sm font-normal text-slate-600">Allow downstream color ring tones to
                                replace hold audio while waiting for agents. Leave unchecked to keep playing queue
                                hold music.</span>
                        </label>
                    </div>
                    <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                        Tags (comma separated)
                        <input type="text" x-model.trim="form.tags_input"
                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                            placeholder="premium, apac, vip">
                    </label>
                </div>
            </section>

            <section class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5" x-show="activeTab === 'overview'"
                x-cloak>
                <div class="flex flex-col gap-1">
                    <h2 class="text-sm font-semibold text-slate-900">Hold treatment</h2>
                    <p class="text-sm text-slate-500">Upload prompts separately and reference the storage path here.
                        Leave blank to fall back to <code
                            class="font-mono text-xs">config/sounds/phone-calling.wav</code>.
                    </p>
                </div>
                <div class="mt-4 space-y-4">
                    <label class="inline-flex items-center gap-2 text-sm font-medium text-slate-700">
                        <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-400"
                            x-model="holdEnabled">
                        <span>Play custom hold audio</span>
                    </label>
                    <div class="grid gap-4 md:grid-cols-2" x-show="holdEnabled" x-cloak>
                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                            Audio file path
                            <input type="text" x-model.trim="form.spec.hold.audio_file"
                                class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="storage://prompts/hold.wav">
                        </label>
                        <label class="inline-flex items-center gap-2 text-sm font-medium text-slate-700">
                            <input type="checkbox"
                                class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-400"
                                x-model="form.spec.hold.loop_playback">
                            Loop playback
                        </label>
                    </div>
                </div>
            </section>

            <section class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5" x-show="activeTab === 'targets'"
                x-cloak>
                <div class="flex flex-col gap-1">
                    <h2 class="text-sm font-semibold text-slate-900">Agent dialing strategy</h2>
                    <p class="text-sm text-slate-500">Define how this queue rings SIP targets in sequence or in parallel
                        before falling back.</p>
                </div>
                <div class="mt-4 space-y-5">
                    <div class="grid gap-4 md:grid-cols-2">
                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                            Dial mode
                            <select x-model="form.spec.strategy.mode"
                                class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200">
                                <option value="sequential">Sequential (hunt)</option>
                                <option value="parallel">Parallel (blast)</option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                            Ring timeout (seconds)
                            <input type="number" min="0" x-model.number="form.spec.strategy.wait_timeout_secs"
                                class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="0">
                            <span class="text-xs font-normal text-slate-400">Set to zero to inherit the route
                                timeout.</span>
                        </label>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-semibold text-slate-800">Dial targets</h3>
                            <button type="button" @click="addStrategyTarget()"
                                class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-50">
                                Add target
                            </button>
                        </div>
                        <template x-if="!form.spec.strategy.targets.length">
                            <p class="text-xs text-slate-400">No targets defined. Add SIP URIs to ring from this queue.
                            </p>
                        </template>
                        <div class="space-y-3">
                            <template x-for="(target, index) in form.spec.strategy.targets" :key="index">
                                <div
                                    class="grid gap-3 rounded-lg border border-slate-200 p-3 md:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)_auto]">
                                    <label
                                        class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-500">
                                        Target URI
                                        <input type="text" x-model.trim="target.uri"
                                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm font-normal text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                            placeholder="sip:agent@pbx.local">
                                    </label>
                                    <label
                                        class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-500">
                                        Label (optional)
                                        <input type="text" x-model.trim="target.label"
                                            class="rounded-lg border border-slate-200 px-3 py-2 text-sm font-normal text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                            placeholder="Tier 1">
                                    </label>
                                    <div class="flex items-end justify-end">
                                        <button type="button" @click="removeStrategyTarget(index)"
                                            class="rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-500 hover:bg-slate-50">
                                            Remove
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </section>

            <section class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5" x-show="activeTab === 'fallback'"
                x-cloak>
                <div class="flex flex-col gap-1">
                    <h2 class="text-sm font-semibold text-slate-900">Fallback behavior</h2>
                    <p class="text-sm text-slate-500">Choose what happens when no agents are available. By default the
                        system plays <code class="font-mono text-xs">config/sounds/unavailable-phone.wav</code> before
                        hanging up.
                    </p>
                </div>
                <div class="mt-4 space-y-4">
                    <div class="flex flex-wrap gap-3">
                        <label class="inline-flex items-center gap-2 text-sm font-medium text-slate-700">
                            <input type="radio" name="queue-fallback" value="none" x-model="fallbackMode"
                                class="h-4 w-4 text-sky-600 focus:ring-sky-400">
                            <span>Continue waiting</span>
                        </label>
                        <label class="inline-flex items-center gap-2 text-sm font-medium text-slate-700">
                            <input type="radio" name="queue-fallback" value="redirect" x-model="fallbackMode"
                                class="h-4 w-4 text-sky-600 focus:ring-sky-400">
                            <span>Redirect to SIP URI</span>
                        </label>
                        <label class="inline-flex items-center gap-2 text-sm font-medium text-slate-700">
                            <input type="radio" name="queue-fallback" value="queue" x-model="fallbackMode"
                                class="h-4 w-4 text-sky-600 focus:ring-sky-400">
                            <span>Send to another queue</span>
                        </label>
                        <label class="inline-flex items-center gap-2 text-sm font-medium text-slate-700">
                            <input type="radio" name="queue-fallback" value="failure" x-model="fallbackMode"
                                class="h-4 w-4 text-sky-600 focus:ring-sky-400">
                            <span>Return failure prompt/code</span>
                        </label>
                    </div>
                    <div class="grid gap-4 md:grid-cols-2" x-show="fallbackMode === 'redirect'" x-cloak>
                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                            Redirect target (SIP URI)
                            <input type="text" x-model.trim="form.spec.fallback.redirect"
                                class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="sip:backup@pbx.local">
                        </label>
                    </div>
                    <div class="grid gap-4 md:grid-cols-2" x-show="fallbackMode === 'failure'" x-cloak>
                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                            SIP failure code
                            <input type="number" min="100" max="699" x-model.number="form.spec.fallback.failure_code"
                                class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="486">
                        </label>
                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                            Failure reason
                            <input type="text" x-model.trim="form.spec.fallback.failure_reason"
                                class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="All agents busy">
                        </label>
                        <label class="md:col-span-2 flex flex-col gap-2 text-sm font-medium text-slate-700">
                            Failure prompt audio
                            <input type="text" x-model.trim="form.spec.fallback.failure_prompt"
                                class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="storage://prompts/queue-full.wav">
                            <span class="text-xs font-normal text-slate-400">Optional audio clip to play before hanging
                                up.</span>
                        </label>
                    </div>
                    <div class="grid gap-4 md:grid-cols-2" x-show="fallbackMode === 'queue'" x-cloak>
                        <label class="flex flex-col gap-2 text-sm font-medium text-slate-700">
                            Queue file path
                            <input type="text" x-model.trim="form.spec.fallback.queue_ref"
                                class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                placeholder="3-support.generated.toml">
                            <span class="text-xs font-normal text-slate-400">Provide the generated queue TOML file
                                (relative to
                                <code class="font-mono">config/queue</code>).</span>
                        </label>
                    </div>
                </div>
            </section>

            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <p class="text-xs text-slate-400">Queue changes apply instantly after saving.</p>
                <div class="flex items-center gap-3">
                    <a :href="listUrl"
                        class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:bg-slate-100">
                        Cancel
                    </a>
                    <button type="submit"
                        class="inline-flex items-center justify-center gap-2 rounded-lg bg-sky-600 px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2"
                        :disabled="saving">
                        <svg class="h-4 w-4 animate-spin" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                            stroke-width="1.6" x-show="saving">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M4 10a6 6 0 0 1 6-6m0-3v3m6 6a6 6 0 0 1-6 6m0 3v-3m9-6h-3M1 10h3m10.95 4.95-2.12-2.12M4.05 5.05l2.12 2.12m0 5.66-2.12 2.12m9.9-9.9 2.12-2.12" />
                        </svg>
                        <span x-text="mode === 'edit' ? 'Save changes' : 'Create queue'"></span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('queueDetailPage', (options) => ({
            basePath: options.basePath || '/console',
            mode: options.mode || 'create',
            model: options.model || null,
            createUrl: options.createUrl || `${options.basePath || '/console'}/queues`,
            updateUrl: options.updateUrl || null,
            listUrl: options.listUrl || `${options.basePath || '/console'}/queues`,
            pageTitle: options.mode === 'edit' ? 'Edit queue' : 'New queue',
            activeTab: 'overview',
            form: {
                name: '',
                description: '',
                is_active: true,
                tags_input: '',
                spec: {
                    accept_immediately: false,
                    passthrough_ringback: false,
                    hold: {
                        audio_file: '',
                        loop_playback: true,
                    },
                    fallback: {
                        redirect: '',
                        failure_code: null,
                        failure_reason: '',
                        failure_prompt: '',
                        queue_ref: '',
                    },
                    strategy: {
                        mode: 'sequential',
                        wait_timeout_secs: null,
                        targets: [],
                    },
                },
            },
            holdEnabled: false,
            fallbackMode: 'none',
            saving: false,
            success: null,
            error: null,
            init() {
                this.applyModel(this.model || {});
            },
            tabButtonClasses(tab) {
                return this.activeTab === tab
                    ? 'rounded-lg bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm'
                    : 'rounded-lg px-4 py-2 text-sm font-semibold text-slate-600 hover:text-slate-900';
            },
            applyModel(model) {
                if (!model || typeof model !== 'object') {
                    return;
                }
                if (model.name) {
                    this.form.name = model.name;
                }
                this.form.description = model.description || '';
                this.form.is_active = model.is_active !== false;
                const tags = Array.isArray(model.tags) ? model.tags : [];
                this.form.tags_input = tags.join(', ');

                const spec = this.normalizeSpec(model.spec || {});
                this.form.spec = spec;
                this.holdEnabled = Boolean(spec.hold && (spec.hold.audio_file || spec.hold.loop_playback === false));
                this.fallbackMode = this.detectFallbackMode(spec.fallback);
                this.pageTitle = this.mode === 'edit'
                    ? (model.name ? `Edit ${model.name}` : 'Edit queue')
                    : 'New queue';
            },
            normalizeSpec(raw) {
                const spec = {
                    accept_immediately: Boolean(raw.accept_immediately),
                    passthrough_ringback: Boolean(raw.passthrough_ringback),
                    hold: {
                        audio_file: raw?.hold?.audio_file || '',
                        loop_playback: raw?.hold?.loop_playback !== false,
                    },
                    fallback: {
                        redirect: raw?.fallback?.redirect || '',
                        failure_code: raw?.fallback?.failure_code || null,
                        failure_reason: raw?.fallback?.failure_reason || '',
                        failure_prompt: raw?.fallback?.failure_prompt || '',
                        queue_ref: raw?.fallback?.queue_ref || '',
                    },
                    strategy: {
                        mode: raw?.strategy?.mode === 'parallel' ? 'parallel' : 'sequential',
                        wait_timeout_secs: Number.isFinite(Number(raw?.strategy?.wait_timeout_secs))
                            ? Number(raw.strategy.wait_timeout_secs)
                            : null,
                        targets: Array.isArray(raw?.strategy?.targets)
                            ? raw.strategy.targets
                                .map((target) => ({
                                    uri: (target?.uri || '').trim(),
                                    label: (target?.label || '').trim(),
                                }))
                                .filter((target) => target.uri)
                            : [],
                    },
                };
                return spec;
            },
            detectFallbackMode(fallback) {
                if ((fallback?.queue_ref || '').trim()) {
                    return 'queue';
                }
                if (fallback?.redirect) {
                    return 'redirect';
                }
                if (fallback && (fallback.failure_code || fallback.failure_prompt || fallback.failure_reason)) {
                    return 'failure';
                }
                return 'none';
            },
            toggleActive() {
                this.form.is_active = !this.form.is_active;
            },
            tagList() {
                const parts = (this.form.tags_input || '')
                    .split(',')
                    .map((part) => part.trim())
                    .filter(Boolean);
                const unique = [];
                parts.forEach((value) => {
                    if (!unique.some((existing) => existing.toLowerCase() === value.toLowerCase())) {
                        unique.push(value);
                    }
                });
                return unique;
            },
            addStrategyTarget() {
                if (!Array.isArray(this.form.spec.strategy.targets)) {
                    this.form.spec.strategy.targets = [];
                }
                this.form.spec.strategy.targets.push({ uri: '', label: '' });
            },
            removeStrategyTarget(index) {
                if (!Array.isArray(this.form.spec.strategy.targets)) {
                    return;
                }
                this.form.spec.strategy.targets.splice(index, 1);
            },
            prepareSpec() {
                const spec = {
                    accept_immediately: Boolean(this.form.spec.accept_immediately),
                    passthrough_ringback: Boolean(this.form.spec.passthrough_ringback && this.form.spec.accept_immediately),
                };
                if (this.holdEnabled) {
                    const audio = (this.form.spec.hold?.audio_file || '').trim();
                    if (audio) {
                        spec.hold = {
                            audio_file: audio,
                            loop_playback: this.form.spec.hold?.loop_playback !== false,
                        };
                    }
                }
                if (this.fallbackMode === 'redirect') {
                    const target = (this.form.spec.fallback?.redirect || '').trim();
                    if (target) {
                        spec.fallback = { redirect: target };
                    }
                } else if (this.fallbackMode === 'queue') {
                    const queueRef = (this.form.spec.fallback?.queue_ref || '').trim();
                    if (queueRef) {
                        spec.fallback = { queue_ref: queueRef };
                    }
                } else if (this.fallbackMode === 'failure') {
                    const code = Number(this.form.spec.fallback?.failure_code);
                    const payload = {
                        failure_code: Number.isFinite(code) ? code : null,
                        failure_reason: (this.form.spec.fallback?.failure_reason || '').trim() || null,
                        failure_prompt: (this.form.spec.fallback?.failure_prompt || '').trim() || null,
                    };
                    if (payload.failure_code || payload.failure_reason || payload.failure_prompt) {
                        spec.fallback = payload;
                    }
                }

                const strategyMode = this.form.spec.strategy?.mode === 'parallel' ? 'parallel' : 'sequential';
                const targets = (this.form.spec.strategy?.targets || [])
                    .map((target) => ({
                        uri: (target.uri || '').trim(),
                        label: (target.label || '').trim() || null,
                    }))
                    .filter((target) => target.uri);
                const waitTimeoutRaw = Number(this.form.spec.strategy?.wait_timeout_secs);
                const waitTimeout = Number.isFinite(waitTimeoutRaw) && waitTimeoutRaw > 0
                    ? Math.trunc(waitTimeoutRaw)
                    : null;
                if (targets.length || waitTimeout !== null || strategyMode === 'parallel') {
                    spec.strategy = {
                        mode: strategyMode,
                        wait_timeout_secs: waitTimeout,
                        targets,
                    };
                }
                return spec;
            },
            buildPayload() {
                return {
                    name: this.form.name?.trim(),
                    description: this.form.description?.trim() || null,
                    is_active: Boolean(this.form.is_active),
                    tags: this.tagList(),
                    spec: this.prepareSpec(),
                };
            },
            async submit() {
                this.saving = true;
                this.success = null;
                this.error = null;
                try {
                    const payload = this.buildPayload();
                    const isEdit = this.mode === 'edit';
                    const endpoint = isEdit && this.updateUrl ? this.updateUrl : this.createUrl;
                    const method = isEdit ? 'PATCH' : 'PUT';
                    const response = await fetch(endpoint, {
                        method,
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.message || 'Failed to save queue');
                    }
                    this.success = isEdit ? 'Queue updated.' : 'Queue created.';
                    if (!isEdit && data?.id) {
                        window.location.href = `${this.basePath}/queues/${data.id}`;
                        return;
                    }
                } catch (err) {
                    console.error(err);
                    this.error = err?.message || 'Failed to save queue';
                } finally {
                    this.saving = false;
                }
            },
            formatDate(value) {
                if (!value) return '—';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return value;
                }
                return date.toLocaleString();
            },
        }));
    });
</script>
{% endblock %}