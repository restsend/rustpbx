{% extends "console/layout.html" %}
{% block title %}SIP Trunk Detail · {{site_name|default('RustPBX')}}{% endblock %}
{% block content %}
<div class="p-6">
    <div class="mx-auto max-w-6xl space-y-6" x-data="sipTrunkDetail({{ trunk_data | escape }})">
        <header class="flex flex-col gap-4 border-b border-slate-200 pb-4 md:flex-row md:items-end md:justify-between">
            <div class="space-y-2">
                <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-sky-600">
                    <span>SIP trunk</span>
                    <span class="text-slate-400">/</span>
                    <span x-text="trunk.name"></span>
                </div>
                <h1 class="text-3xl font-semibold text-slate-900" x-text="trunk.display_name || trunk.name"></h1>
                <p class="text-sm text-slate-500" x-text="trunk.dest"></p>
                <div class="flex flex-wrap items-center gap-2 text-xs font-semibold">
                    <span class="inline-flex items-center gap-1 rounded-full px-3 py-1"
                        :class="statusClasses(trunk.status)">
                        <span class="h-1.5 w-1.5 rounded-full" :class="statusDot(trunk.status)"></span>
                        <span x-text="statusLabel(trunk.status)"></span>
                    </span>
                    <template x-for="dir in trunk.direction || []" :key="dir">
                        <span
                            class="inline-flex items-center rounded-full bg-sky-50 px-3 py-1 text-[11px] font-semibold text-sky-700"
                            x-text="directionLabel(dir)"></span>
                    </template>
                    <span
                        class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600"
                        x-text="trunk.carrier"></span>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3 text-sm">
                <a :href="backUrl"
                    class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5l-5 5 5 5" />
                    </svg>
                    Back to list
                </a>
                <button type="button"
                    class="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-4 py-2 font-semibold text-white shadow-sm transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 4v12m6-6H4" />
                    </svg>
                    Clone trunk
                </button>
            </div>
        </header>

        <section class="grid gap-4 md:grid-cols-3">
            <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-black/5">
                <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">Utilisation</div>
                <div class="mt-3 flex items-baseline gap-2">
                    <span class="text-3xl font-semibold text-slate-900"
                        x-text="summary.utilisation_percent + '%'"></span>
                </div>
                <p class="mt-2 text-xs text-slate-500">Consumed minutes vs included allowance this billing period.</p>
                <div class="mt-4 h-2 rounded-full bg-slate-200">
                    <div class="h-2 rounded-full bg-sky-500"
                        :style="{ width: Math.min(summary.utilisation_percent, 100) + '%' }"></div>
                </div>
            </div>
            <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-black/5">
                <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">Current cost</div>
                <div class="mt-3 text-3xl font-semibold text-slate-900"
                    x-text="formatCurrency(summary.current_cost, trunk.billing?.currency)"></div>
                <p class="mt-2 text-xs text-slate-500">Charges accrued during <span
                        x-text="trunk.billing?.usage?.current?.period || 'this period'"></span>.</p>
            </div>
            <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-black/5">
                <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">Minutes used</div>
                <div class="mt-3 text-3xl font-semibold text-slate-900" x-text="formatNumber(summary.current_minutes)">
                </div>
                <p class="mt-2 text-xs text-slate-500">Minutes consumed across all routes for this trunk.</p>
            </div>
        </section>

        <section class="grid gap-4 lg:grid-cols-[1.2fr_0.8fr]">
            <div class="space-y-4">
                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <div class="flex items-center justify-between">
                        <h2 class="text-base font-semibold text-slate-900">Access control</h2>
                        <span class="text-xs text-slate-500"
                            x-text="(trunk.ip_whitelist || []).length + ' allowed IPs'"></span>
                    </div>
                    <p class="mt-1 text-xs text-slate-500">Review the edge IPs permitted to originate calls on this
                        carrier.</p>
                    <table class="mt-4 w-full table-auto text-left text-sm text-slate-600">
                        <thead class="text-xs uppercase tracking-wide text-slate-400">
                            <tr>
                                <th class="pb-2">Label</th>
                                <th class="pb-2">CIDR</th>
                                <th class="pb-2">Notes</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <template x-for="item in trunk.ip_whitelist || []" :key="item.cidr">
                                <tr>
                                    <td class="py-2 font-medium text-slate-700" x-text="item.label || '—'"></td>
                                    <td class="py-2 font-mono text-xs" x-text="item.cidr"></td>
                                    <td class="py-2 text-xs text-slate-500" x-text="item.note || 'Carrier POP'"></td>
                                </tr>
                            </template>
                            <template x-if="!(trunk.ip_whitelist || []).length">
                                <tr>
                                    <td colspan="3" class="py-6 text-center text-xs text-slate-400">No IP whitelist
                                        defined.</td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <div class="flex items-center justify-between">
                        <h2 class="text-base font-semibold text-slate-900">DID inventory</h2>
                        <span class="text-xs text-slate-500"
                            x-text="(trunk.did_numbers || []).length + ' numbers'"></span>
                    </div>
                    <p class="mt-1 text-xs text-slate-500">Assigned numbers and routing labels for inbound distribution.
                    </p>
                    <div class="mt-4 grid gap-3 sm:grid-cols-2">
                        <template x-for="did in trunk.did_numbers || []" :key="did.number">
                            <div class="rounded-lg border border-slate-200 p-3">
                                <div class="text-sm font-semibold text-slate-800" x-text="did.number"></div>
                                <div class="text-xs text-slate-500" x-text="did.label || 'Uncategorised'"></div>
                            </div>
                        </template>
                        <template x-if="!(trunk.did_numbers || []).length">
                            <div
                                class="rounded-lg border border-dashed border-slate-200 p-6 text-center text-xs text-slate-400">
                                No DIDs assigned.
                            </div>
                        </template>
                    </div>
                </div>

                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <div class="flex items-center justify-between">
                        <h2 class="text-base font-semibold text-slate-900">Capacity limits</h2>
                        <div class="flex gap-2 text-xs text-slate-500">
                            <span>Max CPS: <span class="font-semibold text-slate-800"
                                    x-text="trunk.limits?.max_cps ?? trunk.max_cps ?? '—'"></span></span>
                            <span>Concurrent: <span class="font-semibold text-slate-800"
                                    x-text="trunk.limits?.max_concurrent ?? trunk.max_calls ?? '—'"></span></span>
                            <span>Duration: <span class="font-semibold text-slate-800"
                                    x-text="formatDuration(trunk.limits?.max_call_duration)"></span></span>
                        </div>
                    </div>
                    <p class="mt-1 text-xs text-slate-500">Combined hard limits from carrier contract and PBX throttling
                        policy.</p>
                    <div class="mt-4 grid gap-4 sm:grid-cols-3">
                        <div class="rounded-lg border border-slate-200 p-4 text-xs text-slate-500">
                            <div class="text-sm font-semibold text-slate-800">Burst CPS</div>
                            <p class="mt-2">Peak calls per second allowed before queuing. Useful for outbound campaigns.
                            </p>
                        </div>
                        <div class="rounded-lg border border-slate-200 p-4 text-xs text-slate-500">
                            <div class="text-sm font-semibold text-slate-800">Concurrent calls</div>
                            <p class="mt-2">Carrier enforced channel capacity across all media streams.</p>
                        </div>
                        <div class="rounded-lg border border-slate-200 p-4 text-xs text-slate-500">
                            <div class="text-sm font-semibold text-slate-800">Max duration</div>
                            <p class="mt-2">Longest call duration in seconds before enforced release.</p>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="space-y-4">
                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <div class="flex items-center justify-between">
                        <h2 class="text-base font-semibold text-slate-900">Default routing</h2>
                        <a class="inline-flex items-center gap-1 text-xs font-semibold text-sky-600 hover:text-sky-500"
                            :href="trunk.default_route?.url || '#'">
                            View rule
                            <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                stroke-width="1.6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7 5l6 5-6 5" />
                            </svg>
                        </a>
                    </div>
                    <p class="mt-1 text-xs text-slate-500">Primary routing rule applied to calls sourced from this
                        carrier.</p>
                    <div class="mt-4 space-y-3 text-sm text-slate-600">
                        <div class="rounded-lg border border-slate-200 p-3">
                            <div class="font-semibold text-slate-800"
                                x-text="trunk.default_route?.name || 'Not assigned'"></div>
                            <div class="text-xs text-slate-500"
                                x-text="'Priority ' + (trunk.default_route?.priority ?? '—')"></div>
                            <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-500">
                                <span class="rounded-full bg-slate-100 px-2 py-0.5 font-medium"
                                    x-text="trunk.default_route?.strategy || 'Unknown strategy'"></span>
                                <template x-for="fallback in trunk.default_route?.fallbacks || []" :key="fallback.name">
                                    <span
                                        class="inline-flex items-center gap-1 rounded-full bg-slate-50 px-2 py-0.5 font-medium text-slate-700">
                                        <span x-text="fallback.name"></span>
                                        <span class="text-[11px] text-slate-400" x-text="'w' + fallback.weight"></span>
                                    </span>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <h2 class="text-base font-semibold text-slate-900">Billing template</h2>
                    <p class="mt-1 text-xs text-slate-500">Understand allowance usage and recent spend.</p>
                    <div class="mt-4 space-y-3 text-sm text-slate-600">
                        <div class="rounded-lg border border-slate-200 p-3">
                            <div class="font-semibold text-slate-800"
                                x-text="trunk.billing?.template_name || 'Not linked'"></div>
                            <div class="text-xs text-slate-500"
                                x-text="trunk.billing?.template_id ? ('Template ID · ' + trunk.billing.template_id) : 'No template ID'">
                            </div>
                        </div>
                        <div class="rounded-lg border border-slate-200 p-3">
                            <div class="flex items-center justify-between text-xs text-slate-500">
                                <span>Current period</span>
                                <span x-text="trunk.billing?.usage?.current?.period || '—'"></span>
                            </div>
                            <div class="mt-2 flex items-center justify-between text-sm font-semibold text-slate-800">
                                <span x-text="formatNumber(trunk.billing?.usage?.current?.minutes) + ' minutes'"></span>
                                <span
                                    x-text="formatCurrency(trunk.billing?.usage?.current?.cost, trunk.billing?.currency)"></span>
                            </div>
                            <div class="mt-2 h-2 rounded-full bg-slate-200">
                                <div class="h-2 rounded-full bg-emerald-500"
                                    :style="{ width: currentUtilisationWidth }"></div>
                            </div>
                        </div>
                        <div class="rounded-lg border border-slate-200 p-3 text-xs text-slate-500">
                            <div class="flex items-center justify-between">
                                <span>Last 30 days</span>
                                <span
                                    x-text="formatNumber(trunk.billing?.usage?.last_30_days?.minutes) + ' min'"></span>
                            </div>
                            <div class="mt-2 flex items-center justify-between text-sm font-semibold text-slate-800">
                                <span x-text="(trunk.billing?.usage?.last_30_days?.calls || 0) + ' calls'"></span>
                                <span
                                    x-text="formatCurrency(trunk.billing?.usage?.last_30_days?.cost, trunk.billing?.currency)"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <h2 class="text-base font-semibold text-slate-900">Operational insights</h2>
                    <div class="mt-3 space-y-4 text-sm text-slate-600">
                        <div>
                            <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Call distribution
                            </h3>
                            <div class="mt-2 space-y-2">
                                <template x-for="slice in trunk.analytics?.call_distribution || []" :key="slice.label">
                                    <div class="space-y-1">
                                        <div class="flex items-center justify-between text-xs text-slate-500">
                                            <span x-text="slice.label"></span>
                                            <span class="font-semibold text-slate-800"
                                                x-text="slice.value + '%' "></span>
                                        </div>
                                        <div class="h-2 rounded-full bg-slate-200">
                                            <div class="h-2 rounded-full bg-sky-500"
                                                :style="{ width: slice.value + '%' }"></div>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="!(trunk.analytics?.call_distribution || []).length">
                                    <div
                                        class="rounded-lg border border-dashed border-slate-200 p-4 text-xs text-slate-400">
                                        No distribution data available.
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Recent events</h3>
                            <ul class="mt-2 space-y-2">
                                <template x-for="event in trunk.analytics?.recent_events || []" :key="event.timestamp">
                                    <li class="rounded-lg border border-slate-200 px-3 py-2 text-xs text-slate-500">
                                        <div class="flex items-center justify-between">
                                            <span class="font-semibold text-slate-700" x-text="event.type"></span>
                                            <span x-text="formatTimestamp(event.timestamp)"></span>
                                        </div>
                                        <p class="mt-1" x-text="event.message"></p>
                                    </li>
                                </template>
                                <template x-if="!(trunk.analytics?.recent_events || []).length">
                                    <li
                                        class="rounded-lg border border-dashed border-slate-200 px-3 py-6 text-center text-xs text-slate-400">
                                        No recent events logged.
                                    </li>
                                </template>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Quality history
                            </h3>
                            <div class="mt-2 space-y-2 text-xs text-slate-500">
                                <template x-for="row in trunk.analytics?.quality_history || []" :key="row.period">
                                    <div class="rounded-lg border border-slate-200 p-3">
                                        <div class="flex items-center justify-between text-slate-600">
                                            <span class="font-semibold text-slate-700" x-text="row.period"></span>
                                            <span>Latency <span class="font-semibold text-slate-800"
                                                    x-text="row.latency + ' ms'"></span></span>
                                        </div>
                                        <div class="mt-1 flex items-center justify-between">
                                            <span>Availability <span class="font-semibold text-slate-800"
                                                    x-text="row.availability + '%'"></span></span>
                                            <span>Loss <span class="font-semibold text-slate-800"
                                                    x-text="row.loss + '%'"></span></span>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="!(trunk.analytics?.quality_history || []).length">
                                    <div
                                        class="rounded-lg border border-dashed border-slate-200 p-4 text-center text-xs text-slate-400">
                                        No historical telemetry provided.
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </section>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('sipTrunkDetail', (payload) => ({
            init() {
                const data = typeof payload === 'string' ? JSON.parse(payload || '{}') : (payload || {});
                this.trunk = data.trunk || {};
                this.summary = data.summary || {};
                this.backUrl = data.back_url || '#';
                const utilisation = this.trunk?.billing?.usage?.current?.minutes || 0;
                const included = this.trunk?.billing?.usage?.current?.included_minutes || 0;
                const ratio = included ? Math.min(100, Math.round((utilisation / included) * 100)) : 0;
                this.currentUtilisationWidth = ratio + '%';
            },
            trunk: {},
            summary: {},
            backUrl: '#',
            currentUtilisationWidth: '0%',
            statusLabel(status) {
                switch ((status || '').toLowerCase()) {
                    case 'healthy':
                        return 'Healthy';
                    case 'warning':
                        return 'Warning';
                    case 'standby':
                        return 'Standby';
                    default:
                        return status || 'Unknown';
                }
            },
            statusClasses(status) {
                switch ((status || '').toLowerCase()) {
                    case 'healthy':
                        return 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200';
                    case 'warning':
                        return 'bg-amber-50 text-amber-600 ring-1 ring-amber-200';
                    case 'standby':
                        return 'bg-slate-100 text-slate-600 ring-1 ring-slate-200';
                    default:
                        return 'bg-slate-100 text-slate-600 ring-1 ring-slate-200';
                }
            },
            statusDot(status) {
                switch ((status || '').toLowerCase()) {
                    case 'healthy':
                        return 'bg-emerald-500';
                    case 'warning':
                        return 'bg-amber-500';
                    case 'standby':
                        return 'bg-slate-400';
                    default:
                        return 'bg-slate-400';
                }
            },
            directionLabel(value) {
                switch ((value || '').toLowerCase()) {
                    case 'inbound':
                        return 'Inbound';
                    case 'outbound':
                        return 'Outbound';
                    case 'bidirectional':
                        return 'Bi-directional';
                    default:
                        return value || 'Unknown';
                }
            },
            formatNumber(value) {
                if (value === null || value === undefined || Number.isNaN(Number(value))) {
                    return '—';
                }
                if (value >= 1000) {
                    return Number(value).toLocaleString();
                }
                return Number(value).toFixed(Number(value) % 1 === 0 ? 0 : 1);
            },
            formatDuration(value) {
                const duration = Number(value || 0);
                if (!duration) {
                    return '—';
                }
                if (duration >= 3600) {
                    return `${Math.round(duration / 60)} min`;
                }
                if (duration >= 60) {
                    return `${Math.round(duration / 60)} min`;
                }
                return `${duration} sec`;
            },
            formatCurrency(amount, currency) {
                if (amount === null || amount === undefined || Number.isNaN(Number(amount))) {
                    return currency ? `${currency}0.00` : '0.00';
                }
                const value = Number(amount).toFixed(2);
                return currency ? `${currency}${value}` : value;
            },
            formatTimestamp(value) {
                if (!value) {
                    return '—';
                }
                try {
                    const date = new Date(value);
                    if (Number.isNaN(date.getTime())) {
                        return value;
                    }
                    return date.toLocaleString();
                } catch (err) {
                    return value;
                }
            },
        }));
    });
</script>
{% endblock %}