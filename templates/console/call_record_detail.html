{% extends "console/layout.html" %}
{% block title %}Call Record Detail · {{site_name|default('RustPBX')}}{% endblock %}
{% block content %}
<div class="p-6">
    <div class="mx-auto max-w-6xl space-y-6" x-data="callRecordDetail({{ call_data | escape }})">
        <header class="flex flex-col gap-4 border-b border-slate-200 pb-4 md:flex-row md:items-end md:justify-between">
            <div class="space-y-2">
                <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-sky-600">
                    <a :href="backUrl"
                        class="inline-flex items-center gap-1 text-slate-500 transition hover:text-sky-600">
                        <svg class="h-3 w-3" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 5l-5 5 5 5" />
                        </svg>
                        Back
                    </a>
                    <span>/</span>
                    <span x-text="record.display_id || record.id"></span>
                </div>
                <h1 class="text-3xl font-semibold text-slate-900">
                    <span>#</span>
                    <span x-text="record.display_id || record.id"></span>
                </h1>
                <div class="flex items-center gap-2 text-xs text-slate-500">
                    <span>Call-Id</span>
                    <span class="font-mono" :title="record.call_id" x-text="record.call_id || '—'"></span>
                    <template x-if="record.call_id">
                        <div class="flex items-center gap-1">
                            <button type="button"
                                class="inline-flex h-5 w-5 items-center justify-center rounded border border-slate-200 text-slate-400 transition hover:border-slate-300 hover:text-slate-600"
                                title="Copy call ID" aria-label="Copy call ID" @click="copyCallId(record.call_id)">
                                <svg class="h-3 w-3" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                    stroke-width="1.6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h8v8H6z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h8" />
                                </svg>
                            </button>
                            <span class="text-[10px] font-semibold text-emerald-600"
                                x-show="copiedCallId === record.call_id" x-transition.opacity>Copied</span>
                        </div>
                    </template>
                </div>
                <p class="text-sm text-slate-500" x-text="formatDateTime(record.started_at)"></p>
                <div class="flex flex-wrap items-center gap-2 text-xs font-semibold">
                    <span class="inline-flex items-center gap-1 rounded-full px-3 py-1"
                        :class="statusClasses(record.status)">
                        <span class="h-1.5 w-1.5 rounded-full" :class="statusDot(record.status)"></span>
                        <span x-text="statusLabel(record.status)"></span>
                    </span>
                    <span class="inline-flex items-center gap-1 rounded-full px-3 py-1"
                        :class="directionClasses(record.direction)">
                        <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                            stroke-width="1.6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10h10M10 5l5 5-5 5" />
                        </svg>
                        <span x-text="directionLabel(record.direction)"></span>
                    </span>
                    <span
                        class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600">
                        <svg class="h-3 w-3" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h12v12H4z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 4v12M12 8h4" />
                        </svg>
                        <span x-text="record.sip_gateway || '—'"></span>
                    </span>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3 text-sm">
                <a :href="actions.download_metadata || '#'"
                    class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 12l6 6 6-6" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 18V4" />
                    </svg>
                    Metadata JSON
                </a>
                <a :href="actions.download_sip_flow || '#'"
                    class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h12v12H4z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 8h8M6 12h4" />
                    </svg>
                    SIP trace JSON
                </a>
            </div>
        </header>

        <section class="grid gap-4 sm:grid-cols-4">
            <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-black/5">
                <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">Duration</div>
                <div class="mt-2 text-2xl font-semibold text-slate-900" x-text="formatDuration(record.duration_secs)">
                </div>
                <p class="mt-1 text-xs text-slate-500" x-text="durationHint"></p>
            </div>
            <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-black/5">
                <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">Quality (MOS)</div>
                <div class="mt-2 text-2xl font-semibold" :class="qualityTone(record.quality?.mos)"
                    x-text="formatNumber(record.quality?.mos)"></div>
                <p class="mt-1 text-xs text-slate-500">Packet loss <span class="font-semibold"
                        x-text="formatNumber(record.quality?.packet_loss) + '%'"></span> · Jitter <span
                        class="font-semibold" x-text="formatNumber(record.quality?.jitter_ms) + ' ms'"></span></p>
            </div>
            <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-black/5">
                <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">Transcript</div>
                <div class="mt-2 flex items-center gap-2 text-2xl font-semibold"
                    :class="transcript.available || transcriptVisible ? 'text-emerald-600' : 'text-slate-400'">
                    <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 12l5 5L20 7" />
                    </svg>
                    <span x-text="transcript.available || transcriptVisible ? 'Ready' : 'Pending'"></span>
                </div>
                <p class="mt-1 text-xs text-slate-500"
                    x-text="transcript.available || transcriptVisible ? 'Generated '+(transcript.generated_at || '') : 'Request on demand to analyse conversation outcome.'">
                </p>
            </div>
            <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-black/5">
                <div class="text-xs font-semibold uppercase tracking-wide text-slate-400">Billing</div>
                <div class="mt-2 flex items-center justify-between gap-2">
                    <span class="text-2xl font-semibold text-slate-900"
                        x-text="formatBillingAmount(record.billing)"></span>
                    <span class="text-xs font-semibold uppercase text-slate-400"
                        x-text="(record.billing && record.billing.currency) ? record.billing.currency : ''"></span>
                </div>
                <div class="mt-2 inline-flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-semibold"
                        :class="billingStatusClasses(record.billing?.status)">
                        <span x-text="billingStatusLabel(record.billing?.status)"></span>
                    </span>
                    <span class="text-[11px] text-slate-500" x-text="formatBillingMinutes(record.billing)"></span>
                </div>
                <p class="mt-1 text-xs text-slate-500"
                    x-text="billing?.summary?.rate_per_minute !== undefined ? ('Rate ' + formatCurrency(billing.summary.rate_per_minute, billing.summary.currency)) : 'Real-time charge capture.'">
                </p>
            </div>
        </section>

        <section class="space-y-5">
            <div class="rounded-xl bg-white p-3 shadow-sm ring-1 ring-black/5">
                <nav class="inline-flex w-full flex-wrap gap-2 rounded-lg border border-slate-200 bg-slate-50 p-1 text-xs font-semibold text-slate-600"
                    role="tablist" aria-label="Call record detail tabs">
                    <button type="button" class="flex-1 rounded-md px-4 py-2 text-left transition sm:flex-none"
                        :class="detailTab === 'overview' ? 'bg-white text-sky-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'"
                        :aria-selected="detailTab === 'overview'" aria-controls="call-record-tab-overview"
                        @click="detailTab = 'overview'">
                        <div class="flex flex-col">
                            <span class="text-sm">Overview</span>
                            <span class="text-[11px] font-normal text-slate-400">Participants, media, notes</span>
                        </div>
                    </button>
                    <button type="button" class="flex-1 rounded-md px-4 py-2 text-left transition sm:flex-none"
                        :class="detailTab === 'diagnostics' ? 'bg-white text-sky-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'"
                        :aria-selected="detailTab === 'diagnostics'" aria-controls="call-record-tab-diagnostics"
                        @click="detailTab = 'diagnostics'">
                        <div class="flex flex-col">
                            <span class="text-sm">Diagnostics</span>
                            <span class="text-[11px] font-normal text-slate-400">ASR, SIP flow, metrics</span>
                        </div>
                    </button>
                </nav>
            </div>

            <div x-show="detailTab === 'overview'" x-cloak x-transition.opacity class="space-y-4"
                id="call-record-tab-overview" role="tabpanel" tabindex="0">
                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <h2 class="text-base font-semibold text-slate-900">Recording & participants</h2>
                    <p class="mt-1 text-xs text-slate-500">Validate caller identification, agent mapping, and playback
                        the original media stream.</p>
                    <template x-if="record.recording && record.recording.url">
                        <audio class="mt-4 w-full" controls preload="none" :src="record.recording.url"></audio>
                    </template>
                    <template x-if="!record.recording || !record.recording.url">
                        <div
                            class="mt-4 rounded-lg border border-dashed border-slate-200 px-4 py-6 text-center text-xs text-slate-400">
                            No media recording stored for this session.
                        </div>
                    </template>
                    <div class="mt-6 grid gap-3 sm:grid-cols-2">
                        <template x-for="participant in participants" :key="participant.role">
                            <div class="rounded-lg border border-slate-200 p-3 text-sm text-slate-600">
                                <div class="flex items-center justify-between text-xs text-slate-400">
                                    <span x-text="participant.label"></span>
                                    <span class="rounded-full bg-slate-100 px-2 py-0.5 font-semibold text-slate-600"
                                        x-text="participant.network"></span>
                                </div>
                                <div class="mt-1 text-sm font-semibold text-slate-900" x-text="participant.name || '—'">
                                </div>
                                <template x-if="participant.role === 'caller' || participant.role === 'callee'">
                                    <div
                                        class="mt-3 space-y-1 rounded border border-dashed border-slate-200 px-3 py-2 text-[11px] text-slate-500">
                                        <div class="flex items-center justify-between">
                                            <span class="font-semibold text-slate-600">Original</span>
                                            <span class="font-mono"
                                                x-text="(rewrite[participant.role] && rewrite[participant.role].original) || '—'"></span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="font-semibold text-slate-600">Rewrite</span>
                                            <span class="font-mono"
                                                x-text="(rewrite[participant.role] && rewrite[participant.role].final) || '—'"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="grid gap-4 lg:grid-cols-2">
                    <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <h2 class="text-base font-semibold text-slate-900">Tags</h2>
                                <p class="text-xs text-slate-500">Label conversations for follow-up workflows.</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="text" x-model.trim="tagInput"
                                    class="rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                                    placeholder="Add tag">
                                <button type="button"
                                    class="inline-flex items-center rounded-lg bg-sky-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2"
                                    @click="addTag">Add</button>
                            </div>
                        </div>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <template x-for="(tag, index) in (record.tags || [])" :key="tag + index">
                                <span
                                    class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-sm text-slate-600">
                                    <span x-text="tag"></span>
                                    <button type="button" class="text-slate-400 transition hover:text-rose-500"
                                        @click="removeTag(index)">
                                        <svg class="h-3 w-3" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                            stroke-width="1.6">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M6 6l8 8M6 14L14 6" />
                                        </svg>
                                    </button>
                                </span>
                            </template>
                            <template x-if="!(record.tags || []).length">
                                <span class="rounded-full bg-slate-100 px-3 py-1 text-sm text-slate-400">No tags
                                    yet</span>
                            </template>
                        </div>
                    </div>

                    <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <h2 class="text-base font-semibold text-slate-900">Call notes</h2>
                                <p class="text-xs text-slate-500">Document commitments, escalations, or customer
                                    sentiment.</p>
                            </div>
                            <button type="button"
                                class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-600 transition hover:border-sky-300 hover:text-sky-700"
                                @click="saveNotes">
                                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                                    stroke-width="1.6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h12v12H4z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 10h8M6 14h5M6 6h8" />
                                </svg>
                                Save note
                            </button>
                        </div>
                        <textarea x-model="noteDraft" rows="6"
                            class="mt-3 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-200"
                            placeholder="Add internal remark or follow-up task..."></textarea>
                        <p class="mt-2 text-xs text-slate-400" x-show="notes.updated_at">
                            Last updated <span x-text="formatDateTime(notes.updated_at)"></span>
                        </p>
                    </div>
                    <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5 lg:col-span-2">
                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <h2 class="text-base font-semibold text-slate-900">Billing details</h2>
                                <p class="text-xs text-slate-500">Snapshot of increments, rate, and totals at hangup.
                                </p>
                            </div>
                        </div>
                        <div class="mt-4 grid gap-4 sm:grid-cols-2">
                            <dl class="space-y-2 text-sm text-slate-600">
                                <div class="flex items-center justify-between">
                                    <dt>Status</dt>
                                    <dd>
                                        <span
                                            class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-semibold"
                                            :class="billingStatusClasses(billing.summary?.status || record.billing?.status)">
                                            <span
                                                x-text="billingStatusLabel(billing.summary?.status || record.billing?.status)"></span>
                                        </span>
                                    </dd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <dt>Billable seconds</dt>
                                    <dd x-text="billing.summary?.billable_secs ?? record.billing?.billable_secs ?? '—'">
                                    </dd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <dt>Billable minutes</dt>
                                    <dd x-text="formatBillingMinutes(billing.summary || record.billing)"></dd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <dt>Rate / min</dt>
                                    <dd
                                        x-text="billing.summary?.rate_per_minute !== undefined ? formatCurrency(billing.summary.rate_per_minute, billing.summary?.currency || record.billing?.currency) : '—'">
                                    </dd>
                                </div>
                            </dl>
                            <dl class="space-y-2 text-sm text-slate-600">
                                <div class="flex items-center justify-between">
                                    <dt>Subtotal</dt>
                                    <dd
                                        x-text="billing.summary?.amount?.subtotal !== undefined ? formatCurrency(billing.summary.amount.subtotal, billing.summary?.currency || record.billing?.currency) : '—'">
                                    </dd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <dt>Tax</dt>
                                    <dd
                                        x-text="billing.summary?.amount?.tax !== undefined ? formatCurrency(billing.summary.amount.tax, billing.summary?.currency || record.billing?.currency) : '—'">
                                    </dd>
                                </div>
                                <div class="flex items-center justify-between font-semibold">
                                    <dt>Total</dt>
                                    <dd x-text="formatBillingAmount(billing.summary || record.billing)"></dd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <dt>Increments</dt>
                                    <dd
                                        x-text="billing.summary?.increments ? (billing.summary.increments.initial_secs + ' / ' + billing.summary.increments.billing_secs + ' s') : '—'">
                                    </dd>
                                </div>
                            </dl>
                        </div>
                        <template x-if="billing.result">
                            <details
                                class="mt-4 space-y-2 rounded-lg border border-slate-200 bg-slate-50 p-3 text-[11px] text-slate-600">
                                <summary class="cursor-pointer text-xs font-semibold text-slate-500">Computation trace
                                </summary>
                                <pre class="max-h-48 overflow-auto rounded bg-white/70 p-3"
                                    x-text="formatJson(billing.result)"></pre>
                            </details>
                        </template>
                        <template x-if="billing.snapshot">
                            <details
                                class="mt-2 space-y-2 rounded-lg border border-slate-200 bg-slate-50 p-3 text-[11px] text-slate-600">
                                <summary class="cursor-pointer text-xs font-semibold text-slate-500">Template snapshot
                                </summary>
                                <pre class="max-h-48 overflow-auto rounded bg-white/70 p-3"
                                    x-text="formatJson(billing.snapshot)"></pre>
                            </details>
                        </template>
                    </div>
                </div>
            </div>

            <div x-show="detailTab === 'diagnostics'" x-cloak x-transition.opacity class="space-y-4"
                id="call-record-tab-diagnostics" role="tabpanel" tabindex="0">
                <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-black/5">
                    <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
                        <div>
                            <h2 class="text-base font-semibold text-slate-900">Interaction insights</h2>
                            <p class="text-xs text-slate-500">Switch between speech analytics and SIP signalling for
                                faster troubleshooting.</p>
                        </div>
                        <div class="rounded-xl bg-white p-3 shadow-sm ring-1 ring-black/5">
                            <nav class="inline-flex w-full flex-wrap gap-2 rounded-lg border border-slate-200 bg-slate-50 p-1 text-xs font-semibold text-slate-600"
                                role="tablist" aria-label="Diagnostics insight tabs">
                                <button type="button"
                                    class="flex-1 rounded-md px-3 py-2 transition text-left sm:flex-none"
                                    :class="insightTab === 'transcription' ? 'bg-white text-sky-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'"
                                    :aria-selected="insightTab === 'transcription'"
                                    aria-controls="call-record-diagnostics-transcription"
                                    @click="insightTab = 'transcription'">
                                    ASR transcription
                                </button>
                                <button type="button"
                                    class="flex-1 rounded-md px-3 py-2 transition text-left sm:flex-none"
                                    :class="insightTab === 'sip-flow' ? 'bg-white text-sky-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'"
                                    :aria-selected="insightTab === 'sip-flow'"
                                    aria-controls="call-record-diagnostics-sip" @click="insightTab = 'sip-flow'">
                                    SIP message flow
                                </button>
                            </nav>
                        </div>
                    </div>

                    <div x-show="insightTab === 'transcription'" x-cloak x-transition.opacity class="space-y-4"
                        id="call-record-diagnostics-transcription" role="tabpanel" tabindex="0">
                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                            <p class="text-xs text-slate-500">Generate speech-to-text to accelerate QA and analytics.
                            </p>
                            <button type="button"
                                class="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60"
                                :disabled="asrProcessing || transcriptLoading"
                                @click="requestTranscript(transcriptVisible && transcriptStatus !== 'processing')">
                                <svg x-cloak x-show="!(asrProcessing || transcriptLoading)" class="h-4 w-4"
                                    viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 4v12m6-6H4" />
                                </svg>
                                <svg x-cloak x-show="asrProcessing || transcriptLoading" class="h-4 w-4 animate-spin"
                                    viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle class="opacity-25" cx="10" cy="10" r="7" stroke-width="1.5"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M10 3a7 7 0 0 1 7 7h-1.8a5.2 5.2 0 0 0-5.2-5.2V3Z" />
                                </svg>
                                <span x-text="transcriptButtonLabel()"></span>
                            </button>
                        </div>

                        <template x-if="transcriptError">
                            <div class="rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-600"
                                x-text="transcriptError"></div>
                        </template>

                        <template x-if="transcriptVisible">
                            <div class="space-y-3 text-sm text-slate-600">
                                <div class="flex flex-wrap items-center gap-2 text-xs text-slate-400">
                                    <span>Language</span>
                                    <span class="rounded-full bg-slate-100 px-2 py-0.5 font-semibold text-slate-600"
                                        x-text="transcript.language || '—'"></span>
                                    <span x-show="transcript.generated_at"
                                        x-text="'Generated ' + formatDateTime(transcript.generated_at)"></span>
                                </div>
                                <div class="space-y-2">
                                    <template x-for="segment in (transcript.segments || [])"
                                        :key="segment.start + segment.speaker">
                                        <div class="rounded-lg border border-slate-200 p-3 text-xs">
                                            <div class="flex items-center justify-between text-slate-400">
                                                <span class="font-semibold text-slate-600"
                                                    x-text="segment.speaker"></span>
                                                <span x-text="segment.start"></span>
                                            </div>
                                            <p class="mt-1 text-slate-700" x-text="segment.text"></p>
                                        </div>
                                    </template>
                                    <template x-if="!(transcript.segments || []).length">
                                        <div
                                            class="rounded-lg border border-dashed border-slate-200 p-4 text-center text-xs text-slate-400">
                                            Transcript generated without segment breakdown.
                                        </div>
                                    </template>
                                </div>
                                <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700"
                                    x-text="transcript.text || 'Transcript ready.'"></div>
                            </div>
                        </template>
                        <template x-if="!transcriptVisible && !asrProcessing && !transcriptLoading">
                            <div
                                class="rounded-lg border border-dashed border-slate-200 px-4 py-6 text-center text-xs text-slate-400">
                                No transcript generated yet.
                            </div>
                        </template>
                        <template x-if="transcriptLoading">
                            <div
                                class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-500">
                                Loading transcript…
                            </div>
                        </template>
                        <template x-if="asrProcessing">
                            <div
                                class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-500">
                                Submitting recording to VoiceAPI…
                            </div>
                        </template>
                    </div>

                    <div x-show="insightTab === 'sip-flow'" x-cloak x-transition.opacity
                        id="call-record-diagnostics-sip" role="tabpanel" tabindex="0">
                        <p class="text-xs text-slate-500">Compare caller, PBX, and callee lanes. Click a row to inspect
                            the raw SIP payload.</p>
                        <div class="mt-4 flex flex-col gap-4 lg:flex-row">
                            <div class="lg:w-7/12 lg:min-w-0 space-y-3">
                                <div class="rounded-xl bg-white shadow-sm ring-1 ring-black/5">
                                    <div class="max-h-[520px] overflow-y-auto">
                                        <div class="mt-2 flex items-center gap-2 text-2xl font-semibold"
                                            :class="transcriptStatusTone(transcriptStatus)">
                                            <svg x-cloak
                                                x-show="transcriptStatusIcon(transcriptStatus, record.has_transcript, transcriptVisible) === 'ready'"
                                                class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                stroke-width="1.8">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M5 12l5 5L20 7" />
                                            </svg>
                                            <svg x-cloak
                                                x-show="transcriptStatusIcon(transcriptStatus, record.has_transcript, transcriptVisible) === 'processing'"
                                                class="h-6 w-6 animate-spin" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="1.6">
                                                <circle class="opacity-25" cx="12" cy="12" r="9" stroke-width="1.6">
                                                </circle>
                                                <path class="opacity-75" fill="currentColor"
                                                    d="M12 3a9 9 0 0 1 9 9h-2.2a6.8 6.8 0 0 0-6.8-6.8V3Z" />
                                            </svg>
                                            <svg x-cloak
                                                x-show="transcriptStatusIcon(transcriptStatus, record.has_transcript, transcriptVisible) === 'failed'"
                                                class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                stroke-width="1.8">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M7 7l10 10M7 17L17 7" />
                                            </svg>
                                            <svg x-cloak
                                                x-show="transcriptStatusIcon(transcriptStatus, record.has_transcript, transcriptVisible) === 'pending'"
                                                class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                stroke-width="1.8">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M12 5v14m7-7H5" />
                                            </svg>
                                            <span x-text="transcriptStatusLabel(transcriptStatus)"></span>
                                        </div>
                                        <p class="mt-1 text-xs text-slate-500" x-text="transcriptStatusDescription()">
                                        </p>
                                        </thead>
                                        <tbody class="bg-white">
                                            <template x-if="sipFlowEntries.length">
                                                <template x-for="entry in sipFlowEntries"
                                                    :key="'sip-' + entry.sequence">
                                                    <tr class="cursor-pointer transition" :class="selectedSipEntry && selectedSipEntry.sequence === entry.sequence
                                                                ? 'bg-sky-50 ring-1 ring-inset ring-sky-300'
                                                                : 'hover:bg-slate-50'" @click="selectSipEntry(entry)">
                                                        <template x-for="column in sipFlowColumns"
                                                            :key="column.id + '-' + entry.sequence">
                                                            <td
                                                                class="align-top px-3 py-3 whitespace-normal break-words">
                                                                <template x-if="column.id === 'time'">
                                                                    <div class="space-y-1 text-xs text-slate-600">
                                                                        <div class="font-mono text-[12px] font-semibold text-slate-700"
                                                                            x-text="formatRelativeToStart(entry)">
                                                                        </div>
                                                                        <div class="text-[10px] font-mono text-slate-400"
                                                                            x-text="entry.offset || ''"></div>
                                                                        <div class="text-[10px] uppercase tracking-wide text-slate-400"
                                                                            x-text="(entry.flow_direction || entry.direction || '') ? (entry.flow_direction || entry.direction || '').toUpperCase() : ''">
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                                <template x-if="column.id !== 'time'">
                                                                    <div class="space-y-1 text-[11px] text-slate-600">
                                                                        <template
                                                                            x-if="column.id === 'pbx' && isB2bua(entry)">
                                                                            <div
                                                                                class="mb-1 inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold text-amber-700">
                                                                                <span
                                                                                    x-text="entry.leg_role_label || 'B2BUA leg'"></span>
                                                                                <span x-show="entry.leg_label"
                                                                                    class="font-mono"
                                                                                    x-text="entry.leg_label"></span>
                                                                            </div>
                                                                        </template>
                                                                        <template
                                                                            x-if="column.id === (entry.lane_display || entry.lane_from)">
                                                                            <div class="flex items-start gap-2"
                                                                                :class="laneCell(entry, column.id) === 'to' ? 'justify-end text-right' : 'text-left'">
                                                                                <template
                                                                                    x-if="laneCell(entry, column.id) === 'from' && arrowPlacement(entry, column.id, 'from') === 'left'">
                                                                                    <span
                                                                                        class="text-base leading-none text-slate-400"
                                                                                        x-text="cellArrow(entry, column.id)"></span>
                                                                                </template>
                                                                                <template
                                                                                    x-if="laneCell(entry, column.id) === 'to' && arrowPlacement(entry, column.id, 'to') === 'left'">
                                                                                    <span
                                                                                        class="text-base leading-none text-slate-400"
                                                                                        x-text="cellArrow(entry, column.id)"></span>
                                                                                </template>
                                                                                <div class="space-y-1"
                                                                                    :class="laneCell(entry, column.id) === 'to' ? 'text-right' : 'text-left'">
                                                                                    <span
                                                                                        class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 font-mono text-[11px] font-semibold"
                                                                                        :class="laneCell(entry, column.id) === 'to' ? 'bg-slate-100 text-slate-600' : 'bg-slate-200 text-slate-700'">
                                                                                        <span
                                                                                            x-text="entry.method || entry.status_code || '—'"></span>
                                                                                        <span
                                                                                            x-show="entry.status_code && entry.method && entry.method !== String(entry.status_code)"
                                                                                            class="text-emerald-600"
                                                                                            x-text="entry.status_code"></span>
                                                                                    </span>
                                                                                    <div class="leading-snug break-words"
                                                                                        x-text="formatSummary(entry.summary)">
                                                                                    </div>
                                                                                </div>
                                                                                <template
                                                                                    x-if="laneCell(entry, column.id) === 'from' && arrowPlacement(entry, column.id, 'from') === 'right'">
                                                                                    <span
                                                                                        class="text-base leading-none text-slate-400"
                                                                                        x-text="cellArrow(entry, column.id)"></span>
                                                                                </template>
                                                                                <template
                                                                                    x-if="laneCell(entry, column.id) === 'to' && arrowPlacement(entry, column.id, 'to') === 'right'">
                                                                                    <span
                                                                                        class="text-base leading-none text-slate-400"
                                                                                        x-text="cellArrow(entry, column.id)"></span>
                                                                                </template>
                                                                            </div>
                                                                        </template>
                                                                        <template
                                                                            x-if="column.id !== (entry.lane_display || entry.lane_from) && laneCell(entry, column.id) === 'from'">
                                                                            <div
                                                                                class="flex items-center justify-center text-base leading-none text-slate-300">
                                                                                <span
                                                                                    x-text="cellArrow(entry, column.id)"></span>
                                                                            </div>
                                                                        </template>
                                                                        <template
                                                                            x-if="column.id !== (entry.lane_display || entry.lane_from) && laneCell(entry, column.id) === 'to'">
                                                                            <div
                                                                                class="flex items-center justify-center text-base leading-none text-slate-300">
                                                                                <span
                                                                                    x-text="cellArrow(entry, column.id)"></span>
                                                                            </div>
                                                                        </template>
                                                                        <template
                                                                            x-if="laneCell(entry, column.id) === 'self'">
                                                                            <div
                                                                                class="mx-auto h-1.5 w-1.5 rounded-full bg-slate-400">
                                                                            </div>
                                                                        </template>
                                                                    </div>
                                                                </template>
                                                            </td>
                                                        </template>
                                                    </tr>
                                                </template>
                                            </template>
                                            <template x-if="!sipFlowEntries.length">
                                                <tr>
                                                    <td class="px-4 py-6 text-center text-xs text-slate-400"
                                                        :colspan="sipFlowColumns.length">
                                                        No SIP trace captured for this session.
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="h-full rounded-xl bg-white p-4 shadow-sm ring-1 ring-black/5">
                                    <template x-if="selectedSipEntry">
                                        <div class="flex h-full flex-col">
                                            <div
                                                class="flex flex-col gap-2 border-b border-slate-200 pb-3 text-sm text-slate-600">
                                                <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
                                                    <span
                                                        class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-700">
                                                        <span
                                                            x-text="selectedSipEntry.method || selectedSipEntry.status_code || 'Message'"></span>
                                                        <span
                                                            x-show="selectedSipEntry.status_code && selectedSipEntry.method && selectedSipEntry.method !== String(selectedSipEntry.status_code)"
                                                            class="text-emerald-600"
                                                            x-text="selectedSipEntry.status_code"></span>
                                                    </span>
                                                    <span class="font-mono text-[13px] text-slate-700"
                                                        x-text="formatDateTimeWithMs(selectedSipEntry.timestamp)"></span>
                                                    <span class="font-mono text-[11px] text-slate-400"
                                                        x-text="formatRelativeToStart(selectedSipEntry)"></span>
                                                </div>
                                                <div
                                                    class="flex flex-wrap items-center gap-2 text-[11px] text-slate-500">
                                                    <span x-text="selectedSipEntry.from_label"></span>
                                                    <span class="text-base leading-none text-slate-300"
                                                        x-text="selectedSipEntry.arrow === 'right' ? '→' : '←'"></span>
                                                    <span x-text="selectedSipEntry.to_label"></span>
                                                    <span x-show="selectedSipEntry.leg_role_label"
                                                        class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 font-semibold text-slate-600"
                                                        x-text="selectedSipEntry.leg_role_label"></span>
                                                    <span x-show="selectedSipEntry.leg_label"
                                                        class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-2 py-0.5 font-mono text-[10px] text-slate-500"
                                                        x-text="selectedSipEntry.leg_label"></span>
                                                </div>
                                                <div class="text-sm font-semibold text-slate-700"
                                                    x-text="selectedSipEntry.summary"></div>
                                            </div>
                                            <div class="mt-3 flex-1 overflow-auto">
                                                <pre
                                                    class="h-96 max-w-full overflow-auto whitespace-pre rounded bg-slate-950/90 p-3 text-[11px] leading-relaxed text-emerald-100"><code x-text="selectedSipEntry.raw || 'No raw payload captured.'"></code></pre>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-if="!selectedSipEntry">
                                        <div class="flex h-full items-center justify-center text-xs text-slate-400">
                                            Select a SIP message to inspect its raw payload.
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('callRecordDetail', (payload) => ({
            init() {
                const data = typeof payload === 'string' ? JSON.parse(payload || '{}') : (payload || {});
                this.record = data.record || {};
                const recordRewrite = (this.record && this.record.rewrite && typeof this.record.rewrite === 'object')
                    ? this.record.rewrite
                    : null;
                const topLevelRewrite = (data.rewrite && typeof data.rewrite === 'object') ? data.rewrite : null;
                this.rewrite = recordRewrite || topLevelRewrite || {};
                const sipFlowPayload = (data.sip_flow && typeof data.sip_flow === 'object' && !Array.isArray(data.sip_flow))
                    ? data.sip_flow
                    : { entries: Array.isArray(data.sip_flow) ? data.sip_flow : [] };
                const sipFlowEntriesRaw = Array.isArray(sipFlowPayload.entries) ? sipFlowPayload.entries : [];
                this.sipFlowEntries = sipFlowEntriesRaw.map((entry, index) => {
                    const clone = Object.assign({}, entry || {});
                    if (clone.sequence === undefined || clone.sequence === null) {
                        clone.sequence = index;
                    }
                    return clone;
                });
                const payloadColumnLabels = {};
                if (Array.isArray(sipFlowPayload.columns)) {
                    sipFlowPayload.columns.forEach((column) => {
                        if (!column || typeof column !== 'object') {
                            return;
                        }
                        const normalized = this.normalizeLaneId(column.id || column.label);
                        if (normalized && ['time', 'caller', 'pbx', 'callee'].includes(normalized)) {
                            payloadColumnLabels[normalized] = column.label || column.id || payloadColumnLabels[normalized];
                        }
                    });
                }
                this.sipFlowColumns = [
                    { id: 'time', label: payloadColumnLabels.time || 'Time' },
                    { id: 'caller', label: payloadColumnLabels.caller || 'Caller' },
                    { id: 'pbx', label: payloadColumnLabels.pbx || 'PBX' },
                    { id: 'callee', label: payloadColumnLabels.callee || 'Callee' },
                ];
                this.selectedSipEntry = this.sipFlowEntries.length ? this.sipFlowEntries[0] : null;
                const recordStartTs = this.parseTimestamp(this.record.started_at);
                const firstEntryTs = this.sipFlowEntries.length ? this.parseTimestamp(this.sipFlowEntries[0].timestamp) : null;
                this.flowStartEpoch = Number.isFinite(recordStartTs) ? recordStartTs : firstEntryTs;
                this.mediaMetrics = data.media_metrics || {};
                const initialTranscript = (data.transcript && typeof data.transcript === 'object')
                    ? data.transcript
                    : { available: false, segments: [] };
                this.transcriptPreview = data.transcript_preview || null;
                this.actions = data.actions || {};
                this.backUrl = data.back_url || '/console/call-records';
                this.transcriptUrl = this.determineTranscriptUrl(
                    this.actions ? this.actions.transcript_url : '',
                    this.record.id,
                );
                this.applyTranscriptPayload({
                    status: initialTranscript?.status || this.record.transcript_status,
                    transcript: initialTranscript,
                });
                this.notes = data.notes || { text: '', updated_at: null };
                this.noteDraft = this.notes.text || '';
                this.participants = Array.isArray(data.participants) ? data.participants : [];
                this.billing = data.billing || {
                    summary: (this.record && this.record.billing) || {},
                    snapshot: null,
                    result: null,
                };
                if (!this.record.billing && this.billing && this.billing.summary) {
                    this.record.billing = this.billing.summary;
                }
                this.durationHint = this.record.ended_at ? `Ended ${this.formatDateTime(this.record.ended_at)}` : 'No hangup timestamp recorded';
                this.detailTab = 'overview';
                this.insightTab = (this.transcriptVisible || (this.transcript && this.transcript.available))
                    ? 'transcription'
                    : (this.sipFlowEntries.length ? 'sip-flow' : 'transcription');
                if (this.record.has_transcript && !this.transcriptVisible && this.transcriptUrl) {
                    this.fetchTranscript();
                }
                this.$watch('insightTab', (value) => {
                    if (
                        value === 'transcription'
                        && this.record.has_transcript
                        && !this.transcriptVisible
                        && !this.transcriptLoading
                        && !this.asrProcessing
                        && this.transcriptUrl
                    ) {
                        this.fetchTranscript();
                    }
                });
            },
            record: {},
            sipFlowEntries: [],
            sipFlowColumns: [],
            selectedSipEntry: null,
            flowStartEpoch: null,
            mediaMetrics: {},
            transcript: {},
            transcriptPreview: null,
            transcriptVisible: false,
            transcriptStatus: 'pending',
            transcriptError: null,
            transcriptLoading: false,
            transcriptUrl: '',
            notes: {},
            noteDraft: '',
            participants: [],
            rewrite: {},
            actions: {},
            backUrl: '/console/call-records',
            billing: {},
            tagInput: '',
            asrProcessing: false,
            durationHint: '',
            detailTab: 'overview',
            insightTab: 'transcription',
            copiedCallId: null,
            copyTimer: null,
            addTag() {
                const value = (this.tagInput || '').trim();
                if (!value) {
                    return;
                }
                const tags = Array.isArray(this.record.tags) ? this.record.tags : [];
                if (!tags.includes(value)) {
                    tags.push(value);
                    this.record.tags = tags;
                }
                this.tagInput = '';
            },
            removeTag(index) {
                const tags = Array.isArray(this.record.tags) ? [...this.record.tags] : [];
                if (index >= 0 && index < tags.length) {
                    tags.splice(index, 1);
                    this.record.tags = tags;
                }
            },
            saveNotes() {
                this.notes = this.notes || {};
                this.notes.text = this.noteDraft || '';
                this.notes.updated_at = new Date().toISOString();
            },
            async requestTranscript(force = false) {
                if (!this.transcriptUrl) {
                    this.transcriptError = 'Transcript endpoint unavailable.';
                    return;
                }
                if (this.asrProcessing || this.transcriptLoading) {
                    return;
                }
                if (!force && this.record?.has_transcript && !this.transcriptVisible) {
                    await this.fetchTranscript();
                    return;
                }
                if (!force && this.transcriptStatus === 'processing') {
                    await this.fetchTranscript();
                    return;
                }
                this.asrProcessing = true;
                this.transcriptError = null;
                this.transcriptStatus = 'processing';
                if (this.record) {
                    this.record.transcript_status = 'processing';
                }
                const payload = {};
                if (force) {
                    payload.force = true;
                }
                const preferredLanguage = this.record?.transcript_language || this.transcript?.language;
                if (preferredLanguage) {
                    payload.language = preferredLanguage;
                }
                try {
                    const response = await fetch(this.transcriptUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) {
                        this.transcriptError = await this.extractErrorMessage(response);
                        if (response.status === 409) {
                            await this.fetchTranscript();
                        }
                        return;
                    }
                    const data = await response.json();
                    this.applyTranscriptPayload(data);
                    if (data && data.transcript) {
                        this.transcriptPreview = data.transcript;
                    }
                } catch (err) {
                    console.error('Failed to request transcript', err);
                    this.transcriptError = 'Failed to request transcription';
                } finally {
                    this.asrProcessing = false;
                }
            },
            async fetchTranscript() {
                if (!this.transcriptUrl) {
                    this.transcriptError = 'Transcript endpoint unavailable.';
                    return;
                }
                if (this.transcriptLoading || this.asrProcessing) {
                    return;
                }
                this.transcriptLoading = true;
                this.transcriptError = null;
                try {
                    const response = await fetch(this.transcriptUrl, {
                        headers: { 'Accept': 'application/json' },
                    });
                    if (response.status === 404) {
                        this.applyTranscriptPayload({ status: 'pending', transcript: { available: false } });
                        return;
                    }
                    if (!response.ok) {
                        this.transcriptError = await this.extractErrorMessage(response);
                        return;
                    }
                    const data = await response.json();
                    this.applyTranscriptPayload(data);
                } catch (err) {
                    console.error('Failed to load transcript', err);
                    this.transcriptError = 'Failed to load transcript';
                } finally {
                    this.transcriptLoading = false;
                }
            },
            applyTranscriptPayload(payload = {}) {
                const transcript = (payload.transcript && typeof payload.transcript === 'object')
                    ? payload.transcript
                    : { available: false, segments: [] };
                const normalizedRaw = (payload.status || transcript.status || this.record?.transcript_status || 'pending')
                    .toString()
                    .toLowerCase();
                const normalized = normalizedRaw || 'pending';
                this.transcript = transcript;
                this.transcriptVisible = Boolean(transcript.available);
                this.transcriptStatus = normalized;
                if (this.record) {
                    this.record.transcript_status = normalized;
                    if (typeof transcript.available === 'boolean') {
                        this.record.has_transcript = transcript.available;
                    }
                    if (transcript.language) {
                        this.record.transcript_language = transcript.language;
                    }
                }
            },
            async extractErrorMessage(response) {
                let fallback = `Request failed (${response.status})`;
                const type = response.headers.get('content-type') || '';
                if (type.includes('application/json')) {
                    try {
                        const data = await response.json();
                        if (data && typeof data === 'object' && data.message) {
                            return data.message;
                        }
                        if (data && typeof data === 'string') {
                            return data;
                        }
                    } catch (err) {
                        return fallback;
                    }
                    return fallback;
                }
                try {
                    const text = await response.text();
                    if (text) {
                        return text;
                    }
                } catch (err) {
                    return fallback;
                }
                return fallback;
            },
            determineTranscriptUrl(hint, recordId) {
                const hinted = this.normalizeConsoleUrl(hint);
                if (hinted) {
                    return hinted;
                }
                if (!recordId) {
                    return '';
                }
                const base = this.normalizeConsoleUrl(this.backUrl || '/console/call-records');
                const trimmed = base.endsWith('/') ? base.slice(0, -1) : base;
                return this.normalizeConsoleUrl(`${trimmed}/${recordId}/transcript`);
            },
            normalizeConsoleUrl(value) {
                const candidate = (value || '').toString().trim();
                if (!candidate) {
                    return '';
                }
                if (candidate.startsWith('http://') || candidate.startsWith('https://')) {
                    try {
                        const parsed = new URL(candidate, window.location.origin);
                        return parsed.pathname + parsed.search;
                    } catch (err) {
                        return candidate;
                    }
                }
                return candidate.startsWith('/') ? candidate : `/${candidate}`;
            },
            selectSipEntry(entry) {
                if (!entry) {
                    this.selectedSipEntry = null;
                    return;
                }
                if (this.selectedSipEntry && this.selectedSipEntry.sequence === entry.sequence) {
                    this.selectedSipEntry = null;
                } else {
                    this.selectedSipEntry = entry;
                }
            },
            laneCell(entry, columnId) {
                if (!entry || !columnId) {
                    return 'none';
                }
                const target = this.normalizeLaneId(columnId);
                if (!target) {
                    return 'none';
                }
                const laneFrom = this.normalizeLaneId(entry.lane_from);
                const laneTo = this.normalizeLaneId(entry.lane_to);
                if (laneFrom === target && laneTo === target) {
                    return 'self';
                }
                if (laneFrom === target) {
                    return 'from';
                }
                if (laneTo === target) {
                    return 'to';
                }
                return 'none';
            },
            lanePosition(laneId) {
                switch (this.normalizeLaneId(laneId)) {
                    case 'caller':
                        return 0;
                    case 'pbx':
                        return 1;
                    case 'callee':
                        return 2;
                    default:
                        return 1;
                }
            },
            cellArrow(entry, columnId) {
                if (!entry || !columnId) {
                    return '';
                }
                const cellType = this.laneCell(entry, columnId);
                if (cellType !== 'from' && cellType !== 'to') {
                    return '';
                }
                const fromLane = this.normalizeLaneId(entry.lane_from);
                const toLane = this.normalizeLaneId(entry.lane_to);
                if (!fromLane || !toLane || fromLane === toLane) {
                    return '';
                }
                return this.lanePosition(toLane) > this.lanePosition(fromLane) ? '→' : '←';
            },
            arrowPlacement(entry, columnId, cellType) {
                const arrow = this.cellArrow(entry, columnId);
                if (!arrow) {
                    return 'none';
                }
                if (cellType === 'from') {
                    return arrow === '→' ? 'right' : 'left';
                }
                if (cellType === 'to') {
                    return arrow === '→' ? 'left' : 'right';
                }
                return 'none';
            },
            normalizeLaneId(value) {
                const normalized = (value || '').toString().trim().toLowerCase();
                if (!normalized) {
                    return '';
                }
                switch (normalized) {
                    case 'pbx':
                    case 'proxy':
                    case 'server':
                    case 'sip_server':
                    case 'b2bua':
                        return 'pbx';
                    case 'caller':
                    case 'source':
                    case 'src':
                        return 'caller';
                    case 'callee':
                    case 'destination':
                    case 'dst':
                        return 'callee';
                    case 'time':
                    case 'timestamp':
                        return 'time';
                    default:
                        return normalized;
                }
            },
            parseTimestamp(value) {
                if (!value) {
                    return NaN;
                }
                const date = new Date(value);
                if (!Number.isNaN(date.getTime())) {
                    return date.getTime();
                }
                const parsed = Date.parse(value);
                return Number.isNaN(parsed) ? NaN : parsed;
            },
            formatRelativeToStart(entry) {
                if (!entry) {
                    return '—';
                }
                const timestamp = this.parseTimestamp(entry.timestamp);
                if (!Number.isFinite(timestamp)) {
                    return entry.offset || '—';
                }
                if (!Number.isFinite(this.flowStartEpoch)) {
                    return entry.offset || '—';
                }
                return this.formatDiffWithMs(timestamp - this.flowStartEpoch);
            },
            formatDiffWithMs(diffMs) {
                if (!Number.isFinite(diffMs)) {
                    return '—';
                }
                const sign = diffMs < 0 ? '-' : '+';
                const abs = Math.abs(diffMs);
                const totalSeconds = Math.floor(abs / 1000);
                const milliseconds = abs % 1000;
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                const pad = (num, len = 2) => String(num).padStart(len, '0');
                const base = hours > 0
                    ? `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`
                    : `${pad(minutes)}:${pad(seconds)}`;
                return `${sign}${base}.${pad(milliseconds, 3)}`;
            },
            formatDateTimeWithMs(value) {
                const timestamp = this.parseTimestamp(value);
                if (!Number.isFinite(timestamp)) {
                    return value || '—';
                }
                const date = new Date(timestamp);
                const pad = (num, len = 2) => String(num).padStart(len, '0');
                const year = date.getFullYear();
                const month = pad(date.getMonth() + 1);
                const day = pad(date.getDate());
                const hours = pad(date.getHours());
                const minutes = pad(date.getMinutes());
                const seconds = pad(date.getSeconds());
                const milliseconds = pad(date.getMilliseconds(), 3);
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
            },
            formatSummary(value) {
                const original = (value || '').toString().trim();
                if (!original) {
                    return '—';
                }
                const compact = original
                    .replace(/sips?:[^\s>]+/gi, '')
                    .replace(/<[^>]*>/g, '')
                    .replace(/"[^"\\]*"/g, '')
                    .replace(/\bSIP\/2\.0\b/gi, '')
                    .replace(/\bOK\b/gi, '')
                    .replace(/\s{2,}/g, ' ')
                    .trim();
                if (!compact) {
                    const firstToken = original.split(/\s+/)[0];
                    return firstToken || '—';
                }
                return compact.length > 60 ? `${compact.slice(0, 57)}…` : compact;
            },
            isB2bua(entry) {
                if (!entry || !entry.leg_role) {
                    return false;
                }
                return entry.leg_role.toLowerCase() === 'b2bua';
            },
            async copyCallId(callId) {
                if (!callId) {
                    return;
                }
                const text = String(callId);
                let ok = await this.tryClipboardWrite(text);
                if (!ok) {
                    ok = this.copyCallIdFallback(text);
                }
                if (ok) {
                    this.showCopyConfirmation(text);
                }
            },
            async tryClipboardWrite(text) {
                if (typeof navigator === 'undefined' || !navigator.clipboard || !navigator.clipboard.writeText) {
                    return false;
                }
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (err) {
                    console.error('Clipboard API failed', err);
                    return false;
                }
            },
            copyCallIdFallback(text) {
                try {
                    const temp = document.createElement('textarea');
                    temp.value = text;
                    temp.setAttribute('readonly', '');
                    temp.style.position = 'fixed';
                    temp.style.opacity = '0';
                    document.body.appendChild(temp);
                    temp.select();
                    temp.setSelectionRange(0, temp.value.length);
                    const success = document.execCommand('copy');
                    document.body.removeChild(temp);
                    return success;
                } catch (err) {
                    console.error('Copy fallback failed', err);
                    return false;
                }
            },
            showCopyConfirmation(value) {
                this.copiedCallId = value;
                if (this.copyTimer) {
                    clearTimeout(this.copyTimer);
                }
                this.copyTimer = setTimeout(() => {
                    this.copiedCallId = null;
                    this.copyTimer = null;
                }, 1500);
            },
            statusLabel(value) {
                switch ((value || '').toLowerCase()) {
                    case 'completed':
                        return 'Completed';
                    case 'missed':
                        return 'Missed';
                    case 'failed':
                        return 'Failed';
                    default:
                        return value || 'Unknown';
                }
            },
            directionLabel(value) {
                switch ((value || '').toLowerCase()) {
                    case 'inbound':
                        return 'Inbound';
                    case 'outbound':
                        return 'Outbound';
                    case 'internal':
                        return 'Internal';
                    default:
                        return value || 'Unknown';
                }
            },
            billingStatusLabel(value) {
                switch ((value || '').toLowerCase()) {
                    case 'charged':
                        return 'Charged';
                    case 'included':
                        return 'Included';
                    case 'zero-duration':
                        return 'Zero duration';
                    case 'unrated':
                        return 'Unrated';
                    default:
                        return value || 'Unknown';
                }
            },
            statusClasses(status) {
                switch ((status || '').toLowerCase()) {
                    case 'completed':
                        return 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200';
                    case 'missed':
                        return 'bg-amber-50 text-amber-600 ring-1 ring-amber-200';
                    case 'failed':
                        return 'bg-rose-50 text-rose-600 ring-1 ring-rose-200';
                    default:
                        return 'bg-slate-100 text-slate-600 ring-1 ring-slate-200';
                }
            },
            billingStatusClasses(status) {
                switch ((status || '').toLowerCase()) {
                    case 'charged':
                        return 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200';
                    case 'included':
                        return 'bg-sky-50 text-sky-600 ring-1 ring-sky-200';
                    case 'zero-duration':
                        return 'bg-slate-100 text-slate-600 ring-1 ring-slate-200';
                    case 'unrated':
                        return 'bg-amber-50 text-amber-600 ring-1 ring-amber-200';
                    default:
                        return 'bg-slate-100 text-slate-600 ring-1 ring-slate-200';
                }
            },
            statusDot(status) {
                switch ((status || '').toLowerCase()) {
                    case 'completed':
                        return 'bg-emerald-500';
                    case 'missed':
                        return 'bg-amber-500';
                    case 'failed':
                        return 'bg-rose-500';
                    default:
                        return 'bg-slate-400';
                }
            },
            directionClasses(direction) {
                switch ((direction || '').toLowerCase()) {
                    case 'inbound':
                        return 'border border-sky-100 bg-sky-50 text-sky-700';
                    case 'outbound':
                        return 'border border-emerald-100 bg-emerald-50 text-emerald-700';
                    case 'internal':
                        return 'border border-slate-200 bg-slate-50 text-slate-700';
                    default:
                        return 'border border-slate-200 bg-slate-50 text-slate-700';
                }
            },
            formatCurrency(amount, currency) {
                if (amount === null || amount === undefined) {
                    return '—';
                }
                const numeric = Number(amount);
                if (!Number.isFinite(numeric)) {
                    return '—';
                }
                const symbol = (currency || 'USD').toString().trim().toUpperCase() || 'USD';
                return `${symbol} ${numeric.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                })}`;
            },
            formatBillingAmount(billing) {
                if (!billing || typeof billing !== 'object') {
                    return '—';
                }
                const status = (billing.status || '').toLowerCase();
                const amount = billing.amount || {};
                const total = amount.total ?? amount.subtotal ?? null;
                if (total !== null && total !== undefined) {
                    return this.formatCurrency(total, billing.currency || (this.billing?.summary?.currency) || 'USD');
                }
                if (status === 'included') {
                    return 'Included';
                }
                if (status === 'zero-duration') {
                    return '0.00';
                }
                if (status === 'unrated') {
                    return 'Unrated';
                }
                return '—';
            },
            formatBillingMinutes(billing) {
                if (!billing || typeof billing !== 'object') {
                    return '—';
                }
                const minutes = billing.billable_minutes !== undefined
                    ? Number(billing.billable_minutes)
                    : (typeof billing.billable_secs === 'number'
                        ? Number(billing.billable_secs) / 60.0
                        : NaN);
                if (!Number.isFinite(minutes) || minutes <= 0) {
                    return '—';
                }
                return `${minutes.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                })} min`;
            },
            qualityTone(value) {
                const mos = Number(value || 0);
                if (mos >= 4.3) {
                    return 'text-emerald-600';
                }
                if (mos >= 3.8) {
                    return 'text-amber-600';
                }
                if (mos > 0) {
                    return 'text-rose-600';
                }
                return 'text-slate-400';
            },
            transcriptStatusTone(status) {
                switch ((status || '').toLowerCase()) {
                    case 'completed':
                        return 'text-emerald-600';
                    case 'processing':
                        return 'text-amber-500';
                    case 'failed':
                        return 'text-rose-500';
                    default:
                        return 'text-slate-400';
                }
            },
            transcriptStatusLabel(status) {
                switch ((status || '').toLowerCase()) {
                    case 'completed':
                        return 'Ready';
                    case 'processing':
                        return 'Processing';
                    case 'failed':
                        return 'Failed';
                    default:
                        return 'Pending';
                }
            },
            transcriptStatusDescription() {
                const status = (this.transcriptStatus || '').toLowerCase();
                if (status === 'completed') {
                    if (this.transcript && this.transcript.generated_at) {
                        return `Generated ${this.formatDateTime(this.transcript.generated_at)}`;
                    }
                    return 'Transcript ready.';
                }
                if (status === 'processing') {
                    return 'Transcription in progress. Refresh to check status.';
                }
                if (status === 'failed') {
                    return 'Previous transcription failed. Retry to run again.';
                }
                return 'Request on demand to analyse conversation outcome.';
            },
            transcriptStatusIcon(status, hasTranscript = false, visible = false) {
                const value = (status || '').toLowerCase();
                if (value === 'completed' || hasTranscript || visible) {
                    return 'ready';
                }
                if (value === 'processing') {
                    return 'processing';
                }
                if (value === 'failed') {
                    return 'failed';
                }
                return 'pending';
            },
            transcriptButtonLabel() {
                if (this.asrProcessing) {
                    return 'Submitting…';
                }
                if (this.transcriptLoading) {
                    return 'Loading…';
                }
                const status = (this.transcriptStatus || '').toLowerCase();
                if (status === 'processing') {
                    return 'Refresh status';
                }
                if (status === 'failed') {
                    return 'Retry transcript';
                }
                if (this.transcriptVisible) {
                    return 'Re-run transcript';
                }
                if (this.record && this.record.has_transcript) {
                    return 'Load transcript';
                }
                return 'Request transcript';
            },
            formatNumber(value) {
                if (value === null || value === undefined || Number.isNaN(Number(value))) {
                    return '—';
                }
                return Number(value).toLocaleString(undefined, { maximumFractionDigits: 2 });
            },
            formatDuration(value) {
                const seconds = Number(value || 0);
                if (!seconds) {
                    return '00:00';
                }
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                const pad = (num) => String(num).padStart(2, '0');
                if (hours > 0) {
                    return `${pad(hours)}:${pad(minutes)}:${pad(secs)}`;
                }
                return `${pad(minutes)}:${pad(secs)}`;
            },
            formatDateTime(value) {
                if (!value) {
                    return '—';
                }
                try {
                    const date = new Date(value);
                    if (Number.isNaN(date.getTime())) {
                        return value;
                    }
                    return date.toLocaleString();
                } catch (err) {
                    return value;
                }
            },
            formatJson(value) {
                if (!value) {
                    return '—';
                }
                try {
                    return JSON.stringify(value, null, 2);
                } catch (err) {
                    return String(value);
                }
            },
        }));
    });
</script>
{% endblock %}